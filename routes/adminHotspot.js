const express = require('express');
const router = express.Router();
const { addHotspotUser, getActiveHotspotUsers, getHotspotProfiles, deleteHotspotUser, generateHotspotVouchers, getHotspotServers, disconnectHotspotUser, getMikrotikConnectionForRouter } = require('../config/mikrotik');
const { getMikrotikConnection } = require('../config/mikrotik');
const fs = require('fs');
const path = require('path');
const { getSettingsWithCache } = require('../config/settingsManager')
const { getVersionInfo, getVersionBadge } = require('../config/version-utils');
const sqlite3 = require('sqlite3').verbose();

// Helper function untuk mengambil setting voucher online
async function getVoucherOnlineSettings() {
    const sqlite3 = require('sqlite3').verbose();
    const db = new sqlite3.Database('./data/billing.db');

    return new Promise((resolve, reject) => {
        // Ensure table exists
        db.run(`
            CREATE TABLE IF NOT EXISTS voucher_online_settings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                package_id TEXT NOT NULL UNIQUE,
                name TEXT NOT NULL DEFAULT '',
                profile TEXT NOT NULL,
                digits INTEGER NOT NULL DEFAULT 5,
                enabled INTEGER NOT NULL DEFAULT 1,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        `, (err) => {
            if (err) {
                console.error('Error creating voucher_online_settings table:', err);
                resolve({});
                return;
            }

            // Insert default settings if table is empty
            db.get('SELECT COUNT(*) as count FROM voucher_online_settings', (err, row) => {
                if (err || row.count === 0) {
                    // Get first available profile from Mikrotik as default
                    const { getHotspotProfiles } = require('../config/mikrotik');
                    getHotspotProfiles().then(profilesResult => {
                        const defaultProfile = (profilesResult.success && profilesResult.data && profilesResult.data.length > 0) 
                            ? profilesResult.data[0].name 
                            : 'default';
                        
                        const defaultSettings = [
                            ['3k', '3rb - 1 Hari', defaultProfile, 5, 1],
                            ['5k', '5rb - 2 Hari', defaultProfile, 5, 1],
                            ['10k', '10rb - 5 Hari', defaultProfile, 5, 1],
                            ['15k', '15rb - 8 Hari', defaultProfile, 5, 1],
                            ['25k', '25rb - 15 Hari', defaultProfile, 5, 1],
                            ['50k', '50rb - 30 Hari', defaultProfile, 5, 1]
                        ];

                        const insertPromises = defaultSettings.map(([packageId, name, profile, digits, enabled]) => {
                            return new Promise((resolveInsert, rejectInsert) => {
                                db.run(
                                    'INSERT OR IGNORE INTO voucher_online_settings (package_id, name, profile, digits, enabled) VALUES (?, ?, ?, ?, ?)',
                                    [packageId, name, profile, digits, enabled],
                                    (err) => {
                                        if (err) rejectInsert(err);
                                        else resolveInsert();
                                    }
                                );
                            });
                        });

                        Promise.all(insertPromises).then(() => {
                            // Now get all settings
                            db.all('SELECT * FROM voucher_online_settings', (err, rows) => {
                                if (err) {
                                    console.error('Error getting voucher online settings:', err);
                                    resolve({});
                                } else {
                                    const settings = {};
                                    rows.forEach(row => {
                                        settings[row.package_id] = {
                                            name: row.name || `${row.package_id} - Paket`,
                                            profile: row.profile,
                                            digits: row.digits || 5,
                                            enabled: row.enabled === 1
                                        };
                                    });
                                    db.close();
                                    resolve(settings);
                                }
                            });
                        }).catch((err) => {
                            console.error('Error inserting default settings:', err);
                            db.close();
                            resolve({});
                        });
                    }).catch((err) => {
                        console.error('Error getting Mikrotik profiles for default settings:', err);
                        // Fallback to hardcoded defaults
                        const fallbackSettings = [
                            ['3k', '3rb - 1 Hari', 'default', 5, 1],
                            ['5k', '5rb - 2 Hari', 'default', 5, 1],
                            ['10k', '10rb - 5 Hari', 'default', 5, 1],
                            ['15k', '15rb - 8 Hari', 'default', 5, 1],
                            ['25k', '25rb - 15 Hari', 'default', 5, 1],
                            ['50k', '50rb - 30 Hari', 'default', 5, 1]
                        ];
                        
                        const insertPromises = fallbackSettings.map(([packageId, name, profile, digits, enabled]) => {
                            return new Promise((resolveInsert, rejectInsert) => {
                                db.run(
                                    'INSERT OR IGNORE INTO voucher_online_settings (package_id, name, profile, digits, enabled) VALUES (?, ?, ?, ?, ?)',
                                    [packageId, name, profile, digits, enabled],
                                    (err) => {
                                        if (err) rejectInsert(err);
                                        else resolveInsert();
                                    }
                                );
                            });
                        });

                        Promise.all(insertPromises).then(() => {
                            db.all('SELECT * FROM voucher_online_settings', (err, rows) => {
                                if (err) {
                                    console.error('Error getting voucher online settings:', err);
                                    resolve({});
                                } else {
                                    const settings = {};
                                    rows.forEach(row => {
                                        settings[row.package_id] = {
                                            name: row.name || `${row.package_id} - Paket`,
                                            profile: row.profile,
                                            digits: row.digits || 5,
                                            enabled: row.enabled === 1
                                        };
                                    });
                                    db.close();
                                    resolve(settings);
                                }
                            });
                        }).catch((err) => {
                            console.error('Error inserting fallback settings:', err);
                            db.close();
                            resolve({});
                        });
                    });
                } else {
                    // Get existing settings
                    db.all('SELECT * FROM voucher_online_settings', (err, rows) => {
                        if (err) {
                            console.error('Error getting voucher online settings:', err);
                            resolve({});
                        } else {
                            const settings = {};
                            rows.forEach(row => {
                                settings[row.package_id] = {
                                    name: row.name || `${row.package_id} - Paket`,
                                    profile: row.profile,
                                    digits: row.digits || 5,
                                    enabled: row.enabled === 1
                                };
                            });
                            db.close();
                            resolve(settings);
                        }
                    });
                }
            });
        });
    });
}

// GET: Tampilkan form tambah user hotspot dan daftar user hotspot
router.get('/', async (req, res) => {
    try {
        // Fetch routers from database
        const db = new sqlite3.Database('./data/billing.db');
        const routers = await new Promise((resolve, reject) => {
            db.all('SELECT * FROM routers ORDER BY id', (err, rows) => {
                if (err) reject(err);
                else resolve(rows || []);
            });
        });

        // Aggregate active users from all NAS
        const activeUsersList = [];
        for (const router of routers) {
            try {
                const result = await getActiveHotspotUsers(router);
                if (result.success && Array.isArray(result.data)) {
                    result.data.forEach(user => {
                        activeUsersList.push({
                            ...user,
                            nas_name: router.name,
                            nas_ip: router.nas_ip
                        });
                    });
                }
            } catch (e) {
                console.error(`Error getting active users from ${router.name}:`, e.message);
            }
        }

        // Aggregate profiles from all NAS
        let profiles = [];
        for (const router of routers) {
            try {
                const profilesResult = await getHotspotProfiles(router);
                if (profilesResult.success && Array.isArray(profilesResult.data)) {
                    profilesResult.data.forEach(prof => {
                        const existing = profiles.find(p => p.name === prof.name && p.nas_id === router.id);
                        if (!existing) {
                            profiles.push({
                                ...prof,
                                nas_id: router.id,
                                nas_name: router.name,
                                nas_ip: router.nas_ip
                            });
                        }
                    });
                }
            } catch (e) {
                console.error(`Error getting profiles from ${router.name}:`, e.message);
            }
        }

        // Aggregate all hotspot users from all NAS
        let allUsers = [];
        for (const router of routers) {
            try {
                const conn = await getMikrotikConnectionForRouter(router);
                const users = await conn.write('/ip/hotspot/user/print');
                allUsers = allUsers.concat(users.map(u => ({
                    name: u.name || '',
                    password: u.password || '',
                    profile: u.profile || '',
                    nas_id: router.id,
                    nas_name: router.name,
                    nas_ip: router.nas_ip
                })));
            } catch (e) {
                console.error(`Error getting users from ${router.name}:`, e.message);
            }
        }

        const settings = getSettingsWithCache();
        const company_header = settings.company_header || 'Voucher Hotspot';
        const adminKontak = settings['admins.0'] || '-';

        // Ambil setting voucher online
        const voucherOnlineSettings = await getVoucherOnlineSettings();

        db.close();

        res.render('adminHotspot', {
            users: activeUsersList,
            profiles,
            allUsers,
            routers,
            voucherOnlineSettings,
            success: req.query.success,
            error: req.query.error,
            company_header,
            adminKontak,
            settings,
            versionInfo: getVersionInfo(),
            versionBadge: getVersionBadge()
        });
    } catch (error) {
        console.error('Error in hotspot GET route:', error);
        res.render('adminHotspot', { 
            users: [], 
            profiles: [], 
            allUsers: [], 
            routers: [],
            success: null, 
            error: 'Gagal mengambil data user hotspot: ' + error.message 
        });
    }
});

// POST: Hapus user hotspot
router.post('/delete', async (req, res) => {
    const { username, router_id } = req.body;
    try {
        let routerObj = null;
        if (router_id) {
            const db = new sqlite3.Database('./data/billing.db');
            routerObj = await new Promise((resolve, reject) => {
                db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                    db.close();
                    if (err) reject(err);
                    else resolve(row || null);
                });
            });
        }
        await deleteHotspotUser(username, routerObj);
        res.redirect('/admin/hotspot?success=User+Hotspot+berhasil+dihapus');
    } catch (error) {
        res.redirect('/admin/hotspot?error=Gagal+hapus+user:+' + encodeURIComponent(error.message));
    }
});

// POST: Proses penambahan user hotspot
router.post('/', async (req, res) => {
    const { username, password, profile, router_id } = req.body;
    try {
        if (!router_id) {
            return res.redirect('/admin/hotspot?error=Pilih+NAS+(router)+terlebih+dahulu');
        }
        const db = new sqlite3.Database('./data/billing.db');
        const routerObj = await new Promise((resolve, reject) => {
            db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                db.close();
                if (err) reject(err);
                else resolve(row || null);
            });
        });
        if (!routerObj) {
            return res.redirect('/admin/hotspot?error=Router+tidak+ditemukan');
        }
        await addHotspotUser(username, password, profile, null, null, routerObj);
        // Redirect agar tidak double submit, tampilkan pesan sukses
        res.redirect('/admin/hotspot?success=User+Hotspot+berhasil+ditambahkan');
    } catch (error) {
        res.redirect('/admin/hotspot?error=Gagal+menambah+user:+"'+encodeURIComponent(error.message)+'"');
    }
});

// POST: Edit user hotspot
router.post('/edit', async (req, res) => {
    const { username, password, profile, router_id, originalUsername } = req.body;
    try {
        if (!router_id) {
            return res.redirect('/admin/hotspot?error=Pilih+NAS+(router)+terlebih+dahulu');
        }
        const db = new sqlite3.Database('./data/billing.db');
        const routerObj = await new Promise((resolve, reject) => {
            db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                db.close();
                if (err) reject(err);
                else resolve(row || null);
            });
        });
        if (!routerObj) {
            return res.redirect('/admin/hotspot?error=Router+tidak+ditemukan');
        }
        // Delete old user and add new one (Mikrotik doesn't have direct edit for hotspot user)
        const { deleteHotspotUser, addHotspotUser } = require('../config/mikrotik');
        await deleteHotspotUser(originalUsername || username, routerObj);
        await addHotspotUser(username, password, profile, null, null, routerObj);
        res.redirect('/admin/hotspot?success=User+Hotspot+berhasil+diupdate');
    } catch (error) {
        res.redirect('/admin/hotspot?error=Gagal+update+user:+' + encodeURIComponent(error.message));
    }
});

// POST: Generate user hotspot voucher
router.post('/generate', async (req, res) => {
    const jumlah = parseInt(req.body.jumlah) || 10;
    const profile = req.body.profile || 'default';
    const panjangPassword = parseInt(req.body.panjangPassword) || 6;
    const generated = [];

    // Ambil nama hotspot dan nomor admin dari settings.json
    const settings = getSettingsWithCache();
    const namaHotspot = settings.company_header || 'HOTSPOT VOUCHER';
    const adminKontak = settings['admins.0'] || '-';

    // Fungsi pembuat string random
    function randomString(length) {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let str = '';
        for (let i = 0; i < length; i++) {
            str += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return str;
    }

    // Generate user dan tambahkan ke Mikrotik
    const { addHotspotUser } = require('../config/mikrotik');
    for (let i = 0; i < jumlah; i++) {
        const username = randomString(6) + randomString(2); // 8 karakter unik
        const password = randomString(panjangPassword);
        try {
            await addHotspotUser(username, password, profile);
            generated.push({ username, password, profile });
        } catch (e) {
            // Lewati user gagal
        }
    }

    // Render voucher dalam grid 4 baris per A4
    res.render('voucherHotspot', {
        vouchers: generated,
        namaHotspot,
        adminKontak,
        profile,
    });
});

// POST: Generate user hotspot vouchers (JSON response)
router.post('/generate-vouchers', async (req, res) => {
    const { quantity, length, profile, type, charType, router_id, price, voucherModel } = req.body;

    try {
        // Fetch router object if router_id is provided
        let routerObj = null;
        if (router_id) {
            const db = new sqlite3.Database('./data/billing.db');
            routerObj = await new Promise((resolve, reject) => {
                db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                    db.close();
                    if (err) reject(err);
                    else resolve(row || null);
                });
            });
            if (!routerObj) {
                return res.status(400).json({
                    success: false,
                    message: 'Router/NAS tidak ditemukan'
                });
            }
        }
        
        // Gunakan fungsi generateHotspotVouchers dengan parameter yang benar
        const count = parseInt(quantity) || parseInt(req.body.count) || 5;
        const prefix = req.body.prefix || 'wifi-'; // Default prefix
        const server = 'all'; // Default server
        const validUntil = req.body.validUntil || '';
        const voucherPrice = price || req.body.price || '';
        const charTypeValue = charType || req.body.charType || 'alphanumeric';
        
        const result = await generateHotspotVouchers(count, prefix, profile, server, validUntil, voucherPrice, charTypeValue, routerObj);
        
        if (result.success) {
            res.json({ 
                success: true, 
                vouchers: result.vouchers,
                router: routerObj ? { name: routerObj.name, ip: routerObj.nas_ip } : null
            });
        } else {
            res.status(500).json({ success: false, message: result.message });
        }
    } catch (error) {
        console.error('Error in generate-vouchers:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// GET: Get active hotspot users count for statistics
router.get('/active-users', async (req, res) => {
    try {
        const result = await getActiveHotspotUsers();
        if (result.success) {
            // Hitung jumlah user yang aktif dari data array
            const activeCount = Array.isArray(result.data) ? result.data.length : 0;
            res.json({ success: true, activeUsers: activeCount, activeUsersList: result.data });
        } else {
            console.error('Failed to get active hotspot users:', result.message);
            res.status(500).json({ success: false, message: result.message });
        }
    } catch (error) {
        console.error('Error getting active hotspot users:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// GET: Get active hotspot users detail for table
router.get('/active-users-detail', async (req, res) => {
    try {
        const result = await getActiveHotspotUsers();
        if (result.success) {
            res.json({ success: true, activeUsers: result.data });
        } else {
            res.status(500).json({ success: false, message: result.message });
        }
    } catch (error) {
        console.error('Error getting active hotspot users detail:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// POST: Disconnect hotspot user
router.post('/disconnect-user', async (req, res) => {
    const { username } = req.body;
    if (!username) {
        return res.status(400).json({ success: false, message: 'Username diperlukan' });
    }
    
    try {
        const result = await disconnectHotspotUser(username);
        if (result.success) {
            res.json({ success: true, message: `User ${username} berhasil diputus` });
        } else {
            res.status(500).json({ success: false, message: result.message });
        }
    } catch (error) {
        console.error('Error disconnecting hotspot user:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// GET: Ambil data user hotspot aktif untuk AJAX
router.get('/active-users', async (req, res) => {
    try {
        const result = await getActiveHotspotUsers();
        if (result.success) {
            // Log data untuk debugging
            console.log('Active users data:', JSON.stringify(result.data).substring(0, 200) + '...');
            res.json({ success: true, activeUsersList: result.data });
        } else {
            console.error('Failed to get active users:', result.message);
            res.status(500).json({ success: false, message: result.message });
        }
    } catch (error) {
        console.error('Error getting active hotspot users:', error);
        res.status(500).json({ success: false, message: error.message });
    }
});

// GET: Tampilkan halaman voucher hotspot
router.get('/voucher', async (req, res) => {
    try {
        // Fetch routers from database
        const db = new sqlite3.Database('./data/billing.db');
        const routers = await new Promise((resolve, reject) => {
            db.all('SELECT * FROM routers ORDER BY id', (err, rows) => {
                if (err) reject(err);
                else resolve(rows || []);
            });
        });

        // Aggregate profiles from all NAS
        let profiles = [];
        for (const router of routers) {
            try {
                const profilesResult = await getHotspotProfiles(router);
                if (profilesResult.success && Array.isArray(profilesResult.data)) {
                    profilesResult.data.forEach(prof => {
                        const existing = profiles.find(p => p.name === prof.name && p.nas_id === router.id);
                        if (!existing) {
                            profiles.push({
                                ...prof,
                                nas_id: router.id,
                                nas_name: router.name,
                                nas_ip: router.nas_ip
                            });
                        }
                    });
                }
            } catch (e) {
                console.error(`Error getting profiles from ${router.name}:`, e.message);
            }
        }
        
        // Aggregate servers from all NAS
        let servers = [];
        for (const router of routers) {
            try {
                const serversResult = await getHotspotServers(router);
                if (serversResult.success && Array.isArray(serversResult.data)) {
                    servers = servers.concat(serversResult.data);
                }
            } catch (e) {
                console.error(`Error getting servers from ${router.name}:`, e.message);
            }
        }
        
        // Aggregate all hotspot users from all NAS for voucher history
        let allUsers = [];
        const activeUsernames = [];
        
        for (const router of routers) {
            try {
                const conn = await getMikrotikConnectionForRouter(router);
                const users = await conn.write('/ip/hotspot/user/print');
                allUsers = allUsers.concat(users.map(u => ({
                    name: u.name || '',
                    password: u.password || '',
                    profile: u.profile || 'default',
                    server: u.server || 'all',
                    comment: u.comment || '',
                    nas_id: router.id,
                    nas_name: router.name,
                    nas_ip: router.nas_ip
                })));
                
                // Get active users from this router
                const activeResult = await getActiveHotspotUsers(router);
                if (activeResult.success && Array.isArray(activeResult.data)) {
                    activeResult.data.forEach(user => {
                        activeUsernames.push(user.user || user.name || '');
                    });
                }
            } catch (e) {
                console.error(`Error getting users from ${router.name}:`, e.message);
            }
        }
        
        // Filter hanya voucher (berdasarkan prefix atau kriteria lain)
        const voucherHistory = allUsers.filter(user => 
            user.name && (user.name.startsWith('wifi-') || user.comment === 'voucher')
        ).map(user => ({
            username: user.name || '',
            password: user.password || '',
            profile: user.profile || 'default',
            server: user.server || 'all',
            createdAt: new Date(),
            active: activeUsernames.includes(user.name),
            comment: user.comment || '',
            nas_id: user.nas_id,
            nas_name: user.nas_name,
            nas_ip: user.nas_ip
        }));
        
        console.log(`Loaded ${voucherHistory.length} vouchers for history table`);
        
        // Ambil pengaturan dari settings.json
        const settings = getSettingsWithCache();
        const company_header = settings.company_header || 'Voucher Hotspot';
        const adminKontak = settings['footer_info'] || '-';
        
        db.close();

        res.render('adminVoucher', {
            profiles,
            servers,
            voucherHistory,
            routers,
            success: req.query.success,
            error: req.query.error,
            company_header,
            adminKontak,
            settings,
            versionInfo: getVersionInfo(),
            versionBadge: getVersionBadge()
        });
    } catch (error) {
        console.error('Error rendering voucher page:', error);
        res.render('adminVoucher', {
            profiles: [],
            servers: [],
            voucherHistory: [],
            routers: [],
            success: null,
            error: 'Gagal memuat halaman voucher: ' + error.message,
            settings: getSettingsWithCache(),
            versionInfo: getVersionInfo(),
            versionBadge: getVersionBadge()
        });
    }
});

// POST: Generate voucher dengan JSON response
router.post('/generate-voucher', async (req, res) => {
    try {
        // Log request untuk debugging
        console.log('Generate voucher request:', req.body);
        console.log('Count from request:', req.body.count);
        console.log('Profile from request:', req.body.profile);
        console.log('Router ID from request:', req.body.router_id);
        console.log('Price from request:', req.body.price);
        console.log('CharType from request:', req.body.charType);
        
        const count = parseInt(req.body.count) || 5;
        const prefix = req.body.prefix || 'wifi-';
        const profile = req.body.profile || 'default';
        const router_id = req.body.router_id || req.body.routerId;
        const server = req.body.server || 'all';
        const validUntil = req.body.validUntil || '';
        const price = req.body.price || '';
        const voucherModel = req.body.voucherModel || 'standard';
        const charType = req.body.charType || 'alphanumeric';
        
        // Fetch router object if router_id is provided
        let routerObj = null;
        if (router_id) {
            const db = new sqlite3.Database('./data/billing.db');
            routerObj = await new Promise((resolve, reject) => {
                db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                    db.close();
                    if (err) reject(err);
                    else resolve(row || null);
                });
            });
            if (!routerObj) {
                return res.status(400).json({
                    success: false,
                    message: 'Router/NAS tidak ditemukan'
                });
            }
            console.log('Router selected:', routerObj.name, routerObj.nas_ip);
        }
        
        console.log('Parsed values:');
        console.log('- Count:', count);
        console.log('- Profile:', profile);
        console.log('- Router:', routerObj ? routerObj.name : 'default');
        console.log('- Price:', price);
        console.log('- CharType:', charType);
        
        // Gunakan fungsi generateHotspotVouchers yang sudah diimport di atas
        const result = await generateHotspotVouchers(count, prefix, profile, server, validUntil, price, charType, routerObj);
        
        if (!result.success) {
            throw new Error(result.message || 'Gagal generate voucher');
        }
        
        // Ambil pengaturan dari settings.json
        const settings = getSettingsWithCache();
        const namaHotspot = settings.company_header || 'HOTSPOT VOUCHER';
        const adminKontak = settings['footer_info'] || '-';
        
        // Log response untuk debugging
        console.log(`Generated ${result.vouchers.length} vouchers successfully`);
        
        const response = {
            success: true,
            vouchers: result.vouchers.map(voucher => ({
                ...voucher,
                profile: profile, // Pastikan profile ada di setiap voucher
                price: price // Pastikan harga ada di setiap voucher
            })),
            server,
            profile,
            validUntil,
            price,
            voucherModel: voucherModel,
            namaHotspot,
            adminKontak
        };
        
        console.log('Response:', JSON.stringify(response));
        res.json(response);
    } catch (error) {
        console.error('Error generating vouchers:', error);
        res.status(500).json({
            success: false,
            message: 'Gagal generate voucher: ' + error.message
        });
    }
});

// GET: Print vouchers page
router.get('/print-vouchers', async (req, res) => {
    try {
        // Ambil pengaturan dari settings.json
        const settings = getSettingsWithCache();
        const namaHotspot = settings.company_header || 'HOTSPOT VOUCHER';
        const adminKontak = settings['admins.0'] || '-';
        
        res.render('voucherHotspot', {
            vouchers: [], // Voucher akan dikirim via postMessage
            namaHotspot,
            adminKontak
        });
    } catch (error) {
        res.status(500).send('Error: ' + error.message);
    }
});

// POST: Delete voucher
router.post('/delete-voucher', async (req, res) => {
    const { username, router_id } = req.body;
    if (!username) {
        return res.redirect('/admin/hotspot/voucher?error=Username+diperlukan');
    }

    try {
        let routerObj = null;
        if (router_id) {
            const db = new sqlite3.Database('./data/billing.db');
            routerObj = await new Promise((resolve, reject) => {
                db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                    db.close();
                    if (err) reject(err);
                    else resolve(row || null);
                });
            });
        }
        await deleteHotspotUser(username, routerObj);
        res.redirect('/admin/hotspot/voucher?success=Voucher+berhasil+dihapus');
    } catch (error) {
        console.error('Error deleting voucher:', error);
        res.redirect('/admin/hotspot/voucher?error=' + encodeURIComponent('Gagal menghapus voucher: ' + error.message));
    }
});

// POST: Generate manual voucher for online settings
router.post('/generate-manual-voucher', async (req, res) => {
    try {
        const { username, password, profile, router_id } = req.body;

        if (!username || !password || !profile) {
            return res.status(400).json({
                success: false,
                message: 'Username, password, dan profile harus diisi'
            });
        }

        if (!router_id) {
            return res.status(400).json({
                success: false,
                message: 'Pilih NAS (Router) terlebih dahulu'
            });
        }

        // Fetch router object
        const db = new sqlite3.Database('./data/billing.db');
        const routerObj = await new Promise((resolve, reject) => {
            db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                db.close();
                if (err) reject(err);
                else resolve(row || null);
            });
        });

        if (!routerObj) {
            return res.status(400).json({
                success: false,
                message: 'Router/NAS tidak ditemukan'
            });
        }

        // Add user to Mikrotik with routerObj
        const result = await addHotspotUser(username, password, profile, 'voucher', null, routerObj);

        if (result.success) {
            res.json({
                success: true,
                message: 'Voucher manual berhasil dibuat',
                voucher: {
                    username,
                    password,
                    profile,
                    nas_name: routerObj.name,
                    nas_ip: routerObj.nas_ip
                }
            });
        } else {
            res.status(500).json({
                success: false,
                message: 'Gagal membuat voucher: ' + (result.message || 'Unknown error')
            });
        }

    } catch (error) {
        console.error('Error generating manual voucher:', error);
        res.status(500).json({
            success: false,
            message: 'Error membuat voucher manual: ' + error.message
        });
    }
});

// POST: Generate auto voucher for online settings
router.post('/generate-auto-voucher', async (req, res) => {
    try {
        const { count, profile, router_id, numericOnly } = req.body;
        const numVouchers = parseInt(count) || 1;

        if (numVouchers > 10) {
            return res.status(400).json({
                success: false,
                message: 'Maksimal 10 voucher per generate'
            });
        }

        if (!router_id) {
            return res.status(400).json({
                success: false,
                message: 'Pilih NAS (Router) terlebih dahulu'
            });
        }

        // Fetch router object
        const db = new sqlite3.Database('./data/billing.db');
        const routerObj = await new Promise((resolve, reject) => {
            db.get('SELECT * FROM routers WHERE id=?', [parseInt(router_id)], (err, row) => {
                db.close();
                if (err) reject(err);
                else resolve(row || null);
            });
        });

        if (!routerObj) {
            return res.status(400).json({
                success: false,
                message: 'Router/NAS tidak ditemukan'
            });
        }

        const generatedVouchers = [];

        // Function to generate random string
        function randomString(length, numeric = false) {
            const chars = numeric ? '0123456789' : 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let str = '';
            for (let i = 0; i < length; i++) {
                str += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return str;
        }

        // Generate vouchers
        for (let i = 0; i < numVouchers; i++) {
            let username, password;

            if (numericOnly) {
                // Username dan password sama, angka saja
                const randomNum = randomString(8, true);
                username = randomNum;
                password = randomNum;
            } else {
                // Username dan password berbeda
                username = randomString(6) + randomString(2);
                password = randomString(8);
            }

            try {
                const result = await addHotspotUser(username, password, profile, 'voucher', null, routerObj);
                if (result.success) {
                    generatedVouchers.push({
                        username,
                        password,
                        profile,
                        nas_name: routerObj.name,
                        nas_ip: routerObj.nas_ip
                    });
                }
            } catch (e) {
                console.error(`Failed to create voucher ${i + 1}:`, e.message);
            }
        }

        res.json({
            success: true,
            message: `${generatedVouchers.length} voucher otomatis berhasil dibuat`,
            vouchers: generatedVouchers
        });

    } catch (error) {
        console.error('Error generating auto voucher:', error);
        res.status(500).json({
            success: false,
            message: 'Error membuat voucher otomatis: ' + error.message
        });
    }
});

// POST: Reset setting voucher online ke profile pertama
router.post('/reset-voucher-online-settings', async (req, res) => {
    try {
        const sqlite3 = require('sqlite3').verbose();
        const db = new sqlite3.Database('./data/billing.db');

        // Get first available profile from Mikrotik
        const { getHotspotProfiles } = require('../config/mikrotik');
        const profilesResult = await getHotspotProfiles();
        const defaultProfile = (profilesResult.success && profilesResult.data && profilesResult.data.length > 0) 
            ? profilesResult.data[0].name 
            : 'default';

        // Update all packages to use first profile
        const packages = ['3k', '5k', '10k', '15k', '25k', '50k'];
        const updatePromises = packages.map(packageId => {
            return new Promise((resolve, reject) => {
                db.run(
                    'UPDATE voucher_online_settings SET profile = ? WHERE package_id = ?',
                    [defaultProfile, packageId],
                    (err) => {
                        if (err) reject(err);
                        else resolve();
                    }
                );
            });
        });

        await Promise.all(updatePromises);
        db.close();

        res.json({
            success: true,
            message: `Setting voucher online berhasil direset ke profile: ${defaultProfile}`,
            defaultProfile: defaultProfile
        });

    } catch (error) {
        console.error('Error resetting voucher online settings:', error);
        res.status(500).json({
            success: false,
            message: 'Gagal reset setting voucher online: ' + error.message
        });
    }
});

// POST: Save voucher online settings
router.post('/save-voucher-online-settings', async (req, res) => {
    try {
        const settings = req.body.settings;

        if (!settings || typeof settings !== 'object') {
            return res.status(400).json({
                success: false,
                message: 'Settings data tidak valid'
            });
        }

        const sqlite3 = require('sqlite3').verbose();
        const db = new sqlite3.Database('./data/billing.db');

        // Ensure voucher_online_settings table exists
        await new Promise((resolve, reject) => {
            db.run(`
                CREATE TABLE IF NOT EXISTS voucher_online_settings (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    package_id TEXT NOT NULL UNIQUE,
                    name TEXT NOT NULL DEFAULT '',
                    profile TEXT NOT NULL,
                    digits INTEGER NOT NULL DEFAULT 5,
                    enabled INTEGER NOT NULL DEFAULT 1,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `, (err) => {
                if (err) reject(err);
                else resolve();
            });
        });

        // Update settings for each package
        const promises = Object.keys(settings).map(packageId => {
            const setting = settings[packageId];
            return new Promise((resolve, reject) => {
                const sql = `
                    INSERT OR REPLACE INTO voucher_online_settings
                    (package_id, name, profile, digits, enabled, updated_at)
                    VALUES (?, ?, ?, ?, ?, datetime('now'))
                `;
                db.run(sql, [packageId, setting.name || `${packageId} - Paket`, setting.profile, setting.digits || 5, setting.enabled ? 1 : 0], function(err) {
                    if (err) reject(err);
                    else resolve();
                });
            });
        });

        await Promise.all(promises);

        db.close();

        res.json({
            success: true,
            message: 'Setting voucher online berhasil disimpan'
        });

    } catch (error) {
        console.error('Error saving voucher online settings:', error);
        res.status(500).json({
            success: false,
            message: 'Gagal menyimpan setting voucher online: ' + error.message
        });
    }
});

// POST: Save voucher generation settings
router.post('/save-voucher-generation-settings', async (req, res) => {
    try {
        const settings = req.body.settings;

        if (!settings || typeof settings !== 'object') {
            return res.status(400).json({
                success: false,
                message: 'Settings data tidak valid'
            });
        }

        const sqlite3 = require('sqlite3').verbose();
        const db = new sqlite3.Database('./data/billing.db');

        // Ensure voucher_generation_settings table exists
        await new Promise((resolve, reject) => {
            db.run(`
                CREATE TABLE IF NOT EXISTS voucher_generation_settings (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    setting_key TEXT NOT NULL UNIQUE,
                    setting_value TEXT NOT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `, (err) => {
                if (err) reject(err);
                else resolve();
            });
        });

        // Update settings
        const promises = Object.keys(settings).map(key => {
            return new Promise((resolve, reject) => {
                const sql = `
                    INSERT OR REPLACE INTO voucher_generation_settings
                    (setting_key, setting_value, updated_at)
                    VALUES (?, ?, datetime('now'))
                `;
                db.run(sql, [key, settings[key]], function(err) {
                    if (err) reject(err);
                    else resolve();
                });
            });
        });

        await Promise.all(promises);
        db.close();

        res.json({
            success: true,
            message: 'Pengaturan generate voucher berhasil disimpan'
        });

    } catch (error) {
        console.error('Error saving voucher generation settings:', error);
        res.status(500).json({
            success: false,
            message: 'Gagal menyimpan pengaturan: ' + error.message
        });
    }
});

// POST: Test voucher generation
router.post('/test-voucher-generation', async (req, res) => {
    try {
        const settings = req.body.settings;

        if (!settings || typeof settings !== 'object') {
            return res.status(400).json({
                success: false,
                message: 'Settings data tidak valid'
            });
        }

        // Generate test voucher based on settings
        const { generateTestVoucher } = require('../config/mikrotik');
        const result = await generateTestVoucher(settings);

        if (result.success) {
            res.json({
                success: true,
                username: result.username,
                password: result.password,
                message: 'Test generate voucher berhasil'
            });
        } else {
            res.json({
                success: false,
                message: result.message
            });
        }

    } catch (error) {
        console.error('Error testing voucher generation:', error);
        res.status(500).json({
            success: false,
            message: 'Gagal test generate voucher: ' + error.message
        });
    }
});

module.exports = router;
