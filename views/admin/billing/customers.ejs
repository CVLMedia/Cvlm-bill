<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Kelola Pelanggan' %> - <%= typeof isTechnicianView !== 'undefined' && isTechnicianView ? 'Portal Teknisi' : 'Admin Portal' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Admin Mobile Optimizations -->
    <link href="/css/admin-mobile.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .toast-container {
            z-index: 9999;
        }
        .toast {
            min-width: 300px;
        }

        /* Modern Notification Modal - Neumorphic Style (untuk sukses/error besar) */
        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* default hidden, tidak blok UI */
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .notification-overlay.show {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }
        
        .notification-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 24px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 
                20px 20px 60px #d0d0d0,
                -20px -20px 60px #ffffff,
                inset 0 0 0 rgba(255, 255, 255, 0),
                inset 0 0 0 rgba(0, 0, 0, 0);
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .notification-overlay.show .notification-card {
            transform: scale(1);
        }
        
        .notification-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            position: relative;
            box-shadow: 
                8px 8px 16px rgba(0, 0, 0, 0.2),
                -8px -8px 16px rgba(255, 255, 255, 0.3);
        }
        
        .notification-icon.success {
            background: linear-gradient(145deg, #4CAF50, #45a049);
        }
        
        .notification-icon.error {
            background: linear-gradient(145deg, #f44336, #d32f2f);
        }
        
        .notification-icon.warning {
            background: linear-gradient(145deg, #ff9800, #f57c00);
        }
        
        .notification-icon.info {
            background: linear-gradient(145deg, #2196F3, #1976D2);
        }
        
        .notification-title {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .notification-message {
            font-size: 16px;
            color: #5a6c7d;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .notification-button {
            background: linear-gradient(145deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 
                6px 6px 12px rgba(0, 0, 0, 0.15),
                -6px -6px 12px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .notification-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                8px 8px 16px rgba(0, 0, 0, 0.2),
                -8px -8px 16px rgba(255, 255, 255, 0.15);
        }
        
        .notification-button:active {
            transform: translateY(0);
            box-shadow: 
                4px 4px 8px rgba(0, 0, 0, 0.1),
                -4px -4px 8px rgba(255, 255, 255, 0.1);
        }
        
        .notification-button.success {
            background: linear-gradient(145deg, #4CAF50, #45a049);
        }
        
        .notification-button.error {
            background: linear-gradient(145deg, #f44336, #d32f2f);
        }
        
        .notification-button.warning {
            background: linear-gradient(145deg, #ff9800, #f57c00);
        }

        .notification-button-secondary {
            background: linear-gradient(145deg, #6c757d, #5a6268) !important;
        }
        
        #notificationButtons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        /* Modern Metric Cards Styling - Same as admin/dashboard */
        .metric-card {
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            background: var(--card-bg-color);
            color: #ffffff;
            min-height: auto;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            font-size: 24px;
            backdrop-filter: blur(10px);
        }
        
        .metric-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
            margin: 8px 0;
            line-height: 1.2;
        }
        
        .metric-card-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Card Colors - Gradient Backgrounds */
        .metric-card-primary {
            --card-bg-color: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        
        .metric-card-success {
            --card-bg-color: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        .metric-card-warning {
            --card-bg-color: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        
        .metric-card-danger {
            --card-bg-color: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }
        
        .metric-card-info {
            --card-bg-color: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .metric-card {
                padding: 16px;
            }
            
            .metric-card-value {
                font-size: 1.5rem;
            }
            
            .metric-card-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }
        
        /* Photo thumbnail styling */
        .img-thumbnail {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .img-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            position: relative;
        }
        
        /* PPPoE Username styling */
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #pppoe_username.border-success {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }
        
        #pppoe_username.border-warning {
            border-color: #ffc107 !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }
        
        /* Custom PPPoE Dropdown Styles */
        .pppoe-dropdown {
            position: fixed !important;
            background: white !important;
            border: 2px solid #007bff !important;
            border-radius: 0.375rem !important;
            max-height: 200px !important;
            overflow-y: auto !important;
            z-index: 99999 !important;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
            display: none !important;
            width: 300px !important;
            min-height: 40px !important;
        }
        
        .pppoe-dropdown.show {
            display: block !important;
        }
        
        /* Ensure input group has relative positioning */
        .input-group {
            position: relative !important;
        }
        
        /* Modal z-index fix */
        .modal {
            z-index: 1050 !important;
        }
        
        .modal-backdrop {
            z-index: 1040 !important;
        }
        
        /* Modal body overflow fix */
        .modal-body {
            overflow: visible !important;
        }
        
        /* Form overflow fix */
        .modal-body form {
            overflow: visible !important;
        }
        
        .pppoe-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pppoe-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .pppoe-dropdown-item.active {
            background-color: #e3f2fd;
        }
        
        .pppoe-dropdown-item .username {
            font-weight: 500;
            color: #333;
        }
        
        .pppoe-dropdown-item .profile {
            font-size: 0.875rem;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            display: none; /* Hidden since profile is not needed */
        }
        
        .pppoe-dropdown-item .status {
            font-size: 0.75rem;
            padding: 1px 4px;
            border-radius: 2px;
        }
        
        .pppoe-dropdown-item .status.active {
            background: #d4edda;
            color: #155724;
        }
        
        .pppoe-dropdown-item .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .pppoe-dropdown-no-results {
            padding: 12px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Input group relative positioning for dropdown */
        .input-group {
            position: relative;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px !important;
                margin-left: 0 !important;
            }
            
            /* Header responsive */
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn-group {
                flex-wrap: wrap;
                gap: 5px;
                width: 100%;
            }
            
            .btn-group .btn {
                font-size: 12px;
                padding: 8px 12px;
                flex: 1;
                min-width: auto;
            }
            
            /* Summary cards responsive */
            .row.mb-4 .col-xl-2 {
                margin-bottom: 15px;
            }
            
            .card-body {
                padding: 1rem 0.75rem;
            }
            
            .card-body h5 {
                font-size: 0.85rem;
            }
            
            .card-body h3 {
                font-size: 1.5rem;
            }
            
            /* Table responsive */
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .table th, .table td {
                padding: 8px 4px;
                white-space: nowrap;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            /* Modal responsive */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            
            .form-control, .form-select {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            /* Action buttons in table */
            .btn-group-vertical .btn {
                padding: 6px 10px;
                font-size: 11px;
                margin-bottom: 2px;
            }
            
            /* Search and filter */
            .dataTables_filter input {
                width: 100% !important;
                margin: 0 !important;
            }
            
            .dataTables_length select {
                width: auto !important;
            }
            
            /* Pagination */
            .dataTables_paginate {
                text-align: center !important;
            }
            
            .dataTables_paginate .paginate_button {
                padding: 6px 10px !important;
                margin: 0 2px !important;
            }
            
            /* Touch friendly buttons */
            .btn {
                min-height: 42px;
                touch-action: manipulation;
            }
            
            .btn-sm {
                min-height: 36px;
            }
            
            /* Map responsive (jika ada) */
            #customerMap {
                height: 300px !important;
            }
            
            /* Checkbox and form controls */
            .form-check-input {
                width: 1.2em;
                height: 1.2em;
            }
            
            /* Alert messages */
            .alert {
                font-size: 0.9rem;
                padding: 0.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .h2 {
                font-size: 1.3rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .btn-group .btn {
                font-size: 11px;
                padding: 6px 8px;
            }
            
            /* Stack summary cards vertically on very small screens */
            .col-xl-2.col-md-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }
        
        /* GPS Button Enhancements */
        #gpsButton, #editGpsButton {
            transition: all 0.3s ease;
            position: relative;
        }
        
        #gpsButton:hover:not(:disabled), #editGpsButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        #gpsButton:disabled, #editGpsButton:disabled {
            transform: none;
            box-shadow: none;
        }
        
        .bx-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Location help styling */
        .accordion-button {
            font-size: 0.9rem;
        }
        
        .accordion-body ol li {
            margin-bottom: 0.5rem;
        }
        
        /* Mobile responsive adjustments for GPS buttons */
        @media (max-width: 767.98px) {
            #gpsButton, #editGpsButton {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .d-grid.gap-2.d-md-flex {
                display: block !important;
            }
            
            .d-grid.gap-2.d-md-flex .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <% if (typeof isTechnicianView !== 'undefined' && isTechnicianView) { %>
                <%- include('../../partials/technician-responsive-sidebar', { page: 'customers', technician: technician }) %>
            <% } else { %>
                <%- include('../../partials/billing-sidebar') %>
            <% } %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bx bx-user"></i> <%= title || 'Kelola Pelanggan' %>
                    </h1>
                    
                    <!-- Desktop: Show all buttons -->
                    <div class="d-none d-lg-block">
                        <div class="d-inline-block me-2">
                            <select id="routerFilter" class="form-select form-select-sm">
                                <option value="">Semua NAS</option>
                                <% if (typeof routers !== 'undefined') { routers.forEach(function(r){ %>
                                    <option value="<%= r.id %>" <%= (typeof routerFilter !== 'undefined' && routerFilter == r.id) ? 'selected' : '' %>><%= r.name %> (<%= r.nas_ip %>)</option>
                                <% }); } %>
                            </select>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                            <i class="bx bx-plus"></i> Tambah Pelanggan
                        </button>
                        <div class="btn-group ms-2" role="group" aria-label="Backup Restore Pelanggan">
                            <button id="exportCustomersJsonBtn" type="button" class="btn btn-outline-success">
                                <i class="bi bi-cloud-download"></i> Backup Pelanggan (JSON)
                            </button>
                            <button id="exportCustomersXlsxBtn" type="button" class="btn btn-outline-success">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Backup Pelanggan (XLSX)
                            </button>
                            <button id="openImportCustomersModalBtn" type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#importCustomersModal">
                                <i class="bi bi-cloud-upload"></i> Restore Pelanggan
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mobile: Hamburger dropdown menu -->
                    <div class="dropdown d-lg-none">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="actionMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bx bx-menu"></i> Menu
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionMenuDropdown">
                            <li class="px-3 py-2">
                                <select id="routerFilterMobile" class="form-select form-select-sm">
                                    <option value="">Semua NAS</option>
                                    <% if (typeof routers !== 'undefined') { routers.forEach(function(r){ %>
                                        <option value="<%= r.id %>" <%= (typeof routerFilter !== 'undefined' && routerFilter == r.id) ? 'selected' : '' %>><%= r.name %> (<%= r.nas_ip %>)</option>
                                    <% }); } %>
                                </select>
                            </li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                                <i class="bx bx-plus"></i> Tambah Pelanggan
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="exportCustomersJsonBtnMobile">
                                <i class="bi bi-cloud-download"></i> Backup JSON
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="exportCustomersXlsxBtnMobile">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Backup XLSX
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importCustomersModal">
                                <i class="bi bi-cloud-upload"></i> Restore Pelanggan
                            </a></li>
                        </ul>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="metric-card metric-card-primary">
                            <div class="metric-card-icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="metric-card-value"><%= customers ? customers.length : 0 %></div>
                            <div class="metric-card-label">Total Pelanggan</div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="metric-card metric-card-success">
                            <div class="metric-card-icon">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="metric-card-value">
                                <%= customers ? customers.filter(c => c.payment_status === 'paid').length : 0 %>
                            </div>
                            <div class="metric-card-label">Sudah Bayar</div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="metric-card metric-card-warning">
                            <div class="metric-card-icon">
                                <i class="bi bi-x-circle"></i>
                            </div>
                            <div class="metric-card-value">
                                <%= customers ? customers.filter(c => c.payment_status === 'unpaid').length : 0 %>
                            </div>
                            <div class="metric-card-label">Belum Bayar</div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="metric-card metric-card-danger">
                            <div class="metric-card-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div class="metric-card-value">
                                <%= customers ? customers.filter(c => c.payment_status === 'overdue' || c.status === 'suspended').length : 0 %>
                            </div>
                            <div class="metric-card-label">Isolir</div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="metric-card metric-card-info">
                            <div class="metric-card-icon">
                                <i class="bi bi-receipt"></i>
                            </div>
                            <div class="metric-card-value">
                                <%= customers ? customers.filter(c => c.payment_status === 'no_invoice').length : 0 %>
                            </div>
                            <div class="metric-card-label">Non Tagihan</div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
                        <div class="metric-card metric-card-success">
                            <div class="metric-card-icon">
                                <i class="bi bi-person-check"></i>
                            </div>
                            <div class="metric-card-value">
                                <%= customers ? customers.filter(c => c.status === 'active').length : 0 %>
                            </div>
                            <div class="metric-card-label">Pelanggan Aktif</div>
                        </div>
                    </div>
                </div>

                <!-- Customer Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bx bx-list-ul"></i> Daftar Pelanggan
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllCustomers">
                                    <label class="form-check-label" for="selectAllCustomers">
                                        Pilih Semua
                                    </label>
                                </div>
                            </div>
                            <div>
                                <button id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>
                                    <i class="bx bx-trash"></i> Hapus Terpilih
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="customersTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th style="width:32px">
                                            <!-- header checkbox already above -->
                                        </th>
                                        <th>ID Pelanggan</th>
                                        <th>Nama</th>
                                        <th>Username</th>
                                        <th>Telepon</th>
                                        <th>PPPoE Username</th>
                                        <th>Paket</th>
                                        <th>PPPoE Profile</th>
                                        <th>Tipe Tagihan</th>
                                        <th>NAS</th>
                                        <th>Status Pelanggan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (customers && customers.length > 0) { %>
                                        <% customers.forEach(function(customer) { %>
                                            <tr data-phone="<%= customer.phone %>" data-username="<%= customer.pppoe_username %>">
                                                <td>
                                                    <input type="checkbox" class="form-check-input customer-checkbox" value="<%= customer.phone %>">
                                                </td>
                                                <td>
                                                    <% if (customer.customer_id) { %>
                                                        <span class="badge bg-primary" style="font-size: 0.9rem; font-family: monospace;"><%= customer.customer_id %></span>
                                                    <% } else { %>
                                                        <span class="text-muted">-</span>
                                                    <% } %>
                                                </td>
                                                <td><a href="/admin/billing/customers/<%= customer.phone %>" class="text-decoration-none fw-bold"><%= customer.name %></a></td>
                                                <td><%= customer.username || '-' %></td>
                                                <td><a href="/admin/billing/customers/<%= customer.phone %>" class="text-decoration-none text-primary"><%= customer.phone %></a></td>
                                                <td><%= customer.pppoe_username || '-' %></td>
                                                <td><%= customer.package_name || '-' %></td>
                                                <td class="pppoe-profile"><span class="badge bg-info"><%= customer.pppoe_profile || 'default' %></span></td>
                                                <td>
                                                    <% if (customer.renewal_type === 'fix_date') { %>
                                                        <span class="badge bg-info">
                                                            <i class="bx bx-calendar"></i> Fix Date (<%= customer.fix_date || 15 %>)
                                                        </span>
                                                    <% } else { %>
                                                        <span class="badge bg-primary">
                                                            <i class="bx bx-refresh"></i> Renewal
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (customer.router_name) { %>
                                                        <span class="badge bg-secondary"><%= customer.router_name %></span>
                                                    <% } else { %>
                                                        <span class="text-muted">-</span>
                                                    <% } %>
                                                </td>
                                                <td class="cust-status">
                                                    <% if (customer.status === 'active') { %>
                                                        <span class="badge bg-success">Aktif</span>
                                                    <% } else if (customer.status === 'suspended') { %>
                                                        <span class="badge bg-danger">Isolir</span>
                                                    <% } else if (customer.status && customer.status.toLowerCase() === 'register') { %>
                                                        <span class="badge" style="background-color: #9900CC; color: white;">Register</span>
                                                    <% } else { %>
                                                        <span class="badge bg-secondary">Nonaktif</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-info" onclick="viewCustomerDetail('<%= customer.phone %>')" title="Lihat Detail">
                                                            <i class="bx bx-show"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-primary" onclick="editCustomer('<%= customer.phone %>')" title="Edit Customer">
                                                            <i class="bx bx-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-success" onclick="sendWhatsAppNotification('<%= customer.phone %>', '<%= customer.name %>')" title="Kirim Notifikasi WhatsApp">
                                                            <i class="bx bxl-whatsapp"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('<%= customer.phone %>')" title="Hapus Customer">
                                                            <i class="bx bx-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    // Update summary cards dynamically
    function updateSummaryCards(data) {
        try {
            const mappings = [
                { selector: 'h3.mt-3.mb-3', index: 0, value: data.total }, // first card total customers
            ];
            // Because the structure is uniform, query all h3s inside summary row and set by order.
            const row = document.querySelectorAll('.row.mb-4 .card .card-body h3.mt-3.mb-3');
            if (row && row.length >= 6) {
                row[0].textContent = data.total;
                row[1].textContent = data.paid;
                row[2].textContent = data.unpaid;
                row[3].textContent = data.isolir;
                row[4].textContent = data.noInvoice;
                row[5].textContent = data.active;
            }
        } catch (e) {
            console.warn('Failed to update summary cards:', e);
        }
    }

    async function fetchSummary() {
        try {
            const resp = await fetch('/admin/billing/customers/summary');
            const res = await resp.json();
            if (res.success && res.data) {
                updateSummaryCards(res.data);
            }
        } catch (e) {
            console.warn('Failed to fetch summary:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchSummary();
        setInterval(fetchSummary, 5000);
        
        // Handle renewal type change for add form
        $('#renewal_type').on('change', function() {
            if ($(this).val() === 'fix_date') {
                $('#fix_date_container').show();
            } else {
                $('#fix_date_container').hide();
            }
        });
        
        // Handle renewal type change for edit form
        $('#edit_renewal_type').on('change', function() {
            if ($(this).val() === 'fix_date') {
                $('#edit_fix_date_container').show();
            } else {
                $('#edit_fix_date_container').hide();
            }
        });
    });
    </script>
    <script>
      // Router filter change -> reload with query
      function applyRouterFilter(val){
        const url = new URL(window.location.href);
        if(val) url.searchParams.set('router', val); else url.searchParams.delete('router');
        window.location.href = url.toString();
      }
      document.getElementById('routerFilter')?.addEventListener('change', function(){ applyRouterFilter(this.value); });
      document.getElementById('routerFilterMobile')?.addEventListener('change', function(){ applyRouterFilter(this.value); });
    </script>

    <!-- Add Customer Modal -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pelanggan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addCustomerForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nama * <small class="text-muted">(username & email akan auto-generate dari nama)</small></label>
                            <input type="text" class="form-control" id="name" name="name" required onblur="generateCredentialsFromName()" oninput="generateCredentialsFromName()">
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" name="username" required placeholder="Akan otomatis terisi dari nama + tanggal (contoh: test_280825)">
                            <small class="form-text text-muted">Username akan digunakan untuk login pelanggan dan payment gateway. Format otomatis: nama_DDMMYY</small>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telepon *</label>
                            <input type="text" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="Akan otomatis terisi dari nama (contoh: test@gembok.com)">
                            <small class="form-text text-muted">Email akan digunakan untuk notifikasi. Format otomatis: nama@gembok.com</small>
                        </div>
                        <div class="mb-3">
                            <label for="router_id" class="form-label">NAS (Router)</label>
                            <select class="form-select" id="router_id" name="router_id">
                                <option value="">- Pilih NAS -</option>
                                <% if (typeof routers !== 'undefined') { routers.forEach(function(r){ %>
                                    <option value="<%= r.id %>"><%= r.name %> (<%= r.nas_ip %>)</option>
                                <% }); } %>
                            </select>
                            <small class="form-text text-muted">Pilih router tempat pelanggan ini biasanya terkoneksi (untuk pelabelan & rekap per-router).</small>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="create_pppoe_user" name="create_pppoe_user" checked>
                            <label class="form-check-label" for="create_pppoe_user">
                                <strong>✓ Create Otomatis Username & PPPoE ke Mikrotik</strong>
                            </label>
                            <div class="form-text text-muted mt-1" id="auto_create_info">
                                <i class="bi bi-info-circle me-1"></i>
                                Sistem akan otomatis membuat user PPPoE di Mikrotik dengan:<br>
                                • Username: ID Pelanggan (format: yy-mm-dd hh:mm, contoh: 2512021009)<br>
                                • Password: Sama dengan Username<br>
                                • Profile: Sesuai paket yang dipilih<br>
                                • Comment: Nama pelanggan
                            </div>
                            <div class="form-text text-muted mt-1" id="manual_create_info" style="display:none;">
                                <i class="bi bi-info-circle me-1"></i>
                                Isi username dan password PPPoE secara manual. Sistem akan membuat user PPPoE di Mikrotik sesuai yang Anda isi.
                            </div>
                        </div>
                        
                        <!-- PPPoE Username & Password Fields (hidden saat auto-create aktif) -->
                        <div id="pppoe_manual_fields" style="display:none;">
                            <div class="mb-3">
                                <label for="pppoe_username" class="form-label">PPPoE Username (opsional)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pppoe_username" name="pppoe_username" placeholder="Ketik untuk mencari PPPoE username..." autocomplete="off">
                                    <button class="btn btn-outline-secondary" type="button" id="loadPppoeUsers" title="Load PPPoE users from Mikrotik">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div id="pppoe_dropdown" class="pppoe-dropdown" style="display: none;">
                                    <!-- Custom dropdown will be loaded here -->
                                </div>
                                <small class="form-text text-muted">Klik tombol refresh untuk mengambil daftar PPPoE users dari Mikrotik</small>
                            </div>
                            <div class="row g-2 align-items-end mb-3" id="pppoe_password_row">
                                <div class="col-8">
                                    <label for="pppoe_password" class="form-label">PPPoE Password</label>
                                    <input type="text" class="form-control" id="pppoe_password" name="pppoe_password" placeholder="Minimal 6 karakter">
                                    <small class="text-muted">Jika tidak diisi, sistem akan generate otomatis.</small>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-secondary w-100" type="button" id="genPppoePassBtn">Generate</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Static IP Configuration Section -->
                        <div class="card border-info mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-ethernet me-2"></i>Konfigurasi IP Statik (Opsional)</h6>
                                <small class="text-white">Untuk pelanggan yang menggunakan IP statik atau DHCP dengan MAC tetap</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="static_ip" class="form-label">Static IP Address</label>
                                            <input type="text" class="form-control" id="static_ip" name="static_ip" placeholder="192.168.1.100">
                                            <small class="text-muted">IP address tetap untuk pelanggan (format: 192.168.1.100)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="assigned_ip" class="form-label">Assigned IP Address</label>
                                            <input type="text" class="form-control" id="assigned_ip" name="assigned_ip" placeholder="192.168.1.100">
                                            <small class="text-muted">IP yang di-assign ke pelanggan (bisa sama dengan Static IP)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="mac_address" class="form-label">MAC Address</label>
                                    <input type="text" class="form-control" id="mac_address" name="mac_address" placeholder="00:11:22:33:44:55" pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                                    <small class="text-muted">MAC address perangkat untuk DHCP blocking (format: 00:11:22:33:44:55)</small>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Info Sistem Isolir:</strong><br>
                                    • Jika ada PPPoE Username: Sistem akan gunakan isolir profile<br>
                                    • Jika ada Static IP: Sistem akan gunakan method <strong><%= settings.static_ip_suspension_method || 'address_list' %></strong><br>
                                    • Jika ada MAC Address: Bisa gunakan DHCP blocking<br>
                                    • Priority: PPPoE → Static IP → DHCP
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cable Connection Section -->
                        <div class="card border-success mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bx bx-cable-car me-2"></i>Sambungkan Kabel (Opsional)</h6>
                                <small class="text-muted">Konfigurasi jalur kabel dari ODP ke pelanggan</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cable_type" class="form-label">Tipe Kabel</label>
                                            <select class="form-select" id="cable_type" name="cable_type">
                                                <option value="">Pilih Tipe Kabel</option>
                                                <option value="fiber">Fiber Optic</option>
                                                <option value="copper">Copper</option>
                                                <option value="wireless">Wireless</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cable_length" class="form-label">Panjang Kabel (meter)</label>
                                            <input type="number" class="form-control" id="cable_length" name="cable_length" placeholder="50" min="1">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="port_number" class="form-label">Nomor Port ODP</label>
                                            <input type="number" class="form-control" id="port_number" name="port_number" placeholder="1" min="1" max="24">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cable_status" class="form-label">Status Kabel</label>
                                            <select class="form-select" id="cable_status" name="cable_status">
                                                <option value="connected">Terhubung</option>
                                                <option value="disconnected">Terputus</option>
                                                <option value="maintenance">Maintenance</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="cable_notes" class="form-label">Catatan Kabel</label>
                                    <textarea class="form-control" id="cable_notes" name="cable_notes" rows="2" placeholder="Catatan khusus tentang instalasi kabel..."></textarea>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bx bx-info-circle me-2"></i>
                                    <strong>Info:</strong> Jika ODP sudah dipilih di atas, sistem akan otomatis membuat jalur kabel. Pastikan ODP memiliki kapasitas port yang tersedia.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Alamat</label>
                            <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="latitude" class="form-label">Latitude (Koordinat)</label>
                                    <input type="number" class="form-control" id="latitude" name="latitude" step="0.00000001" placeholder="-6.2088">
                                    <small class="text-muted">Contoh: -6.2088 (Jakarta)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="longitude" class="form-label">Longitude (Koordinat)</label>
                                    <input type="number" class="form-control" id="longitude" name="longitude" step="0.00000001" placeholder="106.8456">
                                    <small class="text-muted">Contoh: 106.8456 (Jakarta)</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                <button type="button" class="btn btn-success" onclick="getCurrentLocation()" id="gpsButton">
                                    <i class="bx bx-location-plus me-1"></i> <span class="btn-text">Ambil Lokasi GPS</span>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="openMapPicker()">
                                    <i class="bx bx-map me-1"></i> Pilih dari Peta
                                </button>
                            </div>
                            <small class="text-muted mt-1 d-block">
                                <i class="bi bi-info-circle me-1"></i>
                                GPS: Pastikan perangkat di area terbuka untuk akurasi terbaik
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="package_id" class="form-label">Paket *</label>
                            <select class="form-control" id="package_id" name="package_id" onchange="updateProfileField()" required>
                                <option value="">Pilih NAS terlebih dahulu</option>
                                <% if (packages && packages.length > 0) { %>
                                    <% packages.forEach(function(package) { %>
                                        <option value="<%= package.id %>" 
                                                data-profile="<%= package.pppoe_profile || 'default' %>"
                                                data-router-id="<%= package.router_id || '' %>"
                                                style="display: none;"><%= package.name %> - Rp <%= parseFloat(package.price).toLocaleString('id-ID') %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                            <small class="form-text text-muted">Pilih NAS terlebih dahulu untuk melihat paket yang tersedia.</small>
                        </div>
                        <div class="mb-3">
                            <label for="odp_id" class="form-label">ODP (Optical Distribution Point)</label>
                            <select class="form-control" id="odp_id" name="odp_id">
                                <option value="">Pilih ODP (Opsional)</option>
                                <% if (odps && odps.length > 0) { %>
                                    <% odps.forEach(function(odp) { %>
                                        <option value="<%= odp.id %>" data-capacity="<%= odp.capacity %>" data-used="<%= odp.used_ports %>">
                                            <% if (odp.parent_name) { %>
                                                └─ <%= odp.name %> (<%= odp.code %>) - <%= odp.used_ports %>/<%= odp.capacity %> ports
                                            <% } else { %>
                                                <%= odp.name %> (<%= odp.code %>) - <%= odp.used_ports %>/<%= odp.capacity %> ports
                                            <% } %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                            <small class="form-text text-muted">Pilih ODP tempat pelanggan akan disambungkan (opsional, bisa ditambahkan nanti). Sub ODP ditandai dengan └─</small>
                        </div>
                        <div class="mb-3">
                            <label for="pppoe_profile" class="form-label">PPPoE Profile</label>
                            <input type="text" class="form-control" id="pppoe_profile" name="pppoe_profile" placeholder="Profile akan otomatis terisi sesuai paket">
                            <small class="form-text text-muted">Profile PPPoE yang akan digunakan untuk pelanggan ini</small>
                        </div>
                        <div class="mb-3">
                            <label for="auto_suspension" class="form-label">Auto Suspension</label>
                            <select class="form-control" id="auto_suspension" name="auto_suspension">
                                <option value="1">Ya - Isolir otomatis saat telat bayar</option>
                                <option value="0">Tidak - Tidak diisolir otomatis</option>
                            </select>
                            <small class="form-text text-muted">Pilih apakah pelanggan akan diisolir otomatis saat telat bayar</small>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-control" id="status" name="status">
                                <option value="register">Register - Menunggu persetujuan admin</option>
                                <option value="active">Aktif</option>
                                <option value="suspended">Isolir</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                            <small class="form-text text-muted">Status pelanggan. Pilih "Register" untuk pelanggan baru yang menunggu persetujuan.</small>
                        </div>
                        <div class="mb-3">
                            <label for="billing_day" class="form-label">Tanggal Penagihan (1-28)</label>
                            <input type="number" class="form-control" id="billing_day" name="billing_day" min="1" max="28" value="15">
                            <small class="form-text text-muted">Tanggal jatuh tempo tagihan setiap bulan. Nilai di luar 28 akan disesuaikan.</small>
                        </div>
                        <div class="mb-3">
                            <label for="renewal_type" class="form-label">Tipe Pembaruan</label>
                            <select class="form-control" id="renewal_type" name="renewal_type">
                                <option value="renewal">Renewal - Tanggal jatuh tempo mengikuti tanggal pembayaran</option>
                                <option value="fix_date">Fix Date - Tanggal jatuh tempo tetap sesuai tanggal yang ditentukan</option>
                            </select>
                            <small class="form-text text-muted">Pilih cara perhitungan tanggal jatuh tempo untuk tagihan berikutnya</small>
                        </div>
                        <div class="mb-3" id="fix_date_container" style="display: none;">
                            <label for="fix_date" class="form-label">Tanggal Tetap (1-28)</label>
                            <input type="number" class="form-control" id="fix_date" name="fix_date" min="1" max="28" value="15">
                            <small class="form-text text-muted">Tanggal tetap untuk jatuh tempo jika memilih Fix Date. Hanya berlaku jika renewal_type = fix_date</small>
                        </div>
                        
                        <hr class="my-3">
                        <h6 class="mb-3"><i class="bi bi-images me-2"></i>Upload Dokumen</h6>
                        
                        <div class="mb-3">
                            <label for="add_ktp_photo" class="form-label">Upload Foto KTP</label>
                            <input type="file" class="form-control" id="add_ktp_photo" name="ktp_photo" accept="image/*">
                            <small class="form-text text-muted">Format: JPG, PNG, atau GIF. Maksimal 20MB</small>
                            <div id="add_ktp_preview" class="mt-2" style="display: none;">
                                <img id="add_ktp_preview_img" src="" alt="Preview KTP" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="add_house_photo" class="form-label">Upload Rumah Tampak Depan</label>
                            <input type="file" class="form-control" id="add_house_photo" name="house_photo" accept="image/*">
                            <small class="form-text text-muted">Format: JPG, PNG, atau GIF. Maksimal 20MB</small>
                            <div id="add_house_preview" class="mt-2" style="display: none;">
                                <img id="add_house_preview_img" src="" alt="Preview Rumah" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pelanggan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editCustomerForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit_name" class="form-label">Nama *</label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="edit_username" name="username" required placeholder="username untuk login dan payment gateway">
                            <small class="form-text text-muted">Username akan digunakan untuk login pelanggan dan payment gateway. Harus unik dan tanpa spasi.</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Telepon *</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone" required>
                            <small class="form-text text-muted">Pastikan nomor telepon unik dan benar</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email" placeholder="customer@example.com">
                        </div>
                        <div class="mb-3">
                            <label for="edit_pppoe_username" class="form-label">PPPoE Username</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="edit_pppoe_username" name="pppoe_username" autocomplete="off" placeholder="Ketik untuk mencari PPPoE username...">
                                <button class="btn btn-outline-secondary" type="button" id="loadEditPppoeUsers" title="Load PPPoE users from Mikrotik">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div id="edit_pppoe_dropdown" class="pppoe-dropdown" style="display: none;">
                                <!-- Custom dropdown will be loaded here -->
                            </div>
                            <small class="form-text text-muted">Klik tombol refresh untuk mengambil daftar PPPoE users dari Mikrotik</small>
                        </div>
                        
                        <!-- Static IP Configuration Section for Edit -->
                        <div class="card border-info mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-ethernet me-2"></i>Konfigurasi IP Statik (Opsional)</h6>
                                <small class="text-white">Untuk pelanggan yang menggunakan IP statik atau DHCP dengan MAC tetap</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_static_ip" class="form-label">Static IP Address</label>
                                            <input type="text" class="form-control" id="edit_static_ip" name="static_ip" placeholder="192.168.1.100">
                                            <small class="text-muted">IP address tetap untuk pelanggan (format: 192.168.1.100)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_assigned_ip" class="form-label">Assigned IP Address</label>
                                            <input type="text" class="form-control" id="edit_assigned_ip" name="assigned_ip" placeholder="192.168.1.100">
                                            <small class="text-muted">IP yang di-assign ke pelanggan (bisa sama dengan Static IP)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_mac_address" class="form-label">MAC Address</label>
                                    <input type="text" class="form-control" id="edit_mac_address" name="mac_address" placeholder="00:11:22:33:44:55" pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                                    <small class="text-muted">MAC address perangkat untuk DHCP blocking (format: 00:11:22:33:44:55)</small>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Info Sistem Isolir:</strong><br>
                                    • Jika ada PPPoE Username: Sistem akan gunakan isolir profile<br>
                                    • Jika ada Static IP: Sistem akan gunakan method <strong><%= settings.static_ip_suspension_method || 'address_list' %></strong><br>
                                    • Jika ada MAC Address: Bisa gunakan DHCP blocking<br>
                                    • Priority: PPPoE → Static IP → DHCP
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit_address" class="form-label">Alamat</label>
                            <textarea class="form-control" id="edit_address" name="address" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_latitude" class="form-label">Latitude (Koordinat)</label>
                                    <input type="number" class="form-control" id="edit_latitude" name="latitude" step="0.00000001" placeholder="-6.2088">
                                    <small class="text-muted">Contoh: -6.2088 (Jakarta)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_longitude" class="form-label">Longitude (Koordinat)</label>
                                    <input type="number" class="form-control" id="edit_longitude" name="longitude" step="0.00000001" placeholder="106.8456">
                                    <small class="text-muted">Contoh: 106.8456 (Jakarta)</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                <button type="button" class="btn btn-success" onclick="getCurrentLocation()" id="editGpsButton">
                                    <i class="bx bx-location-plus me-1"></i> <span class="btn-text">Ambil Lokasi GPS</span>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="openMapPicker()">
                                    <i class="bx bx-map me-1"></i> Pilih dari Peta
                                </button>
                            </div>
                            <small class="text-muted mt-1 d-block">
                                <i class="bi bi-info-circle me-1"></i>
                                GPS: Pastikan perangkat di area terbuka untuk akurasi terbaik
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_package_id" class="form-label">Paket *</label>
                            <select class="form-control" id="edit_package_id" name="package_id" onchange="updateEditProfileField()" required>
                                <option value="">Pilih NAS terlebih dahulu</option>
                                <% if (packages && packages.length > 0) { %>
                                    <% packages.forEach(function(package) { %>
                                        <option value="<%= package.id %>" 
                                                data-profile="<%= package.pppoe_profile || 'default' %>"
                                                data-router-id="<%= package.router_id || '' %>"
                                                style="display: none;"><%= package.name %> - Rp <%= parseFloat(package.price).toLocaleString('id-ID') %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                            <small class="form-text text-muted">Pilih NAS terlebih dahulu untuk melihat paket yang tersedia.</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_odp_id" class="form-label">ODP (Optical Distribution Point)</label>
                            <select class="form-control" id="edit_odp_id" name="odp_id">
                                <option value="">Pilih ODP (Opsional)</option>
                                <% if (odps && odps.length > 0) { %>
                                    <% odps.forEach(function(odp) { %>
                                        <option value="<%= odp.id %>" data-capacity="<%= odp.capacity %>" data-used="<%= odp.used_ports %>">
                                            <% if (odp.parent_name) { %>
                                                └─ <%= odp.name %> (<%= odp.code %>) - <%= odp.used_ports %>/<%= odp.capacity %> ports
                                            <% } else { %>
                                                <%= odp.name %> (<%= odp.code %>) - <%= odp.used_ports %>/<%= odp.capacity %> ports
                                            <% } %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                            <small class="form-text text-muted">Pilih ODP tempat pelanggan akan disambungkan (opsional). Sub ODP ditandai dengan └─</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_pppoe_profile" class="form-label">PPPoE Profile</label>
                            <input type="text" class="form-control" id="edit_pppoe_profile" name="pppoe_profile" placeholder="Profile akan otomatis terisi sesuai paket">
                            <small class="form-text text-muted">Profile PPPoE yang akan digunakan untuk pelanggan ini</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_router_id" class="form-label">NAS (Router)</label>
                            <select class="form-control" id="edit_router_id" name="router_id">
                                <option value="">- Pilih NAS -</option>
                                <% if (typeof routers !== 'undefined') { routers.forEach(function(r){ %>
                                    <option value="<%= r.id %>"><%= r.name %> (<%= r.nas_ip %>)</option>
                                <% }); } %>
                            </select>
                            <small class="form-text text-muted">Pilih router tempat pelanggan ini terhubung untuk operasi isolir/restore.</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_auto_suspension" class="form-label">Auto Suspension</label>
                            <select class="form-control" id="edit_auto_suspension" name="auto_suspension">
                                <option value="1">Ya - Isolir otomatis saat telat bayar</option>
                                <option value="0">Tidak - Tidak diisolir otomatis</option>
                            </select>
                            <small class="form-text text-muted">Pilih apakah pelanggan akan diisolir otomatis saat telat bayar</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_billing_day" class="form-label">Tanggal Penagihan (1-28)</label>
                            <input type="number" class="form-control" id="edit_billing_day" name="billing_day" min="1" max="28" value="15">
                            <small class="form-text text-muted">Tanggal jatuh tempo tagihan setiap bulan. Nilai di luar 28 akan disesuaikan.</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_renewal_type" class="form-label">Tipe Pembaruan</label>
                            <select class="form-control" id="edit_renewal_type" name="renewal_type">
                                <option value="renewal">Renewal - Tanggal jatuh tempo mengikuti tanggal pembayaran</option>
                                <option value="fix_date">Fix Date - Tanggal jatuh tempo tetap sesuai tanggal yang ditentukan</option>
                            </select>
                            <small class="form-text text-muted">Pilih cara perhitungan tanggal jatuh tempo untuk tagihan berikutnya</small>
                        </div>
                        <div class="mb-3" id="edit_fix_date_container" style="display: none;">
                            <label for="edit_fix_date" class="form-label">Tanggal Tetap (1-28)</label>
                            <input type="number" class="form-control" id="edit_fix_date" name="fix_date" min="1" max="28" value="15">
                            <small class="form-text text-muted">Tanggal tetap untuk jatuh tempo jika memilih Fix Date. Hanya berlaku jika renewal_type = fix_date</small>
                        </div>
                        
                        <hr class="my-3">
                        <h6 class="mb-3"><i class="bi bi-images me-2"></i>Upload Dokumen</h6>
                        
                        <div class="mb-3">
                            <label for="edit_ktp_photo" class="form-label">Upload Foto KTP</label>
                            <input type="file" class="form-control" id="edit_ktp_photo" name="ktp_photo" accept="image/*">
                            <small class="form-text text-muted">Format: JPG, PNG, atau GIF. Maksimal 20MB. Kosongkan jika tidak ingin mengubah.</small>
                            <div id="edit_ktp_preview" class="mt-2" style="display: none;">
                                <img id="edit_ktp_preview_img" src="" alt="Preview KTP" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                            </div>
                            <div id="edit_ktp_current" class="mt-2" style="display: none;">
                                <small class="text-muted">Foto KTP saat ini:</small>
                                <img id="edit_ktp_current_img" src="" alt="Foto KTP Saat Ini" class="img-thumbnail d-block mt-1" style="max-width: 200px; max-height: 200px;">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit_house_photo" class="form-label">Upload Rumah Tampak Depan</label>
                            <input type="file" class="form-control" id="edit_house_photo" name="house_photo" accept="image/*">
                            <small class="form-text text-muted">Format: JPG, PNG, atau GIF. Maksimal 20MB. Kosongkan jika tidak ingin mengubah.</small>
                            <div id="edit_house_preview" class="mt-2" style="display: none;">
                                <img id="edit_house_preview_img" src="" alt="Preview Rumah" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                            </div>
                            <div id="edit_house_current" class="mt-2" style="display: none;">
                                <small class="text-muted">Foto Rumah saat ini:</small>
                                <img id="edit_house_current_img" src="" alt="Foto Rumah Saat Ini" class="img-thumbnail d-block mt-1" style="max-width: 200px; max-height: 200px;">
                            </div>
                        </div>
                        
                        <!-- Cable Connection Section for Edit -->
                        <div class="card border-success mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bx bx-cable-car me-2"></i>Sambungkan Kabel (Opsional)</h6>
                                <small class="text-muted">Konfigurasi jalur kabel dari ODP ke pelanggan</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_cable_type" class="form-label">Tipe Kabel</label>
                                            <select class="form-select" id="edit_cable_type" name="cable_type">
                                                <option value="">Pilih Tipe Kabel</option>
                                                <option value="fiber">Fiber Optic</option>
                                                <option value="copper">Copper</option>
                                                <option value="wireless">Wireless</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_cable_length" class="form-label">Panjang Kabel (meter)</label>
                                            <input type="number" class="form-control" id="edit_cable_length" name="cable_length" placeholder="50" min="1">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_port_number" class="form-label">Nomor Port ODP</label>
                                            <input type="number" class="form-control" id="edit_port_number" name="port_number" placeholder="1" min="1" max="24">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="edit_cable_status" class="form-label">Status Kabel</label>
                                            <select class="form-select" id="edit_cable_status" name="cable_status">
                                                <option value="connected">Terhubung</option>
                                                <option value="disconnected">Terputus</option>
                                                <option value="maintenance">Maintenance</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_cable_notes" class="form-label">Catatan Kabel</label>
                                    <textarea class="form-control" id="edit_cable_notes" name="cable_notes" rows="2" placeholder="Catatan khusus tentang instalasi kabel..."></textarea>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bx bx-info-circle me-2"></i>
                                    <strong>Info:</strong> Jika ODP sudah dipilih di atas, sistem akan otomatis membuat jalur kabel. Pastikan ODP memiliki kapasitas port yang tersedia.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit_status" class="form-label">Status</label>
                            <select class="form-control" id="edit_status" name="status">
                                <option value="register">Register - Menunggu persetujuan admin</option>
                                <option value="active">Aktif</option>
                                <option value="suspended">Isolir</option>
                                <option value="inactive">Nonaktif</option>
                            </select>
                            <small class="form-text text-muted">Catatan: Jika status saat ini adalah "Register", status akan tetap "Register" setelah update. Gunakan tombol "Accept Pelanggan" untuk mengaktifkan.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Customers Modal -->
    <div class="modal fade" id="importCustomersModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Restore Data Pelanggan (Import)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="importCustomersForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Pilih File (JSON atau XLSX)</label>
                            <input type="file" id="customersFile" name="file" accept="application/json,.json,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx" class="form-control" required>
                            <small class="form-text text-muted">Dukungan: JSON (disarankan) atau Excel XLSX. JSON bisa berupa array atau { customers: [...] }.</small>
                        </div>
                        <div class="alert alert-info" role="alert">
                            Catatan: Data dengan nomor telepon yang sama akan diupdate. Data baru akan dibuat otomatis.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-cloud-upload"></i> Import
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- WhatsApp Notification Modal -->
    <div class="modal fade" id="whatsappModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bx bxl-whatsapp text-success"></i> Kirim Notifikasi WhatsApp
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bx bx-info-circle"></i>
                        <strong>Informasi:</strong> Notifikasi akan dikirim ke nomor WhatsApp pelanggan.
                    </div>
                    <div id="whatsappStatus" class="alert alert-warning" style="display: none;">
                        <i class="bx bx-wifi-off"></i>
                        <strong>Peringatan:</strong> WhatsApp belum terhubung. Silakan coba lagi nanti.
                    </div>
                    <div id="notificationPreview">
                        <!-- Preview pesan akan ditampilkan di sini -->
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Nomor WhatsApp:</label>
                        <input type="text" class="form-control" id="waPhoneNumber" readonly>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Nama Pelanggan:</label>
                        <input type="text" class="form-control" id="waCustomerName" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-success" id="confirmSendWA">
                        <i class="bx bxl-whatsapp"></i> Kirim Notifikasi
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modern Notification Modal -->
    <div id="notificationModal" class="notification-overlay">
        <div class="notification-card">
            <div class="notification-icon" id="notificationIcon">
                <i class="bi" id="notificationIconClass"></i>
            </div>
            <div class="notification-title" id="notificationTitle"></div>
            <div class="notification-message" id="notificationMessage"></div>
            <div id="notificationButtons">
                <button class="notification-button" id="notificationButton" onclick="closeNotification()"></button>
                <button class="notification-button notification-button-secondary" id="notificationButtonCancel" onclick="closeNotification()" style="display: none; margin-left: 10px;"></button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Modern Notification Function (popup besar di tengah)
        function showNotification(type, title, message, buttonText, callback) {
            const modal = document.getElementById('notificationModal');
            const icon = document.getElementById('notificationIcon');
            const iconClass = document.getElementById('notificationIconClass');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const button = document.getElementById('notificationButton');
            const buttonCancel = document.getElementById('notificationButtonCancel');

            // Sembunyikan tombol cancel untuk notifikasi biasa
            buttonCancel.style.display = 'none';

            // Set icon
            icon.className = 'notification-icon ' + type;
            if (type === 'success') {
                iconClass.className = 'bi bi-check-circle-fill';
            } else if (type === 'error') {
                iconClass.className = 'bi bi-x-circle-fill';
            } else if (type === 'warning') {
                iconClass.className = 'bi bi-exclamation-triangle-fill';
            } else {
                iconClass.className = 'bi bi-info-circle-fill';
            }

            // Set konten
            titleEl.textContent = title;
            messageEl.innerHTML = message;
            button.textContent = buttonText;
            button.className = 'notification-button ' + type;

            // Tampilkan modal
            modal.classList.add('show');

            // Handler tombol
            button.onclick = function() {
                closeNotification();
                if (callback && typeof callback === 'function') {
                    callback();
                }
            };

            // Auto close jika tidak ada callback
            if (!callback) {
                setTimeout(function() {
                    closeNotification();
                }, 5000);
            }
        }

        // Confirm Notification Function (with 2 buttons)
        function showConfirmNotification(type, title, message, confirmText, cancelText, confirmCallback) {
            const modal = document.getElementById('notificationModal');
            const icon = document.getElementById('notificationIcon');
            const iconClass = document.getElementById('notificationIconClass');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const button = document.getElementById('notificationButton');
            const buttonCancel = document.getElementById('notificationButtonCancel');
            
            // Tampilkan kedua tombol untuk konfirmasi
            buttonCancel.style.display = 'inline-block';
            
            // Set icon
            icon.className = 'notification-icon ' + type;
            if (type === 'success') {
                iconClass.className = 'bi bi-check-circle-fill';
            } else if (type === 'error') {
                iconClass.className = 'bi bi-x-circle-fill';
            } else if (type === 'warning') {
                iconClass.className = 'bi bi-exclamation-triangle-fill';
            } else {
                iconClass.className = 'bi bi-info-circle-fill';
            }
            
            // Set konten
            titleEl.textContent = title;
            messageEl.innerHTML = message;
            button.textContent = confirmText;
            button.className = 'notification-button ' + type;
            buttonCancel.textContent = cancelText;
            
            // Tampilkan modal
            modal.classList.add('show');
            
            // Handler tombol
            button.onclick = function() {
                closeNotification();
                if (confirmCallback && typeof confirmCallback === 'function') {
                    confirmCallback();
                }
            };
            
            buttonCancel.onclick = function() {
                closeNotification();
            };
        }

        function closeNotification() {
            const modal = document.getElementById('notificationModal');
            modal.classList.remove('show');
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('notificationModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeNotification();
                    }
                });
            }
        });
    
        $(document).ready(function() {
            const dt = $('#customersTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/id.json',
                    emptyTable: "Tidak ada data yang tersedia",
                    info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                    infoEmpty: "Menampilkan 0 sampai 0 dari 0 entri",
                    infoFiltered: "(disaring dari _MAX_ entri keseluruhan)",
                    lengthMenu: "Tampilkan _MENU_ entri",
                    loadingRecords: "Sedang memuat...",
                    processing: "Sedang memproses...",
                    search: "Cari:",
                    zeroRecords: "Tidak ditemukan data yang sesuai",
                    paginate: {
                        first: "Pertama",
                        last: "Terakhir",
                        next: "Selanjutnya",
                        previous: "Sebelumnya"
                    }
                },
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
            });
            
            // Function to filter packages based on selected NAS (router_id)
            window.filterPackagesByNAS = function(routerSelectId, packageSelectId) {
                const routerSelect = document.getElementById(routerSelectId);
                const packageSelect = document.getElementById(packageSelectId);
                
                if (!routerSelect || !packageSelect) return;
                
                const selectedRouterId = routerSelect.value;
                const allPackageOptions = packageSelect.querySelectorAll('option[data-router-id]');
                const currentSelectedValue = packageSelect.value;
                
                console.log('🔍 Filtering packages for router:', selectedRouterId || 'none');
                
                // Hide all package options first
                allPackageOptions.forEach(opt => {
                    opt.style.display = 'none';
                });
                
                // Show only packages that match selected router_id or have no router_id (null/empty)
                let visibleCount = 0;
                allPackageOptions.forEach(opt => {
                    const packageRouterId = opt.getAttribute('data-router-id');
                    // Show if: router not selected, OR package has no router_id, OR package router_id matches selected
                    if (!selectedRouterId || !packageRouterId || packageRouterId === selectedRouterId) {
                        opt.style.display = '';
                        visibleCount++;
                        console.log('  ✓ Showing package:', opt.textContent, 'router_id:', packageRouterId || 'none');
                    } else {
                        console.log('  ✗ Hiding package:', opt.textContent, 'router_id:', packageRouterId);
                    }
                });
                
                console.log('📦 Total visible packages:', visibleCount);
                
                // Update first option text
                const firstOption = packageSelect.querySelector('option[value=""]');
                if (firstOption) {
                    if (!selectedRouterId) {
                        firstOption.textContent = 'Pilih NAS terlebih dahulu';
                    } else if (visibleCount === 0) {
                        firstOption.textContent = 'Tidak ada paket untuk NAS ini';
                    } else {
                        firstOption.textContent = 'Pilih Paket';
                    }
                }
                
                // Reset selection if current selection is not visible
                if (currentSelectedValue) {
                    const currentOption = packageSelect.querySelector(`option[value="${currentSelectedValue}"]`);
                    if (currentOption && currentOption.style.display === 'none') {
                        packageSelect.value = '';
                        console.log('⚠️ Current package selection is not available for this NAS, reset to empty');
                    }
                }
            }
            
            // Event listeners for NAS selection changes (Add Customer form)
            $('#router_id').on('change', function() {
                filterPackagesByNAS('router_id', 'package_id');
            });
            
            // Event listeners for NAS selection changes (Edit Customer form)
            $('#edit_router_id').on('change', function() {
                filterPackagesByNAS('edit_router_id', 'edit_package_id');
            });
            
            // Initialize package dropdowns when modals are shown
            $('#addCustomerModal').on('shown.bs.modal', function() {
                // Reset NAS selection and filter packages
                $('#router_id').val('');
                filterPackagesByNAS('router_id', 'package_id');
            });
            
            $('#editCustomerModal').on('shown.bs.modal', function() {
                // Filter packages based on current NAS selection (if any)
                const currentRouterId = $('#edit_router_id').val();
                if (currentRouterId) {
                    filterPackagesByNAS('edit_router_id', 'edit_package_id');
                }
            });

            // Update bulk delete button state
            function updateBulkState() {
                const anyChecked = $('.customer-checkbox:checked').length > 0;
                $('#bulkDeleteBtn').prop('disabled', !anyChecked);
                const total = $('.customer-checkbox').length;
                const checked = $('.customer-checkbox:checked').length;
                const selectAll = document.getElementById('selectAllCustomers');
                selectAll.indeterminate = checked > 0 && checked < total;
                selectAll.checked = checked > 0 && checked === total;
            }

            // Select all handler
            $('#selectAllCustomers').on('change', function() {
                const checked = this.checked;
                $('.customer-checkbox').prop('checked', checked);
                updateBulkState();
            });

            // Row checkbox handler
            $(document).on('change', '.customer-checkbox', updateBulkState);

            // Re-bind after table draw (pagination/search)
            dt.on('draw', function() {
                updateBulkState();
            });

            // Bulk delete click
            $('#bulkDeleteBtn').on('click', function() {
                const phones = $('.customer-checkbox:checked').map(function(){ return this.value; }).get();
                if (phones.length === 0) return;
                
                showConfirmNotification('warning', 'Konfirmasi!', 
                    `Yakin ingin menghapus ${phones.length} pelanggan terpilih?`, 
                    'Hapus', 'Batal', 
                    function() {
                        const btn = $('#bulkDeleteBtn');
                        const original = btn.html();
                        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menghapus...');

                        fetch('/admin/billing/customers/bulk-delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phones })
                        })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                const s = data.summary || {}; 
                                const successCount = s.success || 0;
                                const failedCount = s.failed || 0;
                                showToast('success', 'Hapus Massal Selesai', `Berhasil menghapus ${successCount} pelanggan.${failedCount > 0 ? ` Gagal menghapus ${failedCount} pelanggan.` : ''}`);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showToast('error', 'Gagal Hapus Massal', data.message || 'Terjadi kesalahan saat menghapus pelanggan terpilih');
                                btn.prop('disabled', false).html(original);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            showToast('error', 'Error Hapus Massal', 'Terjadi kesalahan saat menghapus pelanggan. Silakan coba lagi atau hubungi administrator.');
                            btn.prop('disabled', false).html(original);
                        });
                    }
                );
            });
            
            // Reset form when modal is hidden
            $('#addCustomerModal').on('hidden.bs.modal', function() {
                $('#addCustomerForm')[0].reset();
                $('#status').val('register'); // Set default status to register
                $('#add_ktp_preview').hide();
                $('#add_house_preview').hide();
            });
            
            $('#editCustomerModal').on('hidden.bs.modal', function() {
                $('#editCustomerForm')[0].reset();
                $('#edit_ktp_preview').hide();
                $('#edit_house_preview').hide();
                $('#edit_ktp_current').hide();
                $('#edit_house_current').hide();
            });
            
            // Preview image for Add Customer Form
            $('#add_ktp_photo').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (20MB = 20 * 1024 * 1024 bytes)
                    if (file.size > 20 * 1024 * 1024) {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        showToast('error', 'Ukuran File Terlalu Besar', `File Foto KTP yang dipilih berukuran ${fileSizeMB} MB. Maksimal ukuran file adalah 20 MB.`);
                        $(this).val('');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#add_ktp_preview_img').attr('src', e.target.result);
                        $('#add_ktp_preview').show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#add_ktp_preview').hide();
                }
            });
            
            $('#add_house_photo').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (20MB = 20 * 1024 * 1024 bytes)
                    if (file.size > 20 * 1024 * 1024) {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        showToast('error', 'Ukuran File Terlalu Besar', `File Foto Rumah yang dipilih berukuran ${fileSizeMB} MB. Maksimal ukuran file adalah 20 MB.`);
                        $(this).val('');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#add_house_preview_img').attr('src', e.target.result);
                        $('#add_house_preview').show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#add_house_preview').hide();
                }
            });
            
            // Preview image for Edit Customer Form
            $('#edit_ktp_photo').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (20MB = 20 * 1024 * 1024 bytes)
                    if (file.size > 20 * 1024 * 1024) {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        showToast('error', 'Ukuran File Terlalu Besar', `File Foto KTP yang dipilih berukuran ${fileSizeMB} MB. Maksimal ukuran file adalah 20 MB.`);
                        $(this).val('');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#edit_ktp_preview_img').attr('src', e.target.result);
                        $('#edit_ktp_preview').show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#edit_ktp_preview').hide();
                }
            });
            
            $('#edit_house_photo').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (20MB = 20 * 1024 * 1024 bytes)
                    if (file.size > 20 * 1024 * 1024) {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        showToast('error', 'Ukuran File Terlalu Besar', `File Foto Rumah yang dipilih berukuran ${fileSizeMB} MB. Maksimal ukuran file adalah 20 MB.`);
                        $(this).val('');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#edit_house_preview_img').attr('src', e.target.result);
                        $('#edit_house_preview').show();
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#edit_house_preview').hide();
                }
            });

            // Export customers JSON (Desktop & Mobile)
            $('#exportCustomersJsonBtn, #exportCustomersJsonBtnMobile').on('click', function() {
                window.location.href = '/admin/billing/export/customers.json';
            });

            // Export customers XLSX (Desktop & Mobile)
            $('#exportCustomersXlsxBtn, #exportCustomersXlsxBtnMobile').on('click', function() {
                window.location.href = '/admin/billing/export/customers.xlsx';
            });

            // Import customers JSON
            $('#importCustomersForm').on('submit', function(e) {
                e.preventDefault();
                const fileInput = document.getElementById('customersFile');
                if (!fileInput.files || fileInput.files.length === 0) {
                    showToast('error', 'File Tidak Dipilih', 'Silakan pilih file JSON atau XLSX terlebih dahulu sebelum melakukan import.');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Mengunggah...');

                const isXlsx = /\.xlsx$/i.test(fileInput.files[0].name);
                const url = isXlsx ? '/admin/billing/import/customers/xlsx' : '/admin/billing/import/customers/json';
                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const s = data.summary || {};
                        const created = s.created || 0;
                        const updated = s.updated || 0;
                        const failed = s.failed || 0;
                        showToast('success', 'Import Data Berhasil', `Import selesai: ${created} pelanggan dibuat, ${updated} pelanggan diupdate.${failed > 0 ? ` ${failed} pelanggan gagal diimport.` : ''}`);
                        $('#importCustomersModal').modal('hide');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        const errorMsg = data.message || 'Gagal import data pelanggan';
                        const errorDetails = data.error || '';
                        showToast('error', 'Gagal Import Data', errorDetails ? `${errorMsg}<br><small>${errorDetails}</small>` : errorMsg);
                    }
                })
                .catch(err => {
                    console.error(err);
                    const errorMsg = err.message || 'Terjadi kesalahan saat import data pelanggan';
                    showToast('error', 'Error Import Data', `${errorMsg}. Pastikan file yang dipilih valid dan coba lagi.`);
                    showToast('error', 'Terjadi kesalahan saat import');
                })
                .finally(() => {
                    submitBtn.prop('disabled', false).html(originalText);
                });
            });
        });

        // Test function to manually set credentials
        function testGenerateCredentials() {
            const nameField = document.getElementById('name');
            const usernameField = document.getElementById('username');
            const emailField = document.getElementById('email');
            
            if (nameField && usernameField && emailField) {
                const testValue = "jajaltest";
                usernameField.value = testValue + "_280825";
                emailField.value = testValue + "@gembok.com";
                console.log("Manually set test values");
            }
        }

        // Final clean function to generate both username and email from name
        function generateCredentialsFromName() {
            try {
                const nameField = document.getElementById('name');
                const usernameField = document.getElementById('username');
                const emailField = document.getElementById('email');
                
                // Only proceed if name field has value
                if (nameField && nameField.value) {
                    const fullName = nameField.value;
                    
                    // Generate username if field is empty
                    if (usernameField && !usernameField.value) {
                        // Process character by character for username
                        let cleanUsername = '';
                        for (let i = 0; i < fullName.length && i < 15; i++) {
                            const char = fullName[i].toLowerCase();
                            if (char >= 'a' && char <= 'z') {
                                cleanUsername += char;
                            } else if (char >= '0' && char <= '9') {
                                cleanUsername += char;
                            } else if (char === ' ') {
                                cleanUsername += '_';
                            } else if (char === '_' && cleanUsername.length > 0 && cleanUsername[cleanUsername.length - 1] !== '_') {
                                cleanUsername += char;
                            }
                            // Skip all other characters
                        }
                        
                        // Remove trailing underscores
                        cleanUsername = cleanUsername.replace(/_+$/, '');
                        
                        // If result is empty, use default
                        if (!cleanUsername) {
                            cleanUsername = 'user';
                        }
                        
                        // Add date
                        const now = new Date();
                        const dateStr = String(now.getDate()).padStart(2, '0') + 
                                       String(now.getMonth() + 1).padStart(2, '0') + 
                                       String(now.getFullYear()).slice(-2);
                        const finalUsername = cleanUsername + '_' + dateStr;
                        
                        usernameField.value = finalUsername;
                    }
                    
                    // Generate email if field is empty
                    if (emailField && !emailField.value) {
                        // Process character by character for email
                        let cleanEmail = '';
                        for (let i = 0; i < fullName.length && i < 30; i++) {
                            const char = fullName[i].toLowerCase();
                            if (char >= 'a' && char <= 'z') {
                                cleanEmail += char;
                            } else if (char >= '0' && char <= '9') {
                                cleanEmail += char;
                            } else if (char === ' ') {
                                cleanEmail += '.';
                            } else if (char === '.' && cleanEmail.length > 0 && cleanEmail[cleanEmail.length - 1] !== '.') {
                                cleanEmail += char;
                            }
                            // Skip all other characters
                        }
                        
                        // Remove trailing dots
                        cleanEmail = cleanEmail.replace(/\.+$/, '');
                        
                        // If result is empty, use default
                        if (!cleanEmail) {
                            cleanEmail = 'user';
                        }
                        
                        const finalEmail = cleanEmail + '@gembok.com';
                        emailField.value = finalEmail;
                    }
                }
            } catch (error) {
                console.error('Error in generateCredentialsFromName:', error);
            }
        }

        function generateUsernameFromName() {
            generateCredentialsFromName();
        }
        
        function generateEmailFromName() {
            generateCredentialsFromName();
        }

        // Debug function to test name value retrieval
        function debugNameValue() {
            const nameField = document.getElementById('name');
            if (nameField) {
                console.log('=== DEBUG NAME VALUE ===');
                console.log('Raw value:', '"' + nameField.value + '"');
                console.log('Length:', nameField.value.length);
                console.log('Trimmed:', '"' + nameField.value.trim() + '"');
                console.log('Char codes:', Array.from(nameField.value).map(c => c.charCodeAt(0)));
                console.log('========================');
            }
        }

        // Function to update profile field when package is selected
        function updateProfileField() {
            const packageSelect = document.getElementById('package_id');
            const profileInput = document.getElementById('pppoe_profile');
            const selectedOption = packageSelect.options[packageSelect.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.profile) {
                profileInput.value = selectedOption.dataset.profile;
            }
        }

        // Function to update profile field in edit modal
        function updateEditProfileField() {
            const packageSelect = document.getElementById('edit_package_id');
            const profileInput = document.getElementById('edit_pppoe_profile');
            const selectedOption = packageSelect.options[packageSelect.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.profile) {
                profileInput.value = selectedOption.dataset.profile;
            }
        }

        // Global variables for PPPoE users
        let pppoeUsers = [];
        let filteredPppoeUsers = [];
        
        // Load PPPoE users from Mikrotik
        function loadPppoeUsers() {
            const loadBtn = $('#loadPppoeUsers');
            const originalIcon = loadBtn.html();
            
            // Show loading state
            loadBtn.prop('disabled', true).html('<i class="bi bi-arrow-clockwise spin"></i>');
            
            console.log('🔄 Loading PPPoE users from Mikrotik...');
            
            fetch('/admin/billing/api/pppoe-users')
                .then(response => {
                    console.log('📡 API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 API Response data:', data);
                    
                    if (data.success && data.data && data.data.length > 0) {
                        pppoeUsers = data.data;
                        filteredPppoeUsers = [...pppoeUsers];
                        
                        console.log(`📝 Loaded ${pppoeUsers.length} users to memory`);
                        showToast('success', 'PPPoE Users Dimuat', `Berhasil memuat ${pppoeUsers.length} user PPPoE dari Mikrotik.`);
                    } else {
                        console.warn('⚠️ No data from API, using test data');
                        loadTestPppoeUsers();
                    }
                })
                .catch(error => {
                    console.error('❌ Fetch Error:', error);
                    console.warn('⚠️ API Error, using test data');
                    loadTestPppoeUsers();
                })
                .finally(() => {
                    // Restore button state
                    loadBtn.prop('disabled', false).html(originalIcon);
                });
        }
        
        // Load test PPPoE users for testing
        function loadTestPppoeUsers() {
            const testUsers = [
                { username: 'test1@gembok.com', profile: 'default', active: true },
                { username: 'test2@gembok.com', profile: 'premium', active: false },
                { username: 'test3@gembok.com', profile: 'basic', active: true },
                { username: 'admin@gembok.com', profile: 'admin', active: true },
                { username: 'user1@gembok.com', profile: 'default', active: false }
            ];
            
            pppoeUsers = testUsers;
            filteredPppoeUsers = [...pppoeUsers];
            
            console.log('🧪 Loading test PPPoE users...');
            showToast('info', 'Mode Test PPPoE', `Menggunakan ${testUsers.length} user PPPoE test (API Mikrotik tidak tersedia).`);
            console.log('🧪 Test users loaded:', pppoeUsers.length);
        }
        
        // Show custom dropdown
        function showPppoeDropdown(inputId, dropdownId) {
            console.log(`🔍 showPppoeDropdown called: ${inputId}, ${dropdownId}`);
            
            const input = $(`#${inputId}`);
            const dropdown = $(`#${dropdownId}`);
            const searchTerm = input.val().toLowerCase();
            
            console.log(`📋 Input element found:`, input.length);
            console.log(`📋 Dropdown element found:`, dropdown.length);
            console.log(`📋 Search term:`, searchTerm);
            console.log(`📋 PPPoE users available:`, pppoeUsers.length);
            
            // Filter users based on search term
            filteredPppoeUsers = pppoeUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm)
            );
            
            console.log(`📋 Filtered users:`, filteredPppoeUsers.length);
            
            // Clear dropdown
            dropdown.empty();
            
            if (filteredPppoeUsers.length === 0) {
                dropdown.html('<div class="pppoe-dropdown-no-results">Tidak ada PPPoE user yang cocok</div>');
                console.log('📋 No results message added');
            } else {
                // Show max 10 results
                const displayUsers = filteredPppoeUsers.slice(0, 10);
                console.log(`📋 Displaying ${displayUsers.length} users`);
                
                displayUsers.forEach((user, index) => {
                    const item = $(`
                        <div class="pppoe-dropdown-item" data-username="${user.username}" data-active="${user.active}">
                            <span class="username">${user.username}</span>
                            <div>
                                <span class="status ${user.active ? 'active' : 'inactive'}">${user.active ? 'Aktif' : 'Tidak Aktif'}</span>
                            </div>
                        </div>
                    `);
                    
                    dropdown.append(item);
                    if (index < 3) { // Log first 3 for debugging
                        console.log(`✅ Added item ${index}: ${user.username} (${user.active ? 'active' : 'inactive'})`);
                    }
                });
            }
            
            // Calculate position relative to input
            const inputOffset = input.offset();
            const inputHeight = input.outerHeight();
            
            // Position dropdown below input
            dropdown.css({
                'position': 'fixed',
                'top': (inputOffset.top + inputHeight + 5) + 'px',
                'left': inputOffset.left + 'px',
                'width': input.outerWidth() + 'px',
                'display': 'block',
                'z-index': '99999',
                'background': 'white',
                'border': '2px solid #007bff',
                'box-shadow': '0 4px 12px rgba(0,0,0,0.3)'
            });
            
            // Show dropdown
            dropdown.addClass('show');
            
            console.log(`📋 Dropdown positioned at:`, {
                top: inputOffset.top + inputHeight + 5,
                left: inputOffset.left,
                width: input.outerWidth()
            });
            console.log(`📋 Dropdown shown, visible:`, dropdown.is(':visible'));
            console.log(`📋 Dropdown height:`, dropdown.height());
            console.log(`📋 Dropdown items count:`, dropdown.find('.pppoe-dropdown-item').length);
        }
        
        // Hide custom dropdown
        function hidePppoeDropdown(dropdownId) {
            const dropdown = $(`#${dropdownId}`);
            dropdown.removeClass('show').css('display', 'none');
            console.log(`📋 Dropdown hidden: ${dropdownId}`);
        }
        
        // Handle dropdown item selection
        function selectPppoeUser(inputId, dropdownId) {
            const input = $(`#${inputId}`);
            const username = input.data('selected-username');
            const isActive = input.data('selected-active');
            
            if (username) {
                // Show status indicator
                if (isActive) {
                    input.addClass('border-success').removeClass('border-warning');
                } else {
                    input.addClass('border-warning').removeClass('border-success');
                }
                
                console.log(`✅ Selected PPPoE user: ${username} (active: ${isActive})`);
            }
        }
        
        // Load PPPoE users button click
        $('#loadPppoeUsers').on('click', function() {
            loadPppoeUsers();
        });
        
        // Auto-load PPPoE users when modal opens
        $('#addCustomerModal').on('shown.bs.modal', function() {
            console.log('🔄 Add customer modal opened, loading PPPoE users...');
            loadPppoeUsers();
        });
        
        // Load PPPoE users for edit form
        function loadEditPppoeUsers() {
            const loadBtn = $('#loadEditPppoeUsers');
            const originalIcon = loadBtn.html();
            
            // Show loading state
            loadBtn.prop('disabled', true).html('<i class="bi bi-arrow-clockwise spin"></i>');
            
            console.log('🔄 Loading PPPoE users for edit form...');
            
            fetch('/admin/billing/api/pppoe-users')
                .then(response => {
                    console.log('📡 Edit API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Edit API Response data:', data);
                    
                    if (data.success && data.data && data.data.length > 0) {
                        pppoeUsers = data.data;
                        filteredPppoeUsers = [...pppoeUsers];
                        
                        console.log(`📝 Loaded ${pppoeUsers.length} users to memory for edit`);
                        showToast('success', 'PPPoE Users Dimuat', `Berhasil memuat ${pppoeUsers.length} user PPPoE dari Mikrotik.`);
                    } else {
                        console.warn('⚠️ No data from API, using test data for edit');
                        loadTestEditPppoeUsers();
                    }
                })
                .catch(error => {
                    console.error('❌ Edit Fetch Error:', error);
                    console.warn('⚠️ API Error, using test data for edit');
                    loadTestEditPppoeUsers();
                })
                .finally(() => {
                    // Restore button state
                    loadBtn.prop('disabled', false).html(originalIcon);
                });
        }
        
        // Load test PPPoE users for edit form
        function loadTestEditPppoeUsers() {
            const testUsers = [
                { username: 'test1@gembok.com', profile: 'default', active: true },
                { username: 'test2@gembok.com', profile: 'premium', active: false },
                { username: 'test3@gembok.com', profile: 'basic', active: true },
                { username: 'admin@gembok.com', profile: 'admin', active: true },
                { username: 'user1@gembok.com', profile: 'default', active: false }
            ];
            
            pppoeUsers = testUsers;
            filteredPppoeUsers = [...pppoeUsers];
            
            console.log('🧪 Loading test PPPoE users for edit...');
            showToast('info', 'Mode Test PPPoE', `Menggunakan ${testUsers.length} user PPPoE test untuk edit (API Mikrotik tidak tersedia).`);
            console.log('🧪 Test edit users loaded:', pppoeUsers.length);
        }
        
        // Test function for edit form (can be called from console)
        window.testEditForm = function() {
            console.log('🧪 Testing edit form...');
            
            // Test 1: Check if elements exist
            console.log('📋 Edit PPPoE username field exists:', $('#edit_pppoe_username').length);
            console.log('📋 Edit PPPoE profile field exists:', $('#edit_pppoe_profile').length);
            console.log('📋 Edit dropdown exists:', $('#edit_pppoe_dropdown').length);
            
            // Test 2: Load test data
            loadTestEditPppoeUsers();
            
            // Test 3: Test dropdown
            setTimeout(() => {
                console.log('🧪 Testing dropdown...');
                $('#edit_pppoe_username').val('test1@gembok.com').trigger('input');
                console.log('📋 Username should be filled with: test1@gembok.com');
            }, 1000);
        };
        
        // Test custom dropdown functionality
        window.testDropdown = function() {
            console.log('🧪 Testing custom dropdown functionality...');
            
            // Test 1: Check users loaded
            console.log('📋 PPPoE users loaded:', pppoeUsers.length);
            console.log('📋 Filtered users:', filteredPppoeUsers.length);
            
            // Test 2: Check first few users
            pppoeUsers.slice(0, 3).forEach((user, i) => {
                console.log(`User ${i}:`, user.username, user.active);
            });
            
            // Test 3: Test input focus
            $('#edit_pppoe_username').focus();
            console.log('📋 Input focused, check if dropdown appears');
            
            // Test 4: Test typing
            $('#edit_pppoe_username').val('aang').trigger('input');
            console.log('📋 Typed "aang", check if suggestions appear');
        };
        
        // Test add form dropdown functionality
        window.testAddForm = function() {
            console.log('🧪 Testing add form dropdown functionality...');
            
            // Test 1: Check users loaded
            console.log('📋 PPPoE users loaded:', pppoeUsers.length);
            console.log('📋 Filtered users:', filteredPppoeUsers.length);
            
            // Test 2: Check first few users
            pppoeUsers.slice(0, 3).forEach((user, i) => {
                console.log(`User ${i}:`, user.username, user.active);
            });
            
            // Test 3: Check elements
            console.log('📋 Input element exists:', $('#pppoe_username').length);
            console.log('📋 Dropdown element exists:', $('#pppoe_dropdown').length);
            console.log('📋 Input group exists:', $('.input-group').length);
            
            // Test 4: Test input focus
            $('#pppoe_username').focus();
            console.log('📋 Add form input focused, check if dropdown appears');
            
            // Test 5: Test typing
            $('#pppoe_username').val('aang').trigger('input');
            console.log('📋 Add form typed "aang", check if suggestions appear');
            
            // Test 6: Manual show dropdown
            console.log('📋 Manually showing dropdown...');
            showPppoeDropdown('pppoe_username', 'pppoe_dropdown');
        };
        
        // Test dropdown visibility
        window.testDropdownVisibility = function() {
            console.log('🧪 Testing dropdown visibility...');
            
            const dropdown = $('#pppoe_dropdown');
            console.log('📋 Dropdown element:', dropdown.length);
            console.log('📋 Dropdown visible:', dropdown.is(':visible'));
            console.log('📋 Dropdown display:', dropdown.css('display'));
            console.log('📋 Dropdown classes:', dropdown.attr('class'));
            console.log('📋 Dropdown height:', dropdown.height());
            console.log('📋 Dropdown width:', dropdown.width());
            console.log('📋 Dropdown position:', dropdown.position());
            console.log('📋 Dropdown offset:', dropdown.offset());
        };
        
        // Force show dropdown for debugging
        window.forceShowDropdown = function() {
            console.log('🧪 Force showing dropdown...');
            
            const dropdown = $('#pppoe_dropdown');
            const input = $('#pppoe_username');
            
            // Add some test content
            dropdown.html(`
                <div class="pppoe-dropdown-item" style="background: yellow; padding: 10px;">
                    <strong>TEST DROPDOWN - SHOULD BE VISIBLE</strong>
                </div>
                <div class="pppoe-dropdown-item" style="background: lightgreen; padding: 10px;">
                    <span class="username">test-user-1</span>
                    <span class="status active">Aktif</span>
                </div>
                <div class="pppoe-dropdown-item" style="background: lightblue; padding: 10px;">
                    <span class="username">test-user-2</span>
                    <span class="status inactive">Tidak Aktif</span>
                </div>
            `);
            
            // Calculate position
            const inputOffset = input.offset();
            const inputHeight = input.outerHeight();
            
            // Force show with fixed positioning
            dropdown.css({
                'position': 'fixed',
                'top': (inputOffset.top + inputHeight + 5) + 'px',
                'left': inputOffset.left + 'px',
                'width': input.outerWidth() + 'px',
                'display': 'block',
                'z-index': '99999',
                'background': 'red',
                'border': '5px solid blue',
                'height': '200px'
            });
            
            console.log('📋 Dropdown forced visible with test content');
            console.log('📋 Position:', {
                top: inputOffset.top + inputHeight + 5,
                left: inputOffset.left,
                width: input.outerWidth()
            });
            console.log('📋 Check if you can see a red box with blue border below the input field');
        };
        
        // Load PPPoE users button click for edit form
        $('#loadEditPppoeUsers').on('click', function() {
            loadEditPppoeUsers();
        });
        
        // Auto-load PPPoE users when edit modal opens
        $('#editCustomerModal').on('shown.bs.modal', function() {
            console.log('🔄 Edit modal opened, loading PPPoE users...');
            loadEditPppoeUsers();
        });
        
        // Edit Customer Form - PPPoE Username Input Events
        $('#edit_pppoe_username').on('input focus', function() {
            if (pppoeUsers.length > 0) {
                showPppoeDropdown('edit_pppoe_username', 'edit_pppoe_dropdown');
            }
        });
        
        $('#edit_pppoe_username').on('blur', function() {
            // Delay hide to allow click on dropdown items
            setTimeout(() => {
                hidePppoeDropdown('edit_pppoe_dropdown');
            }, 200);
        });
        
        // Edit Customer Form - Dropdown Item Click
        $(document).on('click', '#edit_pppoe_dropdown .pppoe-dropdown-item', function() {
            const username = $(this).data('username');
            const isActive = $(this).data('active');
            
            // Set input value
            $('#edit_pppoe_username').val(username);
            
            // Store selection data
            $('#edit_pppoe_username').data('selected-username', username);
            $('#edit_pppoe_username').data('selected-active', isActive);
            
            // Show status indicator
            if (isActive) {
                $('#edit_pppoe_username').addClass('border-success').removeClass('border-warning');
            } else {
                $('#edit_pppoe_username').addClass('border-warning').removeClass('border-success');
            }
            
            // Hide dropdown
            hidePppoeDropdown('edit_pppoe_dropdown');
            
            console.log(`✅ Selected edit PPPoE user: ${username} (active: ${isActive})`);
        });
        
        // Add Customer Form - PPPoE Username Input Events
        $('#pppoe_username').on('input focus', function() {
            console.log('🔍 Add form PPPoE username input/focus triggered');
            console.log('📋 PPPoE users available:', pppoeUsers.length);
            
            if (pppoeUsers.length > 0) {
                console.log('✅ Showing dropdown for add form');
                showPppoeDropdown('pppoe_username', 'pppoe_dropdown');
            } else {
                console.log('❌ No PPPoE users available, loading data...');
                loadPppoeUsers();
            }
        });
        
        $('#pppoe_username').on('blur', function() {
            // Delay hide to allow click on dropdown items
            setTimeout(() => {
                hidePppoeDropdown('pppoe_dropdown');
            }, 200);
        });
        
        // Add Customer Form - Dropdown Item Click
        $(document).on('click', '#pppoe_dropdown .pppoe-dropdown-item', function() {
            const username = $(this).data('username');
            const isActive = $(this).data('active');
            
            // Set input value
            $('#pppoe_username').val(username);
            
            // Store selection data
            $('#pppoe_username').data('selected-username', username);
            $('#pppoe_username').data('selected-active', isActive);
            
            // Show status indicator
            if (isActive) {
                $('#pppoe_username').addClass('border-success').removeClass('border-warning');
            } else {
                $('#pppoe_username').addClass('border-warning').removeClass('border-success');
            }
            
            // Hide dropdown
            hidePppoeDropdown('pppoe_dropdown');
            
            console.log(`✅ Selected PPPoE user: ${username} (active: ${isActive})`);
        });

        // Add Customer Form
        $('#addCustomerForm').on('submit', function(e) {
            e.preventDefault();
            
            // Client-side validation
            const name = $('#name').val().trim();
            const username = $('#username').val().trim();
            const phone = $('#phone').val().trim();
            const package_id = $('#package_id').val();
            const createPppoe = $('#create_pppoe_user').is(':checked');
            const pppoeUser = $('#pppoe_username').val().trim();
            const pppoePassword = $('#pppoe_password').val().trim();
            
            if (!name || !username || !phone || !package_id) {
                const missingFields = [];
                if (!name) missingFields.push('Nama');
                if (!username) missingFields.push('Username');
                if (!phone) missingFields.push('Telepon');
                if (!package_id) missingFields.push('Paket');
                showToast('error', 'Field Wajib Belum Diisi', `Silakan lengkapi field berikut: ${missingFields.join(', ')}`);
                return;
            }
            
            // Validate username format
            if (!/^[a-z0-9_]+$/.test(username)) {
                showToast('error', 'Format Username Tidak Valid', 'Username hanya boleh berisi huruf kecil, angka, dan underscore (tanpa spasi atau karakter khusus).');
                return;
            }
            
            // Validasi berdasarkan mode
            if (createPppoe) {
                // Auto-create mode: tidak perlu validasi pppoeUser (akan di-generate dari customer_id)
                console.log('[FORM] Auto-create mode: System will auto-generate username from customer_id');
            } else {
                // Manual mode: wajib isi pppoe_username
                if (!pppoeUser) {
                    showToast('error', 'PPPoE Username Belum Diisi', 'Jika mode manual, silakan isi field PPPoE Username terlebih dahulu.');
                    return;
                }
                console.log('[FORM] Manual mode: Using provided PPPoE username:', pppoeUser);
            }
            
            // Show loading state
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('Menyimpan...');
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('name', name);
            formData.append('username', username);
            formData.append('phone', phone);
            formData.append('email', $('#email').val().trim());
            // Jika auto-create mode, kosongkan pppoe_username (akan di-generate dari customer_id)
            // Jika manual mode, gunakan yang diisi user
            if (createPppoe) {
                formData.append('pppoe_username', ''); // Kosongkan, akan di-generate otomatis
            } else {
                formData.append('pppoe_username', pppoeUser); // Gunakan yang diisi manual
            }
            formData.append('address', $('#address').val().trim());
            formData.append('package_id', package_id);
            formData.append('odp_id', $('#odp_id').val() || '');
            formData.append('pppoe_profile', $('#pppoe_profile').val().trim() || 'default');
            formData.append('auto_suspension', $('#auto_suspension').val());
            formData.append('status', $('#status').val() || 'register');
            formData.append('create_pppoe_user', createPppoe ? 1 : 0);
            // Password: jika auto-create akan sama dengan username (customer_id), jika manual gunakan yang diisi
            formData.append('pppoe_password', createPppoe ? '' : pppoePassword);
            formData.append('billing_day', (function() {
                const v = parseInt($('#billing_day').val(), 10);
                if (Number.isFinite(v)) return Math.min(Math.max(v, 1), 28);
                return 15;
            })());
            formData.append('renewal_type', $('#renewal_type').val());
            formData.append('fix_date', $('#renewal_type').val() === 'fix_date' ? (function() {
                const v = parseInt($('#fix_date').val(), 10);
                if (Number.isFinite(v)) return Math.min(Math.max(v, 1), 28);
                return 15;
            })() : '');
            formData.append('latitude', $('#latitude').val().trim());
            formData.append('longitude', $('#longitude').val().trim());
            formData.append('static_ip', $('#static_ip').val().trim());
            formData.append('assigned_ip', $('#assigned_ip').val().trim());
            formData.append('mac_address', $('#mac_address').val().trim());
            formData.append('cable_type', $('#cable_type').val().trim());
            formData.append('cable_length', $('#cable_length').val() ? parseInt($('#cable_length').val()) : '');
            formData.append('port_number', $('#port_number').val() ? parseInt($('#port_number').val()) : '');
            formData.append('cable_status', $('#cable_status').val().trim() || 'connected');
            formData.append('cable_notes', $('#cable_notes').val().trim());
            formData.append('router_id', $('#router_id').val() || '');
            
            // Append photo files if selected
            const ktpPhoto = $('#add_ktp_photo')[0].files[0];
            const housePhoto = $('#add_house_photo')[0].files[0];
            if (ktpPhoto) {
                formData.append('ktp_photo', ktpPhoto);
            }
            if (housePhoto) {
                formData.append('house_photo', housePhoto);
            }
            
            fetch('/admin/billing/customers', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw err;
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    setTimeout(() => {
                        const customerName = name || 'Pelanggan baru';
                        let successMessage = `Pelanggan "${customerName}" berhasil ditambahkan ke sistem.`;
                        if (data.pppoeCreate) {
                            if (data.pppoeCreate.created) {
                                const pppoeUsername = data.customer?.pppoe_username || data.customer?.customer_id || 'N/A';
                                successMessage += `\n✅ User PPPoE berhasil dibuat di Mikrotik (Username: ${pppoeUsername})`;
                            } else if (data.pppoeCreate.attempted) {
                                successMessage += `\n⚠️ Gagal membuat user PPPoE: ${data.pppoeCreate.message || 'Unknown error'}`;
                            }
                        }
                        showToast('success', 'Pelanggan Berhasil Ditambahkan', successMessage);
                        setTimeout(() => location.reload(), 1500);
                    }, 300);
                } else {
                    // Tampilkan error message dengan details jika ada
                    const errorMsg = data.message || 'Gagal menambahkan pelanggan';
                    const errorDetails = data.details || data.error || '';
                    showToast('error', 'Gagal Menambahkan Pelanggan', errorDetails ? `${errorMsg}<br><small>${errorDetails}</small>` : errorMsg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error response dengan details
                const errorMessage = error.message || 'Terjadi kesalahan saat menambahkan pelanggan';
                const errorDetails = error.details || '';
                showToast('error', 'Error Menambahkan Pelanggan', errorDetails ? `${errorMessage}<br><small>${errorDetails}</small>` : errorMessage);
            })
            .finally(() => {
                submitBtn.prop('disabled', false).text(originalText);
            });
        });

        // Toggle PPPoE password row visibility
        // Handle checkbox create_pppoe_user change - show/hide manual fields
        function togglePppoeFields() {
            const isChecked = $('#create_pppoe_user').is(':checked');
            if (isChecked) {
                // Auto-create mode: hide manual fields
                $('#pppoe_manual_fields').hide();
                $('#auto_create_info').show();
                $('#manual_create_info').hide();
                // Clear manual input values
                $('#pppoe_username').val('');
                $('#pppoe_password').val('');
                console.log('[FORM] Auto-create mode: Manual fields hidden');
            } else {
                // Manual mode: show manual fields
                $('#pppoe_manual_fields').show();
                $('#auto_create_info').hide();
                $('#manual_create_info').show();
                console.log('[FORM] Manual mode: Manual fields shown');
            }
        }
        
        // Bind change event
        $('#create_pppoe_user').on('change', togglePppoeFields);
        
        // Initialize on page load and when modal opens
        $(document).ready(function() {
            togglePppoeFields();
        });
        
        // Also initialize when modal is shown
        $('#addCustomerModal').on('shown.bs.modal', function() {
            togglePppoeFields();
        });

        // Generate password button
        $('#genPppoePassBtn').on('click', function(){
            const pass = Math.random().toString(36).slice(-8) + Math.floor(Math.random()*10);
            $('#pppoe_password').val(pass);
        });

        // Edit Customer
        function editCustomer(phone) {
            fetch(`/admin/billing/api/customers/${phone}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const customer = data.customer;
                        $('#edit_name').val(customer.name);
                        $('#edit_username').val(customer.username || '');
                        $('#edit_phone').val(customer.phone).data('original-phone', customer.phone);
                        $('#edit_email').val(customer.email || '');
                        $('#edit_pppoe_username').val(customer.pppoe_username || '');
                        $('#edit_address').val(customer.address || '');
                        $('#edit_latitude').val(customer.latitude || '');
                        $('#edit_longitude').val(customer.longitude || '');
                        $('#edit_odp_id').val(customer.odp_id || '');
                        $('#edit_pppoe_profile').val(customer.pppoe_profile || '');
                        
                        // Set router_id first, then filter packages, then set package_id
                        if ($('#edit_router_id').length) { 
                            $('#edit_router_id').val(customer.router_id || ''); 
                            // Filter packages based on router_id after setting it
                            setTimeout(() => {
                                if (typeof filterPackagesByNAS === 'function') {
                                    filterPackagesByNAS('edit_router_id', 'edit_package_id');
                                }
                                // Set package_id after filtering
                                $('#edit_package_id').val(customer.package_id || '');
                            }, 100);
                        } else {
                            $('#edit_package_id').val(customer.package_id || '');
                        }
                        $('#edit_auto_suspension').val(customer.auto_suspension !== undefined ? customer.auto_suspension : 1);
                        $('#edit_status').val(customer.status);
                        $('#edit_billing_day').val((function(){
                            const v = parseInt(customer.billing_day, 10);
                            if (Number.isFinite(v)) return Math.min(Math.max(v, 1), 28);
                            return 15;
                        })());
                        $('#edit_renewal_type').val(customer.renewal_type || 'renewal');
                        $('#edit_fix_date').val(customer.fix_date || 15);
                        
                        // Show/hide fix_date container based on renewal_type
                        if (customer.renewal_type === 'fix_date') {
                            $('#edit_fix_date_container').show();
                        } else {
                            $('#edit_fix_date_container').hide();
                        }
                        // Fill static IP fields
                        $('#edit_static_ip').val(customer.static_ip || '');
                        $('#edit_assigned_ip').val(customer.assigned_ip || '');
                        $('#edit_mac_address').val(customer.mac_address || '');
                        // Fill cable connection fields
                        $('#edit_cable_type').val(customer.cable_type || '');
                        $('#edit_cable_length').val(customer.cable_length || '');
                        $('#edit_port_number').val(customer.port_number || '');
                        $('#edit_cable_status').val(customer.cable_status || 'connected');
                        $('#edit_cable_notes').val(customer.cable_notes || '');
                        
                        // Show current photos if available
                        if (customer.ktp_photo_path) {
                            $('#edit_ktp_current_img').attr('src', customer.ktp_photo_path);
                            $('#edit_ktp_current').show();
                        } else {
                            $('#edit_ktp_current').hide();
                        }
                        if (customer.house_photo_path) {
                            $('#edit_house_current_img').attr('src', customer.house_photo_path);
                            $('#edit_house_current').show();
                        } else {
                            $('#edit_house_current').hide();
                        }
                        
                        $('#editCustomerModal').modal('show');
                    } else {
                        showToast('error', 'Gagal Memuat Data Pelanggan', data.message || 'Tidak dapat mengambil data pelanggan. Silakan coba lagi.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Error Memuat Data', 'Terjadi kesalahan saat memuat data pelanggan. Pastikan koneksi internet stabil dan coba lagi.');
                });
        }

        // Update Customer Form
        $('#editCustomerForm').on('submit', function(e) {
            e.preventDefault();
            
            // Helper aman untuk ambil nilai
            const safeVal = (sel) => {
                const $el = $(sel);
                if (!$el.length) return '';
                const v = $el.val();
                return (v == null ? '' : String(v)).trim();
            };
            const safeInt = (sel) => {
                const $el = $(sel);
                if (!$el.length) return null;
                const v = parseInt($el.val(), 10);
                return Number.isFinite(v) ? v : null;
            };
            
            // Client-side validation
            const name = safeVal('#edit_name');
            const username = safeVal('#edit_username');
            const phone = safeVal('#edit_phone');
            const package_id = $('#edit_package_id').val();
            
            if (!name || !username || !phone || !package_id) {
                const missingFields = [];
                if (!name) missingFields.push('Nama');
                if (!username) missingFields.push('Username');
                if (!phone) missingFields.push('Telepon');
                if (!package_id) missingFields.push('Paket');
                showToast('error', 'Field Wajib Belum Diisi', `Silakan lengkapi field berikut: ${missingFields.join(', ')}`);
                return;
            }
            
            // Validate username format
            if (!/^[a-z0-9_]+$/.test(username)) {
                showToast('error', 'Format Username Tidak Valid', 'Username hanya boleh berisi huruf kecil, angka, dan underscore (tanpa spasi atau karakter khusus).');
                return;
            }
            
            // Show loading state
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('Mengupdate...');
            
            const originalPhone = $('#edit_phone').data('original-phone'); // Store original phone for API call
            const currentStatus = $('#edit_status').length ? $('#edit_status').val() : '';
            const status = currentStatus;
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('name', name);
            formData.append('username', username);
            formData.append('phone', phone);
            formData.append('email', safeVal('#edit_email'));
            formData.append('pppoe_username', safeVal('#edit_pppoe_username'));
            formData.append('address', safeVal('#edit_address'));
            // Ensure package_id is always sent (required field)
            if (!package_id) {
                console.error('Package ID is missing!', {
                    package_id,
                    selectElement: $('#edit_package_id').length,
                    selectValue: $('#edit_package_id').val(),
                    selectOptions: $('#edit_package_id option').length,
                    selectedOption: $('#edit_package_id option:selected').text()
                });
                showToast('error', 'Paket harus dipilih! Silakan pilih paket dari dropdown.');
                submitBtn.prop('disabled', false).text(originalText);
                return;
            }
            formData.append('package_id', package_id.toString());
            formData.append('odp_id', $('#edit_odp_id').length ? ($('#edit_odp_id').val() || '') : '');
            formData.append('pppoe_profile', safeVal('#edit_pppoe_profile') || 'default');
            formData.append('auto_suspension', $('#edit_auto_suspension').length ? $('#edit_auto_suspension').val() : '');
            formData.append('status', $('#edit_status').length ? $('#edit_status').val() : '');
            formData.append('billing_day', (function() {
                const v = parseInt($('#edit_billing_day').val(), 10);
                if (Number.isFinite(v)) return Math.min(Math.max(v, 1), 28);
                return 15;
            })());
            formData.append('renewal_type', $('#edit_renewal_type').val());
            formData.append('fix_date', $('#edit_renewal_type').val() === 'fix_date' ? (function() {
                const v = parseInt($('#edit_fix_date').val(), 10);
                if (Number.isFinite(v)) return Math.min(Math.max(v, 1), 28);
                return 15;
            })() : '');
            formData.append('router_id', $('#edit_router_id').length ? ($('#edit_router_id').val() || '') : '');
            formData.append('latitude', safeVal('#edit_latitude'));
            formData.append('longitude', safeVal('#edit_longitude'));
            formData.append('static_ip', safeVal('#edit_static_ip'));
            formData.append('assigned_ip', safeVal('#edit_assigned_ip'));
            formData.append('mac_address', safeVal('#edit_mac_address'));
            formData.append('cable_type', safeVal('#edit_cable_type'));
            formData.append('cable_length', safeInt('#edit_cable_length') || '');
            formData.append('port_number', safeInt('#edit_port_number') || '');
            formData.append('cable_status', safeVal('#edit_cable_status') || 'connected');
            formData.append('cable_notes', safeVal('#edit_cable_notes'));
            
            // Append photo files if selected
            const ktpPhoto = $('#edit_ktp_photo')[0].files[0];
            const housePhoto = $('#edit_house_photo')[0].files[0];
            if (ktpPhoto) {
                formData.append('ktp_photo', ktpPhoto);
            }
            if (housePhoto) {
                formData.append('house_photo', housePhoto);
            }
            
            fetch(`/admin/billing/customers/${originalPhone || phone}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw err;
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    setTimeout(() => {
                        const customerName = name || 'Pelanggan';
                        let message = `Data pelanggan "${customerName}" berhasil diperbarui.`;
                        if (currentStatus === 'register' && status && status.toLowerCase() !== 'register') {
                            message += '<br><small class="text-warning"><i class="bi bi-info-circle"></i> Status tetap \"Register\" karena hanya bisa diubah melalui tombol Accept.</small>';
                        }
                        // Tampilkan pop up sukses besar
                        showNotification('success', 'Success!', message, 'Continue', function() {
                            location.reload();
                        });
                    }, 300);
                } else {
                    const errorMsg = data.message || 'Gagal mengupdate pelanggan';
                    const errorDetails = data.error || '';
                    const msg = errorDetails ? `${errorMsg}<br><small>${errorDetails}</small>` : errorMsg;
                    showNotification('error', 'Error!', msg, 'Try again');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle error response dengan details
                const errorMessage = error.message || 'Terjadi kesalahan saat mengupdate pelanggan';
                const errorDetails = error.details || error.error || '';
                const msg = errorDetails ? `${errorMessage}<br><small>${errorDetails}</small>` : errorMessage;
                showNotification('error', 'Error!', msg, 'Try again');
            })
            .finally(() => {
                submitBtn.prop('disabled', false).text(originalText);
            });
        });

        // View customer detail
        function viewCustomerDetail(phone) {
            // Navigate to customer detail page
            window.location.href = `/admin/billing/customers/${phone}`;
        }

        // Delete customer
        async function deleteCustomer(phone) {
            showConfirmNotification('warning', 'Konfirmasi!', 
                'Apakah Anda yakin ingin menghapus pelanggan ini?', 
                'Hapus', 'Batal', 
                async function() {
                    try {
                        const response = await fetch(`/admin/billing/customers/${phone}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            showToast('success', 'Pelanggan Berhasil Dihapus', result.message || 'Data pelanggan berhasil dihapus dari sistem.');
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            showToast('error', 'Gagal Menghapus Pelanggan', result.message || 'Tidak dapat menghapus pelanggan. Pastikan tidak ada tagihan yang masih aktif.');
                        }
                    } catch (error) {
                        showToast('error', 'Error Menghapus Pelanggan', 'Terjadi kesalahan saat menghapus data pelanggan. Silakan coba lagi atau hubungi administrator.');
                    }
                }
            );
        }

        // Get current location using GPS with improved permission handling
        async function getCurrentLocation() {
            // Find the GPS button that was clicked
            const gpsButton = document.getElementById('gpsButton') || document.getElementById('editGpsButton');
            const originalButtonHtml = gpsButton ? gpsButton.innerHTML : '';
            
            // Update button to show loading state
            if (gpsButton) {
                gpsButton.disabled = true;
                gpsButton.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i> <span class="btn-text">Mengambil Lokasi...</span>';
                gpsButton.className = 'btn btn-warning';
            }
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showToast('error', 'Geolocation Tidak Didukung', 'Browser Anda tidak mendukung fitur geolocation. Silakan gunakan input manual untuk memasukkan koordinat.');
                showLocationHelp();
                resetGPSButton(gpsButton, originalButtonHtml);
                return;
            }

            // Check permission first (modern browsers)
            if ('permissions' in navigator) {
                try {
                    const permission = await navigator.permissions.query({name: 'geolocation'});
                    
                    if (permission.state === 'denied') {
                        showLocationPermissionDeniedDialog();
                        resetGPSButton(gpsButton, originalButtonHtml);
                        return;
                    }
                    
                    if (permission.state === 'prompt') {
                        showLocationPermissionPromptDialog();
                    }
                } catch (error) {
                    console.log('Permission API not supported, continuing with geolocation request');
                }
            }

            // Show loading state
            showToast('info', 'Mengambil Lokasi GPS', 'Sedang mengambil koordinat dari GPS. Pastikan izin lokasi sudah diberikan.');
            
            // Request location with enhanced options
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Update form fields
                    $('#latitude').val(lat.toFixed(8));
                    $('#longitude').val(lng.toFixed(8));
                    
                    // Update edit form if open
                    if ($('#edit_latitude').length) {
                        $('#edit_latitude').val(lat.toFixed(8));
                        $('#edit_longitude').val(lng.toFixed(8));
                    }
                    
                    let message = 'Lokasi berhasil diambil dari GPS!';
                    if (accuracy > 100) {
                        message += ` (Akurasi: ${Math.round(accuracy)}m - coba di area terbuka untuk akurasi lebih baik)`;
                    } else {
                        message += ` (Akurasi: ${Math.round(accuracy)}m)`;
                    }
                    
                    const accuracyMsg = accuracy > 100 ? ` (Akurasi: ${Math.round(accuracy)}m - coba di area terbuka untuk akurasi lebih baik)` : ` (Akurasi: ${Math.round(accuracy)}m)`;
                    showToast('success', 'Lokasi GPS Berhasil Diambil', `Koordinat berhasil diambil dari GPS.${accuracyMsg}`);
                    
                    // Update button to show success state briefly
                    if (gpsButton) {
                        gpsButton.className = 'btn btn-success';
                        gpsButton.innerHTML = '<i class="bx bx-check me-1"></i> <span class="btn-text">Lokasi Berhasil!</span>';
                        
                        setTimeout(() => {
                            resetGPSButton(gpsButton, originalButtonHtml);
                        }, 2000);
                    }
                },
                function(error) {
                    handleLocationError(error);
                    resetGPSButton(gpsButton, originalButtonHtml);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000, // Increased timeout
                    maximumAge: 60000
                }
            );
        }
        
        // Reset GPS button to original state
        function resetGPSButton(button, originalHtml) {
            if (button && originalHtml) {
                button.disabled = false;
                button.className = 'btn btn-success';
                button.innerHTML = originalHtml;
            }
        }

        // Handle location errors with detailed guidance
        function handleLocationError(error) {
            let errorMessage = 'Gagal mengambil lokasi: ';
            let showHelp = false;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Izin lokasi ditolak';
                    showLocationPermissionDeniedDialog();
                    return;
                    
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Sinyal GPS tidak tersedia. Pastikan Anda berada di area terbuka.';
                    showHelp = true;
                    break;
                    
                case error.TIMEOUT:
                    errorMessage += 'Timeout mengambil lokasi. Coba lagi atau pindah ke area dengan sinyal GPS lebih baik.';
                    showHelp = true;
                    break;
                    
                default:
                    errorMessage += 'Error tidak diketahui. Coba lagi atau gunakan input manual.';
                    showHelp = true;
            }
            
            showToast(errorMessage, 'error');
            
            if (showHelp) {
                setTimeout(() => showLocationHelp(), 2000);
            }
        }

        // Show dialog when permission is denied
        function showLocationPermissionDeniedDialog() {
            const modalHtml = `
                <div class="modal fade" id="locationPermissionModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="bi bi-geo-alt-fill me-2"></i>Izin Lokasi Ditolak
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Untuk menggunakan fitur GPS, ikuti langkah berikut:</strong>
                                </div>
                                
                                <div class="accordion" id="locationHelpAccordion">
                                    <!-- Chrome/Android -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#chromeHelp">
                                                <i class="bi bi-google me-2"></i>Chrome / Android
                                            </button>
                                        </h2>
                                        <div id="chromeHelp" class="accordion-collapse collapse show">
                                            <div class="accordion-body">
                                                <ol>
                                                    <li>Klik ikon <strong>🔒</strong> di sebelah kiri URL</li>
                                                    <li>Pilih <strong>"Izinkan"</strong> untuk Lokasi</li>
                                                    <li>Refresh halaman dan coba lagi</li>
                                                    <li>Atau masuk ke <strong>Pengaturan > Situs > Izin > Lokasi</strong></li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Safari/iOS -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#safariHelp">
                                                <i class="bi bi-phone me-2"></i>Safari / iPhone
                                            </button>
                                        </h2>
                                        <div id="safariHelp" class="accordion-collapse collapse">
                                            <div class="accordion-body">
                                                <ol>
                                                    <li>Buka <strong>Pengaturan iPhone</strong></li>
                                                    <li>Scroll ke <strong>Safari</strong></li>
                                                    <li>Pilih <strong>Lokasi</strong></li>
                                                    <li>Pilih <strong>"Tanya" atau "Izinkan"</strong></li>
                                                    <li>Kembali ke browser dan refresh halaman</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <strong>Alternatif:</strong>
                                    <ul>
                                        <li>Gunakan <strong>"Pilih dari Peta"</strong> untuk memilih lokasi manual</li>
                                        <li>Input koordinat langsung jika Anda mengetahuinya</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                                <button type="button" class="btn btn-primary" onclick="openMapPicker(); $('#locationPermissionModal').modal('hide');">Pilih dari Peta</button>
                                <button type="button" class="btn btn-success" onclick="location.reload()">Coba Lagi</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            $('#locationPermissionModal').remove();
            $('body').append(modalHtml);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('locationPermissionModal')).show();
        }

        // Show dialog when permission prompt will appear
        function showLocationPermissionPromptDialog() {
            const modalHtml = `
                <div class="modal fade" id="locationPromptModal" tabindex="-1">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-geo-alt me-2"></i>Izin Lokasi Diperlukan
                                </h5>
                            </div>
                            <div class="modal-body text-center">
                                <i class="bi bi-geo-alt-fill text-info" style="font-size: 3rem;"></i>
                                <p class="mt-3">Browser akan meminta izin akses lokasi.</p>
                                <p><strong>Silakan klik "Izinkan" atau "Allow"</strong> untuk melanjutkan.</p>
                            </div>
                            <div class="modal-footer justify-content-center">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Mengerti</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#locationPromptModal').remove();
            $('body').append(modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('locationPromptModal'));
            modal.show();
            
            // Auto close after 3 seconds
            setTimeout(() => modal.hide(), 3000);
        }

        // Show general location help
        function showLocationHelp() {
            const modalHtml = `
                <div class="modal fade" id="locationHelpModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-question-circle me-2"></i>Tips Menggunakan GPS
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-check-circle text-success me-2"></i>Untuk GPS Akurat:</h6>
                                        <ul>
                                            <li>Berada di area terbuka</li>
                                            <li>Jauh dari gedung tinggi</li>
                                            <li>GPS di perangkat sudah aktif</li>
                                            <li>Koneksi internet stabil</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="bi bi-x-circle text-danger me-2"></i>Hindari:</h6>
                                        <ul>
                                            <li>Di dalam ruangan tertutup</li>
                                            <li>Di bawah jembatan</li>
                                            <li>Area dengan gangguan sinyal</li>
                                            <li>Cuaca buruk (hujan deras)</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>Alternatif:</strong> Jika GPS tidak berhasil, gunakan "Pilih dari Peta" untuk memilih lokasi secara manual.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                                <button type="button" class="btn btn-primary" onclick="openMapPicker(); $('#locationHelpModal').modal('hide');">Pilih dari Peta</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#locationHelpModal').remove();
            $('body').append(modalHtml);
            new bootstrap.Modal(document.getElementById('locationHelpModal')).show();
        }

        // Open map picker modal
        function openMapPicker() {
            // Create map picker modal with enhanced styling
            const modalHtml = `
                <div class="modal fade" id="mapPickerModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-map-marked-alt me-2"></i>Pilih Lokasi dari Peta
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="row g-0">
                                    <div class="col-12">
                                        <div class="p-3 border-bottom">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" id="mapSearch" placeholder="Cari lokasi (contoh: Jakarta, Bandung, Jl. Sudirman)">
                                </div>
                                                <div class="col-md-4">
                                                    <div class="d-flex gap-2">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()">
                                                            <i class="fas fa-crosshairs me-1"></i>GPS
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetMapLocation()">
                                                            <i class="fas fa-undo me-1"></i>Reset
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="map" style="height: 500px; width: 100%; position: relative;"></div>
                                        <div class="p-3 border-top bg-light">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong class="text-primary">Koordinat yang dipilih:</strong><br>
                                                    <div class="mt-2">
                                                        <span class="badge bg-primary me-2">Latitude</span>
                                                        <code id="selectedLat">-6.2088</code><br>
                                                        <span class="badge bg-primary me-2">Longitude</span>
                                                        <code id="selectedLng">106.8456</code>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="alert alert-info mb-0">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        <strong>Petunjuk:</strong><br>
                                                        • Klik di peta untuk memilih lokasi<br>
                                                        • Gunakan GPS untuk lokasi saat ini<br>
                                                        • Pilih layer peta sesuai kebutuhan
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Batal
                                </button>
                                <button type="button" class="btn btn-primary" onclick="applyMapLocation()">
                                    <i class="fas fa-check me-1"></i>Gunakan Lokasi Ini
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#mapPickerModal').remove();
            
            // Add modal to body
            $('body').append(modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('mapPickerModal'));
            modal.show();
            
            // Initialize map after modal is shown
            setTimeout(() => {
                initMapPicker();
            }, 500);
        }

        // Initialize map picker with enhanced features
        function initMapPicker() {
            // Default location (Jakarta)
            const defaultLat = -6.2088;
            const defaultLng = 106.8456;
            
            // Create map using Leaflet and store globally
            window.mapPickerMap = L.map('map').setView([defaultLat, defaultLng], 12);
            
            // Define tile layers (same as mapping-new.ejs)
            const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors © CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            });
            
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors © CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            });
            
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 20
            });
            
            // Add default satellite layer
            satelliteLayer.addTo(window.mapPickerMap);
            
            // Create layer control
            const baseMaps = {
                "Light": lightLayer,
                "Dark": darkLayer,
                "Satellite": satelliteLayer
            };
            
            L.control.layers(baseMaps).addTo(window.mapPickerMap);
            
            // Create custom marker icon
            const createCustomMarker = (lat, lng) => {
                return L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-map-marker-alt"></i></div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                });
            };
            
            // Add initial marker and store globally
            window.mapPickerMarker = createCustomMarker(defaultLat, defaultLng).addTo(window.mapPickerMap);
            
            // Update coordinates display
            document.getElementById('selectedLat').textContent = defaultLat.toFixed(8);
            document.getElementById('selectedLng').textContent = defaultLng.toFixed(8);
            
            // Handle map click
            window.mapPickerMap.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // Remove existing marker
                window.mapPickerMap.removeLayer(window.mapPickerMarker);
                
                // Add new marker
                window.mapPickerMarker = createCustomMarker(lat, lng).addTo(window.mapPickerMap);
                
                // Update coordinates display
                document.getElementById('selectedLat').textContent = lat.toFixed(8);
                document.getElementById('selectedLng').textContent = lng.toFixed(8);
            });
            
            // Handle search with enhanced geocoding
            document.getElementById('mapSearch').addEventListener('input', function(e) {
                const query = e.target.value;
                if (query.length > 3) {
                    // Enhanced geocoding using OpenStreetMap Nominatim
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=id&addressdetails=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lng = parseFloat(data[0].lon);
                                
                                window.mapPickerMap.setView([lat, lng], 15);
                                
                                // Remove existing marker
                                window.mapPickerMap.removeLayer(window.mapPickerMarker);
                                
                                // Add new marker
                                window.mapPickerMarker = createCustomMarker(lat, lng).addTo(window.mapPickerMap);
                                
                                document.getElementById('selectedLat').textContent = lat.toFixed(8);
                                document.getElementById('selectedLng').textContent = lng.toFixed(8);
                                
                                // Show success message
                                showToast('success', 'Lokasi Ditemukan', `Lokasi "${data[0].display_name}" berhasil ditemukan dan ditampilkan di peta.`);
                            }
                        })
                        .catch(error => {
                            console.error('Geocoding error:', error);
                            showToast('error', 'Gagal Mencari Lokasi', 'Tidak dapat menemukan lokasi yang dicari. Pastikan alamat yang dimasukkan benar atau coba dengan kata kunci yang lebih spesifik.');
                        });
                }
            });
            
        }

        // Get current GPS location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map view
                    if (window.mapPickerMap) {
                        window.mapPickerMap.setView([lat, lng], 15);
                        
                        // Remove existing marker
                        if (window.mapPickerMarker) {
                            window.mapPickerMap.removeLayer(window.mapPickerMarker);
                        }
                        
                        // Add new marker
                        window.mapPickerMarker = createCustomMarker(lat, lng).addTo(window.mapPickerMap);
                        
                        document.getElementById('selectedLat').textContent = lat.toFixed(8);
                        document.getElementById('selectedLng').textContent = lng.toFixed(8);
                        
                        showToast('success', 'Lokasi GPS Berhasil Diambil', 'Koordinat GPS berhasil diambil dan ditampilkan di peta. Klik "Terapkan Lokasi" untuk menyimpan ke form.');
                    }
                }, function(error) {
                    showToast('error', 'Gagal Mengambil Lokasi GPS', 'Tidak dapat mengambil lokasi dari GPS. Pastikan izin lokasi sudah diberikan dan Anda berada di area terbuka.');
                });
            } else {
                showToast('error', 'GPS Tidak Tersedia', 'Browser Anda tidak mendukung fitur geolocation. Silakan gunakan pencarian alamat atau input manual.');
            }
        }
        
        // Reset map to default location
        function resetMapLocation() {
            const defaultLat = -6.2088;
            const defaultLng = 106.8456;
            
            if (window.mapPickerMap) {
                window.mapPickerMap.setView([defaultLat, defaultLng], 12);
                
                // Remove existing marker
                if (window.mapPickerMarker) {
                    window.mapPickerMap.removeLayer(window.mapPickerMarker);
                }
                
                // Add new marker
                window.mapPickerMarker = createCustomMarker(defaultLat, defaultLng).addTo(window.mapPickerMap);
                
                document.getElementById('selectedLat').textContent = defaultLat.toFixed(8);
                document.getElementById('selectedLng').textContent = defaultLng.toFixed(8);
                
                showToast('info', 'Peta Direset', 'Peta telah direset ke lokasi default (Jakarta). Silakan pilih lokasi baru atau gunakan GPS.');
            }
        }
        
        // Create custom marker function (global)
        function createCustomMarker(lat, lng) {
            return L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            });
        }

        // Apply selected map location to form
        function applyMapLocation() {
            const lat = document.getElementById('selectedLat').textContent;
            const lng = document.getElementById('selectedLng').textContent;
            
            if (lat !== '-' && lng !== '-') {
                // Update add form
                $('#latitude').val(lat);
                $('#longitude').val(lng);
                
                // Update edit form if open
                if ($('#edit_latitude').length) {
                    $('#edit_latitude').val(lat);
                    $('#edit_longitude').val(lng);
                }
                
                showToast('Lokasi berhasil diterapkan!', 'success');
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('mapPickerModal')).hide();
            } else {
                showToast('Pilih lokasi terlebih dahulu', 'error');
            }
        }

        // Toast notification function dengan support untuk title dan message detail
        function showToast(type, title, message, duration = 5000) {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            // Support backward compatibility: jika hanya 2 parameter, anggap sebagai (message, type)
            if (arguments.length === 2 && typeof arguments[0] === 'string' && typeof arguments[1] === 'string') {
                const oldMessage = arguments[0];
                const oldType = arguments[1];
                type = oldType;
                title = oldType === 'success' ? 'Berhasil' : oldType === 'error' ? 'Error' : 'Info';
                message = oldMessage;
            }
            
            const iconClass = type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle';
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : 'bg-info';
            
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 350px;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${iconClass} me-2"></i>
                            <strong>${title || (type === 'success' ? 'Berhasil' : type === 'error' ? 'Error' : 'Info')}</strong>
                            ${message ? '<br><small>' + message + '</small>' : ''}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
        
        // WhatsApp Notification Functions
        let currentNotificationData = null;

        function sendWhatsAppNotification(phone, name) {
            // Set customer data in modal
            document.getElementById('waPhoneNumber').value = phone;
            document.getElementById('waCustomerName').value = name;
            
            // Generate a default message preview for customer notification
            const messagePreview = `📋 *NOTIFIKASI PELANGGAN*

Halo ${name},

Terima kasih telah menggunakan layanan kami.

Jika ada pertanyaan atau butuh bantuan, silakan hubungi customer service kami.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CV Lintas Multimedia
Internet Tanpa Batas`;

            document.getElementById('notificationPreview').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Preview Pesan:</h6>
                    </div>
                    <div class="card-body">
                        <pre style="white-space: pre-wrap; font-size: 14px;">${messagePreview}</pre>
                    </div>
                </div>
            `;

            // Set current notification data
            currentNotificationData = {
                phoneNumber: phone,
                customerName: name,
                status: 'unpaid',
                amount: 0,
                dueDate: new Date().toISOString().split('T')[0],
                invoiceNumber: `CUST-${Date.now()}`,
                packageName: 'Paket Internet'
            };
            
            // Show modal
            $('#whatsappModal').modal('show');
        }

        // Confirm send WhatsApp notification
        document.getElementById('confirmSendWA').addEventListener('click', function() {
            // Ambil data langsung dari input field untuk memastikan data terbaru
            const phoneNumber = document.getElementById('waPhoneNumber')?.value?.trim();
            const customerName = document.getElementById('waCustomerName')?.value?.trim();

            // Validasi di client side
            if (!phoneNumber || !customerName) {
                showToast('error', 'Gagal Mengirim', 'Nomor WhatsApp dan Nama Pelanggan harus diisi');
                return;
            }

            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Mengirim...';

            // Gunakan route khusus untuk customer notification (bukan invoice)
            fetch('/admin/billing/customers/send-whatsapp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phoneNumber: phoneNumber,
                    customerName: customerName,
                    customMessage: null // Bisa ditambahkan field custom message di modal jika diperlukan
                })
            })
            .then(response => {
                return response.json().then(data => ({ response, data }));
            })
            .then(({ response, data }) => {
                if (data.success) {
                    showToast('success', 'Notifikasi Terkirim', 'Notifikasi WhatsApp berhasil dikirim');
                    $('#whatsappModal').modal('hide');
                } else {
                    showToast('error', 'Gagal Mengirim', data.message || 'Gagal mengirim notifikasi WhatsApp');
                }
            })
            .catch(error => {
                console.error('Error sending WhatsApp notification:', error);
                showToast('error', 'Error Mengirim Notifikasi', 'Terjadi kesalahan saat mengirim notifikasi WhatsApp. Pastikan koneksi internet stabil dan coba lagi.');
            })
            .finally(() => {
                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        });
        
        // Function to generate username and email from name
        function generateCredentialsFromName() {
            const nameInput = document.getElementById('name');
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            
            if (!nameInput || !usernameInput) return;
            
            const name = nameInput.value.trim();
            if (!name) {
                usernameInput.value = '';
                if (emailInput) emailInput.value = '';
                return;
            }
            
            // Get current date in DDMMYY format
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2);
            const dateStr = day + month + year;
            
            // Process name: remove special characters, replace spaces with underscores
            let processedName = name.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')  // Remove special characters
                .replace(/\s+/g, '_')         // Replace spaces with underscores
                .replace(/_+/g, '_')          // Replace multiple underscores with single
                .replace(/^_|_$/g, '');       // Remove leading/trailing underscores
            
            // If processed name is empty, use 'user'
            if (!processedName) processedName = 'user';
            
            // Generate username
            const baseUsername = processedName + '_' + dateStr;
            usernameInput.value = baseUsername;
            
            // Generate email if email field exists
            if (emailInput) {
                emailInput.value = processedName + '@gembok.com';
            }
        }
    </script>

    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav d-md-none" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(11,20,55,0.96), rgba(15,28,79,0.96)); border-top: 1px solid rgba(255,255,255,0.08); height: 70px; display: grid; grid-template-columns: 1fr 1fr 1.5fr 1fr 1fr; z-index: 1000; backdrop-filter: blur(10px); padding: 8px 0;">
        <a class="nav-item" href="/admin/billing/mobile/customers" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: white; text-decoration: none; transition: all 0.3s ease;">
            <i class="bi bi-people" style="font-size: 1.2rem;"></i>
            <span style="font-size: 0.7rem; font-weight: 500;">Pelanggan</span>
        </a>
        <a class="nav-item" href="/admin/billing/mobile/invoices" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: white; text-decoration: none; transition: all 0.3s ease;">
            <i class="bi bi-receipt" style="font-size: 1.2rem;"></i>
            <span style="font-size: 0.7rem; font-weight: 500;">Tagihan</span>
        </a>
        <a class="nav-item home-button active" href="/admin/billing/mobile" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: white; text-decoration: none; transition: all 0.3s ease; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; width: 56px; height: 56px; margin: -8px auto 0 auto; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transform: translateY(-4px); border: 2px solid rgba(255,255,255,0.2); position: relative; overflow: hidden;">
            <i class="bi bi-house" style="font-size: 1.2rem;"></i>
            <span style="font-size: 0.7rem; font-weight: 500;">Home</span>
        </a>
        <a class="nav-item" href="/admin/billing/mobile/payments" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: white; text-decoration: none; transition: all 0.3s ease;">
            <i class="bi bi-credit-card" style="font-size: 1.2rem;"></i>
            <span style="font-size: 0.7rem; font-weight: 500;">Bayar</span>
        </a>
        <a class="nav-item" href="/admin/billing/mobile/map" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: white; text-decoration: none; transition: all 0.3s ease;">
            <i class="bi bi-geo-alt" style="font-size: 1.2rem;"></i>
            <span style="font-size: 0.7rem; font-weight: 500;">Map</span>
        </a>
    </nav>

    <style>
        /* Bottom Navigation Styles */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(11,20,55,0.96), rgba(15,28,79,0.96));
            border-top: 1px solid rgba(255,255,255,0.08);
            height: 70px;
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr 1fr 1fr;
            z-index: 1000;
            backdrop-filter: blur(10px);
            padding: 8px 0;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            color: #4cc9f0;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            color: #4cc9f0;
        }
        
        .nav-item.home-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            margin: -8px auto 0 auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-4px);
            border: 2px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .nav-item.home-button:hover {
            transform: translateY(-6px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .nav-item.home-button.active {
            color: white;
        }
        
        /* Add padding to body for bottom nav */
        body {
            padding-bottom: 80px;
        }
        
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
            
            body {
                padding-bottom: 0;
            }
        }
    </style>
    
    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Gambar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="Gambar" class="img-fluid" style="max-height: 80vh;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to show image in modal
        function showImageModal(imagePath, title) {
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('imageModalLabel').textContent = title || 'Gambar';
            document.getElementById('modalImage').src = imagePath;
            modal.show();
        }
    </script>

    <!-- Mobile Bottom Navbar -->
    <%- include('../../partials/admin-mobile-navbar', { currentPage: 'customers' }) %>
</body>
</html> 