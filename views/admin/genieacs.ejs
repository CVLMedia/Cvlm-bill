<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>GenieACS Servers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/responsive-admin.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <%- include('../partials/admin-responsive-sidebar', { page: 'genieacs', settings: settings || {} }) %>
    <main class="col-md-10 ms-sm-auto main-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-server me-2"></i>GenieACS Servers</h4>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addGenieacsModal">
          <i class="bi bi-plus"></i> Tambah GenieACS Server
        </button>
      </div>
      
      <!-- GenieACS Servers Table -->
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-server me-2"></i>Daftar GenieACS Servers</h5>
        </div>
        <div class="card-body p-3">
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nama</th>
                  <th>URL</th>
                  <th>Username</th>
                  <th>Description</th>
                  <th>Router Count</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <% if (typeof genieacsServers !== 'undefined' && genieacsServers && Array.isArray(genieacsServers) && genieacsServers.length > 0) { %>
                  <% genieacsServers.forEach(function(s,i){ %>
                    <tr>
                      <td><%= i+1 %></td>
                      <td><%= s.name || '-' %></td>
                      <td><code><%= s.url || '-' %></code></td>
                      <td><%= s.username || '-' %></td>
                      <td><%= s.description || '-' %></td>
                      <td><span class="badge bg-info"><%= s.router_count || 0 %></span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick='openEditGenieacs(<%- JSON.stringify(s) %>)'><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-info" onclick='testGenieacs(<%= s.id %>)'><i class="bi bi-activity"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick='deleteGenieacs(<%= s.id %>)'><i class="bi bi-trash"></i></button>
                      </td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="7" class="text-center text-muted">
                      Belum ada GenieACS server
                      <br><small class="text-muted">(Count: <%= typeof genieacsServers !== 'undefined' && genieacsServers ? genieacsServers.length : 0 %>)</small>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Add GenieACS Server Modal -->
      <div class="modal fade" id="addGenieacsModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Tambah GenieACS Server</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addGenieacsForm">
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Nama <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="g_name" name="name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">URL <span class="text-danger">*</span></label>
                  <input type="url" class="form-control" id="g_url" name="url" placeholder="http://10.201.39.70:7557" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Username <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="g_username" name="username" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Password <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="g_password" name="password" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="g_description" name="description" rows="2"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary">Simpan</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Edit GenieACS Server Modal -->
      <div class="modal fade" id="editGenieacsModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit GenieACS Server</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editGenieacsForm">
              <input type="hidden" id="edit_g_id" name="id">
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Nama <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="edit_g_name" name="name" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">URL <span class="text-danger">*</span></label>
                  <input type="url" class="form-control" id="edit_g_url" name="url" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Username <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="edit_g_username" name="username" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Password <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="edit_g_password" name="password" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="edit_g_description" name="description" rows="2"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary">Update</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Add GenieACS Server
document.getElementById('addGenieacsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const body = {
    name: document.getElementById('g_name').value,
    url: document.getElementById('g_url').value,
    username: document.getElementById('g_username').value,
    password: document.getElementById('g_password').value,
    description: document.getElementById('g_description').value
  };
  
  console.log('Sending GenieACS server data:', body);
  
  try {
    const response = await fetch('/admin/genieacs', { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify(body)
    });
    
    const res = await response.json();
    console.log('Response:', res);
    
    if (res.success) {
      alert('GenieACS server berhasil ditambahkan (ID: ' + (res.id || 'N/A') + ')');
      const modal = bootstrap.Modal.getInstance(document.getElementById('addGenieacsModal'));
      if (modal) modal.hide();
      document.getElementById('addGenieacsForm').reset();
      setTimeout(() => window.location.reload(), 300);
    } else {
      alert(res.message || 'Gagal menyimpan GenieACS server');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Terjadi kesalahan: ' + error.message);
  }
});

// Edit GenieACS Server
function openEditGenieacs(server) {
  document.getElementById('edit_g_id').value = server.id;
  document.getElementById('edit_g_name').value = server.name || '';
  document.getElementById('edit_g_url').value = server.url || '';
  document.getElementById('edit_g_username').value = server.username || '';
  document.getElementById('edit_g_password').value = server.password || '';
  document.getElementById('edit_g_description').value = server.description || '';
  new bootstrap.Modal(document.getElementById('editGenieacsModal')).show();
}

document.getElementById('editGenieacsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const id = document.getElementById('edit_g_id').value;
  const body = {
    name: document.getElementById('edit_g_name').value,
    url: document.getElementById('edit_g_url').value,
    username: document.getElementById('edit_g_username').value,
    password: document.getElementById('edit_g_password').value,
    description: document.getElementById('edit_g_description').value
  };
  
  try {
    const response = await fetch(`/admin/genieacs/${id}`, { 
      method: 'PUT', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify(body)
    });
    
    const res = await response.json();
    if (res.success) {
      alert('GenieACS server berhasil diupdate');
      const modal = bootstrap.Modal.getInstance(document.getElementById('editGenieacsModal'));
      if (modal) modal.hide();
      setTimeout(() => window.location.reload(), 300);
    } else {
      alert(res.message || 'Gagal mengupdate GenieACS server');
    }
  } catch (error) {
    alert('Terjadi kesalahan: ' + error.message);
  }
});

// Delete GenieACS Server
function deleteGenieacs(id) {
  if (!confirm('Yakin ingin menghapus GenieACS server ini?')) return;
  
  fetch(`/admin/genieacs/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('GenieACS server berhasil dihapus');
        window.location.reload();
      } else {
        alert(data.message || 'Gagal menghapus GenieACS server');
      }
    })
    .catch(err => alert('Error: ' + err.message));
}

// Test GenieACS Connection
function testGenieacs(id) {
  fetch(`/admin/genieacs/${id}/test`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('Koneksi berhasil! Status: ' + (data.status || 'OK'));
      } else {
        alert('Koneksi gagal: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(err => alert('Error: ' + err.message));
}
</script>
</body>
</html>

