<!-- Halaman Tab Setting Admin -->
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Setting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/responsive-admin.css" rel="stylesheet">
    <style>
        /* Reset untuk memastikan scroll bekerja - AGGRESSIVE FIX */
        * {
            box-sizing: border-box;
        }
        
        html {
            height: auto !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        body { 
            background: #f5f6fa;
            height: auto !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            position: relative !important;
        }

        .container-fluid {
            height: auto !important;
            min-height: 100vh !important;
            overflow: visible !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }
        
        .container-fluid > .row {
            height: auto !important;
            min-height: auto !important;
            overflow: visible !important;
            margin-bottom: 0 !important;
        }

        .main-content { 
            padding: 32px 24px !important; 
            padding-bottom: 200px !important; /* Extra padding untuk section terakhir */
            min-height: auto !important;
            height: auto !important;
            overflow: visible !important;
            margin-bottom: 0 !important;
            position: relative !important;
        }
        
        /* Pastikan semua section bisa di-scroll */
        .form-section {
            overflow: visible !important;
            height: auto !important;
            min-height: auto !important;
        }
        
        /* Activity Logs section - extra margin */
        #activityLogsTable {
            margin-bottom: 30px !important;
        }
        
        /* Pastikan table responsive tidak membatasi */
        .table-responsive {
            overflow: visible !important;
            margin-bottom: 20px !important;
        }
        
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .form-label { font-weight: 600; }
        .form-section { 
            background: white; 
            border-radius: 16px; 
            padding: 25px; 
            margin-bottom: 20px;
            height: 100%;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .qr-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            border-radius: 12px;
        }
        #wa-qr-container {
            min-height: 250px;
            align-items: center;
        }
        #wa-qr-div {
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .command-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .command-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .command-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .command-list {
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .command-list code {
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        .logo-preview {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
        }
        .logo-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .logo-preview img[src$=".svg"] {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 120px;
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 8px 12px;
        }
        .alert-custom {
            border-radius: 8px;
            border-left: 4px solid;
        }
        .alert-warning {
            border-left-color: #ffc107;
        }
        .alert-info {
            border-left-color: #17a2b8;
        }
        .alert-success {
            border-left-color: #28a745;
        }
        .alert-danger {
            border-left-color: #dc3545;
        }
        
        /* Desktop: When sidebar collapsed, ensure main content is full width */
        @media (min-width: 768px) {
            body:has(.sidebar.collapsed) .main-content {
                margin-left: 70px !important;
                width: calc(100% - 70px) !important;
                max-width: calc(100% - 70px) !important;
            }
            
            body:has(.sidebar.collapsed) .main-content.col-md-10 {
                flex: 0 0 calc(100% - 70px) !important;
                max-width: calc(100% - 70px) !important;
                width: calc(100% - 70px) !important;
            }
            
            body:has(.sidebar.collapsed) .container-fluid {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }
        }
        
        /* Mobile responsive fixes */
        @media (max-width: 767.98px) {
            .main-content {
                margin-top: 70px !important; /* Extra space for mobile navbar */
                padding-top: 20px !important;
                padding-left: 15px !important;
                padding-right: 15px !important;
                z-index: 1;
                width: 100% !important;
                margin-left: 0 !important;
            }
            .card {
                z-index: 1;
            }
            /* Pastikan cards tidak overlap dengan mobile navbar */
            .row.mb-4:first-of-type,
            .row.g-3:first-of-type {
                margin-top: 10px;
            }
            /* Responsive notification positioning */
            #restartNotif {
                top: 80px !important; /* Below mobile navbar */
                right: 10px !important;
                left: 10px !important;
                width: auto !important;
            }
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Include Responsive Admin Sidebar -->
        <%- include('partials/admin-responsive-sidebar', { page: 'setting', settings: settings }) %>
        
        <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4 main-content">
            <h3 class="mb-4">Pengaturan Sistem</h3>
            
            <div class="row g-3">
                <!-- Kolom 1: Form Settings -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="bi bi-gear text-primary"></i> Pengaturan Sistem
                        </h5>
                        
                        <!-- Alert Panduan Konfigurasi -->
                        <div class="alert alert-info alert-custom mb-4" role="alert">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-info-circle-fill me-2 fs-5 mt-1"></i>
                                <div>
                                    <h6 class="alert-heading mb-2">
                                        <i class="bi bi-lightbulb me-1"></i>Panduan Konfigurasi Sistem
                                    </h6>
                                    <p class="mb-2">
                                        Pastikan konfigurasi GenieACS dan Mikrotik sudah benar agar sistem dapat berjalan optimal:
                                    </p>
                                    <ul class="mb-2 small">
                                        <li><strong>GenieACS URL:</strong> Gunakan IP lokal yang dapat diakses (contoh: http://192.168.1.100:7557)</li>
                                        <li><strong>GenieACS Credentials:</strong> Pastikan username dan password benar</li>
                                        <li><strong>Mikrotik Host:</strong> Gunakan IP router Mikrotik yang benar</li>
                                        <li><strong>Mikrotik Port:</strong> Biasanya 8728 untuk API atau 8729 untuk SSL</li>
                                        <li><strong>Mikrotik Credentials:</strong> Gunakan user dengan akses API</li>
                                    </ul>
                                    <p class="mb-0 small text-muted">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Jika ada masalah koneksi, sistem akan menampilkan warning di dashboard dengan link ke halaman ini.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="settingsForm">
                            <div id="settingsFields">
                                <!-- Field dari settings.json akan di-render di sini oleh JS -->
                            </div>
                            <div id="settingsSuccess" class="alert alert-success d-none" role="alert"></div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                <button type="button" class="btn btn-outline-info me-2" id="testConnectionBtn">
                                    <i class="bi bi-wifi"></i> Test Koneksi
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Simpan Perubahan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Kolom 2: SMTP Email Configuration -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="bi bi-envelope text-primary"></i> SMTP Email Configuration
                        </h5>
                        
                        <!-- Info Alert -->
                        <div class="alert alert-info alert-custom mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                                <div>
                                    <strong>Konfigurasi SMTP</strong>
                                    <br>
                                    <small>
                                        Konfigurasi SMTP server untuk mengirim email notification. Setelah dikonfigurasi, email notification akan otomatis aktif di <a href="/admin/billing/email-settings" target="_blank">Pengaturan Email</a>.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <form id="smtpForm">
                            <div class="mb-3">
                                <label class="form-label">SMTP Host</label>
                                <input type="text" class="form-control" name="smtp_host" id="smtp_host" placeholder="smtp.gmail.com">
                                <div class="form-text">Alamat server SMTP (contoh: smtp.gmail.com, smtp.mailtrap.io)</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" name="smtp_port" id="smtp_port" placeholder="587" value="587">
                                <div class="form-text">Port SMTP (587 untuk TLS, 465 untuk SSL, 25 untuk non-encrypted)</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">SMTP Secure</label>
                                <select class="form-select" name="smtp_secure" id="smtp_secure">
                                    <option value="false">TLS (Port 587)</option>
                                    <option value="true">SSL (Port 465)</option>
                                </select>
                                <div class="form-text">Pilih jenis enkripsi koneksi SMTP</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">SMTP User</label>
                                <input type="text" class="form-control" name="smtp_user" id="smtp_user" placeholder="your-email@gmail.com">
                                <div class="form-text">Email atau username untuk autentikasi SMTP</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">SMTP Password</label>
                                <input type="password" class="form-control" name="smtp_password" id="smtp_password" placeholder="Your SMTP password">
                                <div class="form-text text-warning">‚ö†Ô∏è Untuk Gmail, gunakan App Password, bukan password akun biasa</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">From Email</label>
                                <input type="email" class="form-control" name="smtp_from_email" id="smtp_from_email" placeholder="noreply@yourdomain.com">
                                <div class="form-text">Email pengirim (default: sama dengan SMTP User)</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">From Name</label>
                                <input type="text" class="form-control" name="smtp_from_name" id="smtp_from_name" placeholder="Sistem Billing">
                                <div class="form-text">Nama pengirim yang ditampilkan di email</div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="smtp_reject_unauthorized" id="smtp_reject_unauthorized" checked>
                                    <label class="form-check-label" for="smtp_reject_unauthorized">
                                        Reject Unauthorized Certificates
                                    </label>
                                </div>
                                <div class="form-text">Nonaktifkan jika menggunakan self-signed certificate</div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-info" id="btnTestSMTP">
                                    <i class="bi bi-envelope-check"></i> Test SMTP Connection
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Simpan Konfigurasi SMTP
                                </button>
                            </div>
                            
                            <div id="smtpTestResult" class="alert mt-3 d-none"></div>
                        </form>

                        <!-- Logo Aplikasi -->
                        <div class="mt-4">
                            <h5 class="mb-3">
                                <i class="bi bi-image text-success"></i> Logo Aplikasi
                            </h5>
                            <form id="logoUploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label class="form-label">Upload Logo Baru</label>
                                    <input type="file" name="logo" accept="image/*,.svg" class="form-control" required>
                                    <div class="form-text">Format: PNG, JPG, JPEG, GIF, BMP, WEBP, SVG. Maksimal 5MB.</div>
                                </div>
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-upload"></i> Upload Logo
                                </button>
                            </form>
                            <div class="logo-preview mt-3">
                                <label class="form-label">Logo Saat Ini:</label>
                                <img id="logoPreview" src="/img/<%= typeof settings !== 'undefined' && settings.logo_filename ? settings.logo_filename : 'logo.png' %>?ts=<%= Date.now() %>" alt="Logo" style="max-width:200px;max-height:120px;">
                            </div>
                        </div>

                        <!-- QR Notifikasi Penagihan -->
                        <div class="mt-4">
                            <h5 class="mb-3">
                                <i class="bi bi-qr-code text-primary"></i> QR Notifikasi Penagihan
                            </h5>
                            <form id="billingQrUploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label class="form-label">Upload QR Baru</label>
                                    <input type="file" name="billingQr" accept="image/*" class="form-control" required>
                                    <div class="form-text">Format: PNG, JPG, JPEG, GIF, BMP, WEBP. Maksimal 2MB.</div>
                                </div>
                                <button type="submit" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-upload"></i> Upload QR Penagihan
                                </button>
                            </form>
                            <div class="logo-preview mt-3">
                                <label class="form-label">QR Saat Ini:</label>
                                <img id="billingQrPreview" src="/admin/settings/billing-qr?ts=<%= Date.now() %>" alt="QR Penagihan" style="max-width:200px;max-height:200px;">
                            </div>
                            <div class="mt-2 d-flex flex-column gap-2">
                                <a href="/admin/settings/billing-qr" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary w-100">
                                    Buka QR ukuran penuh
                                </a>
                                <small class="text-muted">QR ini digunakan sebagai lampiran saat sistem mengirim notifikasi penagihan melalui WhatsApp.</small>
                            </div>
                        </div>

                        <!-- Script Generator Menu Isolir Mikrotik -->
                        <div class="mt-4">
                            <h5 class="mb-3"><i class="bi bi-router"></i> Script Generator Menu Isolir Mikrotik</h5>
                            <p class="small text-muted mb-3">Generate script untuk mengatur menu isolir di Mikrotik. Pelanggan yang diisolir akan langsung diarahkan ke halaman isolir.</p>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">IP PPPoE Aktif</label>
                                    <input type="text" class="form-control form-control-sm" id="activeIp" placeholder="192.168.10.1" value="192.168.10.1">
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">IP PPPoE Isolir</label>
                                    <input type="text" class="form-control form-control-sm" id="isolirIp" placeholder="192.168.200.1" value="192.168.200.1">
                                    <small class="text-muted">Tanpa Menggunakan /Segment</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">IP Web/Domain Web Isolir </label>
                                    <input type="text" class="form-control form-control-sm" id="isolirDomain" placeholder="192.168.8.89" value="192.168.8.89">
                                    <small class="text-muted">IP atau domain aplikasi (contoh: 192.168.8.89 atau cvlmedia.my.id)</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">Path Halaman Isolir (default)</label>
                                    <input type="text" class="form-control form-control-sm" id="isolirPath" placeholder="/isolir" value="/isolir">
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">Port Aplikasi Local</label>
                                    <input type="text" class="form-control form-control-sm" id="isolirPort" placeholder="3003" value="3003">
                                    <small class="text-muted">Port aplikasi (contoh: 3003 untuk aplikasi lokal)</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">Jenis Akses</label>
                                    <select class="form-select form-select-sm" id="accessType">
                                        <option value="port">Port Langsung (Recommended)</option>
                                        <option value="tunneling">Tunneling (Domain + Path)</option>
                                    </select>
                                    <small class="text-muted">Port Langsung untuk aplikasi lokal, Tunneling untuk domain</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3" id="tunnelingDstAddressRow" style="display: none;">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">!Dst. Address (IP Domain)</label>
                                    <input type="text" class="form-control form-control-sm" id="tunnelingDstAddress" placeholder="103.19.57.66" value="">
                                    <small class="text-muted">IP Domain yang tidak akan ter-drop oleh firewall. Hanya tampil saat menggunakan Tunneling.</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">Pilih Router Nas Tujuan</label>
                                    <select class="form-select form-select-sm" id="isolirRouterSelect">
                                        <option value="auto">Auto (Dari /admin/routers)</option>
                                    </select>
                                    <small class="text-muted">Pilih router untuk execute script, atau pilih Auto untuk menggunakan router pertama dari /admin/routers</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <label class="form-label small fw-bold">RouterOS Version (Opsional)</label>
                                    <select class="form-select form-select-sm" id="rosVersion">
                                        <option value="auto">Auto Detect</option>
                                        <option value="6">ROS 6.x</option>
                                        <option value="7">ROS 7.x</option>
                                    </select>
                                    <small class="text-muted">Pilih versi RouterOS atau biarkan Auto untuk deteksi otomatis</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="autoExecuteIsolir" checked>
                                    <label class="form-check-label" for="autoExecuteIsolir">
                                        <strong>Auto-Execute ke Mikrotik</strong>
                                    </label>
                                </div>
                                <small class="text-muted d-block mb-2">Jika dicentang, script akan otomatis dijalankan ke Mikrotik setelah di-generate</small>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-primary btn-sm" onclick="if(typeof window.generateIsolirScript === 'function') { window.generateIsolirScript(); } else { alert('Fungsi belum siap, silakan refresh halaman'); }">
                                    <i class="bi bi-gear"></i> Generate & Execute Script
                                </button>
                                <button type="button" class="btn btn-success btn-sm ms-2" onclick="if(typeof window.generateLocalIsolirScript === 'function') { window.generateLocalIsolirScript(); } else { alert('Fungsi belum siap, silakan refresh halaman'); }">
                                    <i class="bi bi-house"></i> Generate Script Lokal
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="if(typeof window.copyIsolirScript === 'function') { window.copyIsolirScript(); } else { alert('Fungsi belum siap, silakan refresh halaman'); }">
                                    <i class="bi bi-clipboard"></i> Copy Script
                                </button>
                            </div>
                            
                            <div id="isolirExecuteStatus" class="alert d-none mb-3"></div>
                            
                            <div class="command-card" id="isolirScriptCard" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="bi bi-terminal"></i> Script Mikrotik</h6>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="if(typeof window.copyIsolirScript === 'function') { window.copyIsolirScript(); } else { alert('Fungsi belum siap, silakan refresh halaman'); }">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                </div>
                                <pre id="isolirScript" class="mb-0" style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; font-size: 12px; max-height: 400px; overflow-y: auto;"></pre>
                            </div>
                            
                            <div class="alert alert-info mt-3" id="isolirInfo">
                                <h6><i class="bi bi-info-circle"></i> Cara Penggunaan:</h6>
                                <ol class="mb-0">
                                    <li>Masukkan IP PPPoE aktif dan isolir</li>
                                    <li>Masukkan IP/domain aplikasi dan path halaman isolir</li>
                                    <li>Masukkan port aplikasi (contoh: 3003 untuk aplikasi lokal)</li>
                                    <li>Pilih jenis akses: <strong>Port Langsung</strong> (recommended) atau <strong>Tunneling</strong></li>
                                    <li>Klik "Generate Script"</li>
                                    <li>Copy script dan jalankan di terminal Mikrotik</li>
                                    <li>Script akan membuat redirect yang mengarahkan ke halaman isolir</li>
                                </ol>
                                <div class="mt-2">
                                    <strong>Contoh Aplikasi Lokal:</strong> 192.168.8.89:3003/isolir<br>
                                    <strong>Contoh Domain:</strong> cvlmedia.my.id/isolir<br>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kolom 2c: WhatsApp Gateway -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="bi bi-whatsapp text-success"></i> WhatsApp Gateway
                        </h5>
                        
                        <!-- Status WhatsApp -->
                        <div class="text-center mb-3">
                            <div id="wa-status" class="mb-2"></div>
                            <div id="wa-qr-container" class="d-flex justify-content-center mb-2 d-none">
                                <div class="position-relative">
                                    <img id="wa-qr" src="#" alt="QR Code WhatsApp" class="img-fluid rounded shadow" style="max-width: 100%; height: auto; display: none;">
                                    <div id="wa-qr-div" class="d-flex justify-content-center"></div>
                                </div>
                            </div>
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-success btn-sm" id="btnRefreshQR">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh QR
                                </button>
                                <button class="btn btn-outline-danger btn-sm" id="btnDeleteSession">
                                    <i class="bi bi-trash"></i> Hapus Session
                                </button>
                            </div>
                        </div>
                        
                        <!-- Peringatan Scan QR Code -->
                        <div class="alert alert-warning alert-custom mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                                <div>
                                    <strong>‚ö†Ô∏è PENTING!</strong>
                                    <br>
                                    <small>
                                        Gunakan nomor WhatsApp <strong>BUKAN nomor admin</strong> untuk scan QR code ini. 
                                        Nomor yang digunakan untuk scan akan menjadi bot yang menerima dan memproses pesan WhatsApp.
                                        <br><br>
                                        <strong>Nomor Admin:</strong> Hanya untuk mengirim perintah, tidak untuk scan QR code.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Gateway Status -->
                        <div class="mb-3" id="gateway-status-container">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-2">
                                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Status Gateway</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="gateway-status-display" class="small">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Memuat status...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Konfigurasi Gateway -->
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> Konfigurasi Gateway
                            </h6>
                            
                            <form id="gateway-config-form">
                                <!-- Primary Gateway -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">
                                        <i class="bi bi-router"></i> Primary Gateway
                                    </label>
                                    <select class="form-select form-select-sm" name="whatsapp_primary_gateway" id="whatsapp_primary_gateway">
                                        <option value="baileys">Baileys (Default)</option>
                                        <option value="fonnte">Fonnte</option>
                                    </select>
                                    <div class="form-text small">
                                        Gateway utama yang digunakan. Jika gagal, akan otomatis fallback ke gateway lain.
                                    </div>
                                </div>

                                <!-- Fonnte Configuration -->
                                <div class="card border-secondary mb-3" id="fonnte-config-card">
                                    <div class="card-header bg-secondary text-white py-2">
                                        <h6 class="mb-0"><i class="bi bi-cloud"></i> Fonnte Gateway</h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <!-- Fonnte API Key -->
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">
                                                <i class="bi bi-key"></i> Fonnte API Key
                                            </label>
                                            <div class="input-group input-group-sm">
                                                <input type="password" class="form-control" name="fonnte_api_key" id="fonnte_api_key" placeholder="Masukkan API Key Fonnte">
                                                <button class="btn btn-outline-secondary" type="button" id="toggle-fonnte-key">
                                                    <i class="bi bi-eye" id="eye-icon-fonnte"></i>
                                                </button>
                                            </div>
                                            <div class="form-text small">
                                                Dapatkan API Key dari <a href="https://fonnte.com" target="_blank">fonnte.com</a>
                                            </div>
                                        </div>

                                        <!-- Fonnte API URL -->
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">
                                                <i class="bi bi-link-45deg"></i> Fonnte API URL
                                            </label>
                                            <input type="text" class="form-control form-control-sm" name="fonnte_api_url" id="fonnte_api_url" placeholder="https://api.fonnte.com">
                                            <div class="form-text small">
                                                URL API Fonnte (default: https://api.fonnte.com)
                                            </div>
                                        </div>

                                        <!-- Fonnte Delay -->
                                        <div class="mb-0">
                                            <label class="form-label small fw-bold">
                                                <i class="bi bi-hourglass-split"></i> Delay Antar Pesan (ms)
                                            </label>
                                            <input type="number" class="form-control form-control-sm" name="fonnte_delay" id="fonnte_delay" placeholder="1000" min="100" step="100">
                                            <div class="form-text small">
                                                Delay antar pesan dalam milidetik (default: 1000ms = 1 detik)
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Save Button -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-save"></i> Simpan Konfigurasi Gateway
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="btn-test-fonnte">
                                        <i class="bi bi-check-circle"></i> Test Koneksi Fonnte
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Kolom 2d: Telegram Monitoring Bot -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="bi bi-telegram text-info"></i> Telegram Monitoring Bot
                        </h5>
                        
                        <!-- Status Telegram Bot -->
                        <div class="mb-3" id="telegram-status-container">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-2">
                                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Status Bot</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="telegram-status-display" class="small">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Memuat status...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Konfigurasi Telegram Bot -->
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-gear"></i> Konfigurasi Telegram Bot
                            </h6>
                            
                            <form id="telegram-config-form">
                                <!-- Bot Token -->
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">
                                        <i class="bi bi-key"></i> Bot Token
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" name="telegram_bot_token" id="telegram_bot_token" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-telegram-token">
                                            <i class="bi bi-eye" id="eye-icon-telegram"></i>
                                        </button>
                                    </div>
                                    <div class="form-text small">
                                        Dapatkan Bot Token dari <a href="https://t.me/BotFather" target="_blank">@BotFather</a> di Telegram
                                    </div>
                                </div>

                                <!-- Enable/Disable Monitoring -->
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="telegram_monitoring_enabled" id="telegram_monitoring_enabled" checked>
                                        <label class="form-check-label small fw-bold" for="telegram_monitoring_enabled">
                                            <i class="bi bi-toggle-on"></i> Aktifkan Telegram Monitoring
                                        </label>
                                    </div>
                                    <div class="form-text small">
                                        Aktifkan untuk menerima notifikasi monitoring via Telegram
                                    </div>
                                </div>

                                <!-- Info Chat Registration -->
                                <div class="alert alert-info alert-custom mb-3">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                                        <div>
                                            <strong>üí° Cara Daftar Chat ID:</strong>
                                            <br>
                                            <small>
                                                1. Simpan konfigurasi ini (jika belum)<br>
                                                2. Restart aplikasi (jika baru pertama kali setup)<br>
                                                3. Buka Telegram dan cari bot Anda<br>
                                                4. Kirim perintah <code>/start</code> ke bot<br>
                                                5. Chat ID akan otomatis terdaftar<br>
                                                6. Notifikasi monitoring akan mulai dikirim
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Warning jika belum ada chat terdaftar -->
                                <div class="alert alert-warning alert-custom mb-3" id="telegram-no-chat-warning" style="display: none;">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                                        <div>
                                            <strong>‚ö†Ô∏è Belum Ada Chat Terdaftar!</strong>
                                            <br>
                                            <small>
                                                Bot sudah terhubung, tetapi belum ada chat ID yang terdaftar.<br>
                                                <strong>Langkah selanjutnya:</strong><br>
                                                1. Buka bot di Telegram<br>
                                                2. Kirim perintah <code>/start</code><br>
                                                3. Chat ID akan otomatis terdaftar<br>
                                                4. Notifikasi akan mulai dikirim
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Save Button -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-info btn-sm">
                                        <i class="bi bi-save"></i> Simpan Konfigurasi Telegram
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="btn-test-telegram">
                                        <i class="bi bi-check-circle"></i> Test Koneksi Telegram
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Info Monitoring -->
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-bell"></i> Fitur Monitoring
                            </h6>
                            <div class="small">
                                <ul class="list-unstyled mb-0">
                                    <li><i class="bi bi-check-circle text-success"></i> PPPoE Login/Logout</li>
                                    <li><i class="bi bi-check-circle text-success"></i> RX Power Alerts</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Connection Monitoring</li>
                                </ul>
                                <div class="alert alert-warning alert-custom mt-2 mb-0">
                                    <small>
                                        <strong>Catatan:</strong> Bot ini khusus untuk monitoring saja. 
                                        Fitur billing tetap menggunakan WhatsApp Bot.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kolom 2e: WhatsApp Commands (lanjutan dari WhatsApp Gateway) -->
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="form-section">
                        <h5 class="mb-3">
                            <i class="bi bi-whatsapp text-success"></i> Perintah Admin WhatsApp
                        </h5>

                        <!-- Perintah Admin WhatsApp -->
                        <div class="mt-2">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-info-circle"></i> Daftar Perintah
                            </h6>
                            
                            <!-- GenieACS Commands -->
                            <div class="command-card mb-2">
                                <div class="command-title text-success">
                                    <i class="bi bi-hdd-network"></i> GenieACS
                                </div>
                                <div class="command-list">
                                    <ul class="list-unstyled mb-0 small">
                                        <li><code>devices</code> - Daftar perangkat</li>
                                        <li><code>cekall</code> - Cek semua perangkat</li>
                                        <li><code>search [nomor]</code> - Cari perangkat</li>
                                        <li><code>cek [nomor]</code> - Cek status ONU</li>
                                        <li><code>cekstatus [nomor]</code> - Cek status pelanggan</li>
                                        <li><code>admincheck [nomor]</code> - Cek perangkat admin</li>
                                        <li><code>gantissid [nomor] [ssid]</code> - Ubah SSID</li>
                                        <li><code>gantipass [nomor] [pass]</code> - Ubah password</li>
                                        <li><code>reboot [nomor]</code> - Restart ONU</li>
                                        <li><code>factory reset [nomor]</code> - Reset factory</li>
                                        <li><code>refresh</code> - Refresh data perangkat</li>
                                        <li><code>tag [nomor] [tag]</code> - Tambah tag pelanggan</li>
                                        <li><code>untag [nomor] [tag]</code> - Hapus tag</li>
                                        <li><code>tags [nomor]</code> - Lihat tags</li>
                                        <li><code>adminssid [nomor] [ssid]</code> - Admin ubah SSID</li>
                                        <li><code>adminrestart [nomor]</code> - Admin restart ONU</li>
                                        <li><code>adminfactory [nomor]</code> - Admin factory reset</li>
                                        <li><code>confirm admin factory reset [nomor]</code> - Konfirmasi factory reset</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- PPPoE Commands -->
                            <div class="command-card mb-2">
                                <div class="command-title text-primary">
                                    <i class="bi bi-router"></i> PPPoE & Mikrotik
                                </div>
                                <div class="command-list">
                                    <ul class="list-unstyled mb-0 small">
                                        <li><code>interfaces</code> - Daftar interface</li>
                                        <li><code>interface [nama]</code> - Detail interface</li>
                                        <li><code>enableif [nama]</code> - Aktifkan interface</li>
                                        <li><code>disableif [nama]</code> - Nonaktifkan interface</li>
                                        <li><code>ipaddress</code> - Alamat IP</li>
                                        <li><code>routes</code> - Tabel routing</li>
                                        <li><code>dhcp</code> - DHCP leases</li>
                                        <li><code>ping [ip] [count]</code> - Test ping</li>
                                        <li><code>logs [topics] [count]</code> - Log Mikrotik</li>
                                        <li><code>firewall [chain]</code> - Status firewall</li>
                                        <li><code>users</code> - Daftar semua user</li>
                                        <li><code>profiles [type]</code> - Daftar profile</li>
                                        <li><code>identity [nama]</code> - Info router</li>
                                        <li><code>clock</code> - Waktu router</li>
                                        <li><code>resource</code> - Info resource</li>
                                        <li><code>reboot</code> - Restart router</li>
                                        <li><code>confirm restart</code> - Konfirmasi restart</li>
                                        <li><code>addtag [device_id] [nomor]</code> - Tambah tag perangkat</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Hotspot & PPPoE Management -->
                            <div class="command-card mb-2">
                                <div class="command-title text-warning">
                                    <i class="bi bi-wifi"></i> Hotspot & PPPoE Management
                                </div>
                                <div class="command-list">
                                    <ul class="list-unstyled mb-0 small">
                                        <li><code>vcr [user] [profile] [nomor]</code> - Buat voucher</li>
                                        <li><code>hotspot</code> - User hotspot aktif</li>
                                        <li><code>pppoe</code> - User PPPoE aktif</li>
                                        <li><code>offline</code> - User PPPoE offline</li>
                                        <li><code>addhotspot [user] [pass] [profile]</code> - Tambah user</li>
                                        <li><code>addpppoe [user] [pass] [profile] [ip]</code> - Tambah PPPoE</li>
                                        <li><code>setprofile [user] [profile]</code> - Ubah profile</li>
                                        <li><code>delhotspot [username]</code> - Hapus user hotspot</li>
                                        <li><code>delpppoe [username]</code> - Hapus user PPPoE</li>
                                        <li><code>addpppoe_tag [user] [nomor]</code> - Tambah tag PPPoE</li>
                                        <li><code>member [username] [profile] [nomor]</code> - Tambah member</li>
                                        <li><code>list</code> - Daftar semua user</li>
                                        <li><code>remove [username]</code> - Hapus user (generic)</li>
                                        <li><code>addadmin [nomor]</code> - Tambah nomor admin</li>
                                        <li><code>removeadmin [nomor]</code> - Hapus nomor admin</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Sistem & Admin -->
                            <div class="command-card mb-2">
                                <div class="command-title text-info">
                                    <i class="bi bi-shield-check"></i> Sistem & Admin
                                </div>
                                <div class="command-list">
                                    <ul class="list-unstyled mb-0 small">
                                        <li><code>otp [nomor]</code> - Kirim OTP</li>
                                        <li><code>status</code> - Status sistem</li>
                                        <li><code>logs</code> - Log aplikasi</li>
                                        <li><code>restart</code> - Restart aplikasi</li>
                                        <li><code>debug resource</code> - Debug resource</li>
                                        <li><code>checkgroup</code> - Cek status group</li>
                                        <li><code>setadmin [nomor]</code> - Set nomor admin</li>
                                        <li><code>settechnician [nomor]</code> - Set nomor teknisi</li>
                                        <li><code>setheader [teks]</code> - Set header pesan</li>
                                        <li><code>setfooter [teks]</code> - Set footer pesan</li>
                                        <li><code>setgenieacs [url] [user] [pass]</code> - Set GenieACS</li>
                                        <li><code>setmikrotik [host] [port] [user] [pass]</code> - Set Mikrotik</li>
                                        <li><code>genieacs stop</code> - Stop GenieACS</li>
                                        <li><code>genieacs start060111</code> - Start GenieACS</li>
                                        <li><code>admin</code> - Menu admin</li>
                                        <li><code>help</code> - Bantuan perintah</li>
                                        <li><code>ya/iya/yes</code> - Konfirmasi ya</li>
                                        <li><code>tidak/no/batal</code> - Konfirmasi tidak</li>
                                        <li><code>addwan [interface]</code> - Tambah WAN</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- WiFi & Layanan -->
                            <div class="command-card mb-0">
                                <div class="command-title text-secondary">
                                    <i class="bi bi-wifi"></i> WiFi & Layanan
                                </div>
                                <div class="command-list">
                                    <ul class="list-unstyled mb-0 small">
                                        <li><code>info wifi</code> - Info WiFi pelanggan</li>
                                        <li><code>info</code> - Info layanan</li>
                                        <li><code>gantiwifi [ssid]</code> - Ganti nama WiFi</li>
                                        <li><code>gantipass [password]</code> - Ganti password WiFi</li>
                                        <li><code>speedtest</code> - Test kecepatan</li>
                                        <li><code>diagnostic</code> - Diagnostik perangkat</li>
                                        <li><code>history</code> - Riwayat perangkat</li>
                                        <li><code>menu</code> - Menu utama</li>
                                        <li><code>factory reset</code> - Reset factory (pelanggan)</li>
                                        <li><code>confirm factory reset</code> - Konfirmasi factory reset</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal Konfirmasi Restart Mikrotik -->
<div class="modal fade" id="restartMikrotikModal" tabindex="-1" aria-labelledby="restartMikrotikModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restartMikrotikModalLabel"><i class="bi bi-arrow-repeat"></i> Konfirmasi Restart Mikrotik</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Apakah Anda yakin ingin <b>restart Mikrotik</b>?<br>Router akan reboot dan koneksi internet pelanggan akan terputus sementara.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmRestartMikrotik">Restart</button>
      </div>
    </div>
  </div>
</div>
<!-- Notifikasi -->
<div id="restartNotif" class="alert d-none position-fixed top-0 end-0 m-4" style="z-index:1055; min-width:300px;"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Load QRCode.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
$(function() {
    // Fungsi untuk mendapatkan label yang user-friendly
    function getFieldLabel(key) {
        const fieldLabels = {
            'auto_suspension_enabled': 'Auto Suspension (Isolir Otomatis)',
            'suspension_grace_period_days': 'Grace Period Suspension (Hari)',
            'default_pppoe_profile': 'Profile PPPoE Default',
            'admins.0': 'Nomor Admin Utama',
            'admins.1': 'Nomor Admin Tambahan 1',
            'admins.2': 'Nomor Admin Tambahan 2',
            'technician_numbers.0': 'Nomor Teknisi 1',
            'technician_numbers.1': 'Nomor Teknisi 2',
            'technician_numbers.2': 'Nomor Teknisi 3',
            'admin_username': 'Username Admin',
            'admin_password': 'Password Admin',
            'pppoe_monitor_enable': 'Monitor PPPoE',
            'pppoe_monitor_interval_minutes': 'Interval Monitor PPPoE (Menit)',
            'whatsapp_keep_alive': 'WhatsApp Keep Alive',
            'whatsapp_restart_on_error': 'Restart WhatsApp on Error',
            'rx_power_warning': 'RX Power Warning (dBm)',
            'rx_power_critical': 'RX Power Critical (dBm)',
            'rx_power_notification_enable': 'Notifikasi RX Power',
            'rx_power_warning_interval_hours': 'Interval Peringatan RX Power (Jam)',
            'company_header': 'Header Perusahaan',
            'app_name': 'Nama Aplikasi',
            'footer_info': 'Info Footer',
            'customerPortalOtp': 'OTP Customer Portal',
            'otp_length': 'Panjang OTP',
            'otp_expiry_minutes': 'Masa Berlaku OTP (Menit)',
            'server_host': 'Host Server',
            'trouble_report.enabled': 'Laporan Gangguan',
            'trouble_report.categories': 'Kategori Laporan',
            'trouble_report.auto_ticket': 'Auto Ticket',
            'rxpower_recap_enable': 'Ringkasan RX Power',
            'rxpower_recap_interval_hours': 'Interval Ringkasan RX Power (Jam)',
            'offline_notification_enable': 'Notifikasi Perangkat Offline',
            'offline_notification_interval_hours': 'Interval Notifikasi Offline (Jam)',
            'offline_device_threshold_hours': 'Batas Waktu Offline (Jam)',
            'tax_settings.default_tax_rate': 'PPN Default (%)',
            'tax_settings.tax_name': 'Nama Pajak',
            'tax_settings.tax_enabled': 'Sistem PPN',
            'tax_settings.tax_inclusive': 'Harga Sudah Termasuk PPN',
            'voucher_validity_log_enabled': 'Log Voucher Validity'
        };
        return fieldLabels[key] || key;
    }

    // Field yang tidak perlu ditampilkan di form settings
    // Hanya menyembunyikan field teknis yang tidak perlu diubah di server baru
    const hiddenFields = [
        // Version Info - Tidak perlu diubah manual
        'app_version', 'version_name', 'version_date', 'version_notes', 'build_number',
        
        // Interval Settings (millisecond format) - hanya tampilkan format jam
        'rx_power_warning_interval', 'rxpower_recap_interval', 'offline_notification_interval',
        
        // Mode Autentikasi - sudah dialihkan ke /admin/radius
        'user_auth_mode',
        
        // Duplicate/Alternative Fields
        'pppoe_notifications.enabled', 'pppoe_notifications.loginNotifications', 
        'pppoe_notifications.logoutNotifications', 'pppoe_notifications.includeOfflineList',
        'pppoe_notifications.maxOfflineListCount',
        
        // GenieACS Settings - Dikelola via /admin/genieacs-servers dan /admin/routers
        'genieacs_url', 'genieacs_username', 'genieacs_password',
        
        // Mikrotik Settings - Dikelola via /admin/routers
        'mikrotik_host', 'mikrotik_port', 'mikrotik_user', 'mikrotik_password', 'main_interface',
        
        // Voucher Cleanup Settings - Dikelola secara internal
        'voucher_cleanup.enabled',
        'voucher_cleanup.expiry_hours',
        'voucher_cleanup.delete_expired_invoices',
        'voucher_cleanup.log_cleanup_actions',
        'voucher_cleanup.cleanup_interval_hours',
        
        // WhatsApp Rate Limit Settings - Dikelola secara internal
        'whatsapp_rate_limit.maxMessagesPerBatch',
        'whatsapp_rate_limit.delayBetweenBatches',
        'whatsapp_rate_limit.delayBetweenMessages',
        'whatsapp_rate_limit.maxRetries',
        'whatsapp_rate_limit.dailyMessageLimit',
        'whatsapp_rate_limit.enabled',
        
        // Billing QR Filename - Dikelola via upload form
        'billing_qr_filename',
        
        // SMTP Settings - Dikelola via form SMTP Email Configuration
        'smtp_host',
        'smtp_port',
        'smtp_secure',
        'smtp_user',
        'smtp_password',
        'smtp_reject_unauthorized',
        'smtp_from_email',
        'smtp_from_name'
    ];

    // Keterangan bahasa Indonesia untuk setiap pengaturan
    function getFieldDescription(key) {
        const descriptions = {
            'auto_suspension_enabled': 'Aktifkan isolir otomatis untuk pelanggan yang tidak membayar',
            'suspension_grace_period_days': 'Jumlah hari sebelum layanan disuspend setelah jatuh tempo',
            'default_pppoe_profile': 'Profile PPPoE yang akan digunakan untuk pelanggan baru',
            'isolir_profile': 'Profile PPPoE untuk pelanggan yang diisolir',
            'static_ip_suspension_method': 'Metode untuk suspend IP statis (address_list atau disable)',
            'suspension_bandwidth_limit': 'Batas bandwidth untuk pelanggan yang diisolir (contoh: 1k/1k)',
            'admins.0': 'Nomor WhatsApp admin utama untuk menerima notifikasi',
            'admins.1': 'Nomor WhatsApp admin tambahan (opsional)',
            'admin_username': 'Username untuk login ke admin panel',
            'admin_password': 'Password untuk login ke admin panel',
            'pppoe_monitor_enable': 'Aktifkan monitoring koneksi PPPoE secara real-time',
            'technician_numbers.0': 'Nomor WhatsApp teknisi pertama',
            'technician_numbers.1': 'Nomor WhatsApp teknisi kedua',
            'technician_group_id': 'ID grup WhatsApp untuk teknisi',
            'whatsapp_keep_alive': 'Pertahankan koneksi WhatsApp tetap aktif',
            'whatsapp_restart_on_error': 'Restart otomatis WhatsApp jika terjadi error',
            'rx_power_warning': 'Threshold RX Power untuk peringatan (dBm)',
            'rx_power_critical': 'Threshold RX Power untuk kondisi kritis (dBm)',
            'rx_power_notification_enable': 'Aktifkan notifikasi monitoring RX Power',
            'rx_power_warning_interval_hours': 'Interval pengecekan RX Power (dalam jam)',
            'company_header': 'Header yang ditampilkan di aplikasi',
            'app_name': 'Nama aplikasi yang ditampilkan',
            'footer_info': 'Informasi footer aplikasi',
            'customerPortalOtp': 'Aktifkan OTP untuk customer portal',
            'otp_length': 'Panjang kode OTP (4-6 digit)',
            'otp_expiry_minutes': 'Masa berlaku OTP dalam menit',
            'server_host': 'Alamat IP atau hostname server',
            'trouble_report.enabled': 'Aktifkan fitur laporan gangguan',
            'trouble_report.categories': 'Kategori laporan gangguan (pisahkan dengan koma)',
            'trouble_report.auto_ticket': 'Buat tiket otomatis untuk laporan gangguan',
            'rxpower_recap_enable': 'Aktifkan ringkasan RX Power harian',
            'rxpower_recap_interval_hours': 'Interval pengiriman ringkasan RX Power (dalam jam)',
            'offline_notification_enable': 'Aktifkan notifikasi perangkat offline',
            'offline_notification_interval_hours': 'Interval pengecekan perangkat offline (dalam jam)',
            'offline_device_threshold_hours': 'Batas waktu perangkat dianggap offline (dalam jam)',
            'tax_settings.default_tax_rate': 'Tarif PPN default dalam persen',
            'tax_settings.tax_name': 'Nama pajak yang ditampilkan (contoh: PPN)',
            'tax_settings.tax_enabled': 'Aktifkan sistem PPN',
            'tax_settings.tax_inclusive': 'Harga sudah termasuk PPN',
            'user_auth_mode': 'Mode autentikasi user (mikrotik atau local)',
            'server_port': 'Port server aplikasi',
            'logo_filename': 'Nama file logo perusahaan',
            'company_website': 'Website perusahaan',
            'company_slogan': 'Slogan perusahaan',
            'invoice_notes': 'Catatan yang ditampilkan di invoice',
            'payment_bank_name': 'Nama bank untuk pembayaran',
            'payment_account_number': 'Nomor rekening bank',
            'payment_account_holder': 'Nama pemilik rekening',
            'payment_cash_address': 'Alamat untuk pembayaran tunai',
            'payment_cash_hours': 'Jam operasional untuk pembayaran tunai',
            'contact_phone': 'Nomor telepon kontak',
            'contact_email': 'Email kontak perusahaan',
            'contact_address': 'Alamat perusahaan',
            'contact_whatsapp': 'Nomor WhatsApp kontak',
            'whatsapp_rate_limit.maxMessagesPerBatch': 'Maksimal pesan per batch WhatsApp',
            'whatsapp_rate_limit.delayBetweenBatches': 'Jeda antar batch pesan (detik)',
            'whatsapp_rate_limit.delayBetweenMessages': 'Jeda antar pesan individual (detik)',
            'whatsapp_rate_limit.maxRetries': 'Maksimal percobaan ulang jika gagal',
            'whatsapp_rate_limit.dailyMessageLimit': 'Batas pesan harian (0 = tidak terbatas)',
            'whatsapp_rate_limit.enabled': 'Aktifkan pembatasan tingkat pesan WhatsApp',
            'voucher_validity_log_enabled': 'Aktifkan log monitoring Voucher Validity. Jika OFF, fungsi tetap berjalan tapi tidak menampilkan log di monitor'
        };
        return descriptions[key] || '';
    }
    // Ambil data settings.json
    $.get('/admin/settings/data', function(data) {
        var html = '';
        function renderField(key, val) {
            // Sembunyikan field tertentu
            if (hiddenFields.includes(key)) return;
            
            // Sembunyikan whatsapp_daily_count.* (semua key yang dimulai dengan whatsapp_daily_count)
            if (key.startsWith('whatsapp_daily_count.')) return;
            
            // Sembunyikan payment_gateway.* (semua key yang dimulai dengan payment_gateway.)
            // Karena sudah dikelola di /admin/billing/payment-settings
            if (key.startsWith('payment_gateway.')) return;
            
            if (typeof val === 'object' && val !== null) {
                Object.keys(val).forEach(function(subkey) {
                    renderField(key + '.' + subkey, val[subkey]);
                });
            } else {
                html += '<div class="mb-3">';
                // Skip user_auth_mode karena sudah dialihkan ke /admin/radius
                if (key === 'user_auth_mode') {
                    return; // Jangan render field ini
                } else if (typeof val === 'boolean' || val === true || val === false || val === 'true' || val === 'false') {
                    var checked = (val === true || val === 'true') ? 'checked' : '';
                    var fieldLabel = getFieldLabel(key);
                    var fieldDescription = getFieldDescription(key);
                    html += '<label class="form-label">'+fieldLabel+'</label>';
                    
                    // Tambahkan keterangan jika tersedia
                    if (fieldDescription) {
                        html += '<div class="form-text text-muted mb-2">'+fieldDescription+'</div>';
                    }
                    
                    html += '<div class="form-check">';
                    html += '<input class="form-check-input" type="checkbox" name="'+key+'" id="setting_'+key+'" '+checked+'> ';
                    html += '<label class="form-check-label" for="setting_'+key+'">'+(checked ? 'Aktif' : 'Tidak Aktif')+'</label>';
                    html += '</div>';
                } else {
                    var fieldLabel = getFieldLabel(key);
                    var fieldDescription = getFieldDescription(key);
                    html += '<label class="form-label">'+fieldLabel+'</label>';
                    
                    // Tambahkan keterangan jika tersedia
                    if (fieldDescription) {
                        html += '<div class="form-text text-muted mb-2">'+fieldDescription+'</div>';
                    }
                    
                    if (key === 'suspension_grace_period_days') {
                        html += '<input type="number" class="form-control" name="'+key+'" value="'+val+'" min="1" max="365">';
                    } else if (key === 'tax_settings.default_tax_rate') {
                        html += '<input type="number" class="form-control" name="'+key+'" value="'+val+'" step="0.01" min="0" max="100">';
                    } else if (key === 'tax_settings.tax_name') {
                        html += '<input type="text" class="form-control" name="'+key+'" value="'+val+'">';
                    } else if (key === 'tax_settings.tax_enabled') {
                        var checked = (val === true || val === 'true') ? 'checked' : '';
                        html += '<div class="form-check">';
                        html += '<input class="form-check-input" type="checkbox" name="'+key+'" id="setting_'+key+'" '+checked+'> ';
                        html += '<label class="form-check-label" for="setting_'+key+'">'+(checked ? 'Aktif' : 'Tidak Aktif')+'</label>';
                        html += '</div>';
                    } else if (key === 'tax_settings.tax_inclusive') {
                        var checked = (val === true || val === 'true') ? 'checked' : '';
                        html += '<div class="form-check">';
                        html += '<input class="form-check-input" type="checkbox" name="'+key+'" id="setting_'+key+'" '+checked+'> ';
                        html += '<label class="form-check-label" for="setting_'+key+'">'+(checked ? 'Ya' : 'Tidak')+'</label>';
                        html += '</div>';
                        html += '<div class="form-text">Harga paket sudah termasuk PPN (tax inclusive) atau belum (tax exclusive)</div>';
                    } else if (key.includes('password') || key.includes('Password')) {
                        // Field password - gunakan input type="password"
                        html += '<input type="password" class="form-control" name="'+key+'" value="'+val+'" placeholder="Masukkan password">';
                        html += '<div class="form-text text-warning">‚ö†Ô∏è Hati-hati saat mengubah password. Pastikan password benar untuk menghindari error koneksi.</div>';
                    } else {
                        html += '<input type="text" class="form-control" name="'+key+'" value="'+val+'">';
                    }
                }
                html += '</div>';
            }
        }
        Object.keys(data).forEach(function(key) {
            renderField(key, data[key]);
        });
        $('#settingsFields').html(html);
    });
    // Submit form settings
    $('#settingsForm').on('submit', function(e) {
        e.preventDefault();
        
        // Disable submit button untuk mencegah multiple submission
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Menyimpan...');
        
        var formData = {};
        var hasChanges = false;
        
        // Handle semua input text dan checkbox
        $('#settingsForm').find('input[type=text],input[type=checkbox],input[type=number],input[type=password]').each(function() {
            var name = $(this).attr('name');
            if (!name) return;
            
            let value;
            if ($(this).attr('type') === 'checkbox') {
                value = $(this).is(':checked');
            } else {
                value = $(this).val();
            }
            
            formData[name] = value;
            hasChanges = true;
        });
        
        // Handle radio button (hanya yang checked)
        $('#settingsForm').find('input[type=radio]:checked').each(function() {
            var name = $(this).attr('name');
            if (!name) return;
            formData[name] = $(this).val();
            hasChanges = true;
        });
        
        // Validasi apakah ada perubahan
        if (!hasChanges || Object.keys(formData).length === 0) {
            $('#settingsSuccess').removeClass('d-none').addClass('alert-warning').text('Tidak ada perubahan untuk disimpan.');
            setTimeout(function() {
                $('#settingsSuccess').addClass('d-none').removeClass('alert-warning');
            }, 3000);
            submitBtn.prop('disabled', false).html(originalText);
            return;
        }
        
        $.ajax({
            url: '/admin/settings/save',
            method: 'POST',
            data: formData,
            timeout: 10000, // 10 detik timeout
            success: function(res) {
                if (res.success) {
                    $('#settingsSuccess').removeClass('d-none').text(res.message || 'Pengaturan berhasil disimpan!');
                    setTimeout(function() {
                        $('#settingsSuccess').addClass('d-none');
                    }, 3000);
                } else {
                    $('#settingsSuccess').removeClass('d-none').addClass('alert-danger').text(res.error || 'Gagal menyimpan pengaturan!');
                    setTimeout(function() {
                        $('#settingsSuccess').addClass('d-none').removeClass('alert-danger');
                    }, 5000);
                }
            },
            error: function(xhr, status, error) {
                let errorMsg = 'Gagal menyimpan pengaturan!';
                
                if (status === 'timeout') {
                    errorMsg = 'Request timeout. Silakan coba lagi.';
                } else if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (xhr.status === 500) {
                    errorMsg = 'Terjadi kesalahan server. Silakan coba lagi.';
                } else if (xhr.status === 400) {
                    errorMsg = 'Data tidak valid. Silakan periksa input Anda.';
                } else if (xhr.status === 0) {
                    errorMsg = 'Tidak dapat terhubung ke server. Periksa koneksi Anda.';
                }
                
                $('#settingsSuccess').removeClass('d-none').addClass('alert-danger').text(errorMsg);
                setTimeout(function() {
                    $('#settingsSuccess').addClass('d-none').removeClass('alert-danger');
                }, 5000);
            },
            complete: function() {
                // Re-enable submit button
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
    // WhatsApp QR & Status
    function loadWAStatus() {
        $.ajax({
            url: '/admin/settings/wa-status',
            method: 'GET',
            dataType: 'json',
            success: function(res) {
                console.log('WA Status Response:', res); // Debug log
                
                // Update status koneksi
                if (res.connected) {
                    let statusHtml = '<span class="badge bg-success status-badge"><i class="bi bi-check-circle"></i> Terhubung';
                    if (res.phoneNumber) {
                        statusHtml += ` (${res.phoneNumber})`;
                    }
                    if (res.connectedSince) {
                        const connectedDate = new Date(res.connectedSince);
                        statusHtml += `<br><small>Terhubung sejak: ${connectedDate.toLocaleString()}</small>`;
                    }
                    statusHtml += '</span>';
                    $('#wa-status').html(statusHtml);
                    $('#wa-qr-container').addClass('d-none');
                } else {
                    $('#wa-status').html('<span class="badge bg-warning text-dark status-badge"><i class="bi bi-exclamation-triangle"></i> Belum Terhubung</span>');
                    
                    // Tampilkan QR code jika tersedia
                    if (res.qr) {
                        console.log('QR Code received, length:', res.qr.length);
                        $('#wa-qr-container').removeClass('d-none');
                        
                        // Hapus QR lama jika ada
                        $('#wa-qr').attr('src', '').hide();
                        const qrDiv = $('#wa-qr-div');
                        qrDiv.empty().show();
                        
                        try {
                            // Coba buat QR code langsung
                            new QRCode(qrDiv[0], {
                                text: res.qr,
                                width: 220,
                                height: 220,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: 2
                            });
                            console.log('QR Code generated successfully');
                        } catch (e) {
                            console.error('Error generating QR code:', e);
                            // Fallback: area kosong saja, tidak tampilkan pesan apapun
                            qrDiv.html("");
                        }
                    } else {
                        console.log('No QR code received from server');
                        $('#wa-qr-container').addClass('d-none');
                        if (res.error) {
                            $('#wa-status').append(`<div class="alert alert-danger mt-2">${res.error}</div>`);
                        }
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error getting WhatsApp status:', error);
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : error;
                $('#wa-status').html(`
                    <span class="badge bg-danger status-badge">
                        <i class="bi bi-x-circle"></i> Gagal memuat status
                    </span>
                    <div class="alert alert-danger mt-2">${errorMsg || 'Tidak dapat terhubung ke server'}</div>
                `);
                $('#wa-qr-container').addClass('d-none');
            }
        });
    }
    loadWAStatus();
    $('#btnRefreshQR').on('click', function(e) {
        e.preventDefault();
        $.post('/admin/settings/wa-refresh', function() {
            loadWAStatus();
        });
    });
    $('#btnDeleteSession').on('click', function(e) {
        e.preventDefault();
        if (confirm('Yakin hapus sesi WhatsApp?')) {
            $.post('/admin/settings/wa-delete', function() {
                loadWAStatus();
            });
        }
    });
    // Auto refresh status tiap 10 detik
    setInterval(loadWAStatus, 10000);

    // ========== Gateway Configuration ==========

    // Load gateway configuration from settings
    function loadGatewayConfig() {
        $.get('/admin/settings/data', function(data) {
            // Set primary gateway
            if (data.whatsapp_primary_gateway) {
                $('#whatsapp_primary_gateway').val(data.whatsapp_primary_gateway);
            }
            
            // Set Fonnte config
            if (data.fonnte_api_key) {
                $('#fonnte_api_key').val(data.fonnte_api_key);
            }
            if (data.fonnte_api_url) {
                $('#fonnte_api_url').val(data.fonnte_api_url);
            } else {
                $('#fonnte_api_url').val('https://api.fonnte.com');
            }
            if (data.fonnte_delay) {
                $('#fonnte_delay').val(data.fonnte_delay);
            } else {
                $('#fonnte_delay').val('1000');
            }
        });
    }

    // Load gateway status
    function loadGatewayStatus() {
        $.get('/admin/settings/wa-status', function(res) {
            let statusHtml = '<div class="small">';
            
            if (res.gateway) {
                const g = res.gateway;
                
                // Primary & Active
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Primary:</strong> <span class="badge bg-primary">${g.primary || 'baileys'}</span> `;
                statusHtml += `<strong>Active:</strong> <span class="badge ${g.isFallback ? 'bg-warning' : 'bg-success'}">${g.active || 'none'}</span>`;
                if (g.isFallback) {
                    statusHtml += ` <span class="badge bg-warning">Fallback</span>`;
                }
                statusHtml += `</div>`;
                
                // Baileys Status
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Baileys:</strong> `;
                if (g.baileys && g.baileys.connected) {
                    statusHtml += `<span class="badge bg-success">Connected</span>`;
                    if (g.baileys.phoneNumber) {
                        statusHtml += ` <small>${g.baileys.phoneNumber}</small>`;
                    }
                } else {
                    const baileysStatus = (g.baileys && g.baileys.status) ? g.baileys.status : 'No Connection';
                    statusHtml += `<span class="badge bg-danger">${baileysStatus}</span>`;
                }
                statusHtml += `</div>`;
                
                // Fonnte Status
                statusHtml += `<div class="mb-0">`;
                statusHtml += `<strong>Fonnte:</strong> `;
                if (g.fonnte && g.fonnte.connected) {
                    statusHtml += `<span class="badge bg-success">Connected</span>`;
                    if (g.fonnte.phoneNumber) {
                        statusHtml += ` <small>${g.fonnte.phoneNumber}</small>`;
                    }
                } else {
                    const fonnteStatus = (g.fonnte && g.fonnte.status) ? g.fonnte.status : 'No Connection';
                    const badgeClass = (g.fonnte && g.fonnte.available) ? 'bg-warning' : 'bg-secondary';
                    statusHtml += `<span class="badge ${badgeClass}">${fonnteStatus}</span>`;
                    if (g.fonnte && g.fonnte.lastError) {
                        statusHtml += ` <small class="text-danger">(${g.fonnte.lastError})</small>`;
                    }
                }
                statusHtml += `</div>`;
            } else {
                // Jika tidak ada data gateway, tampilkan status "No Connection" untuk kedua gateway
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Primary:</strong> <span class="badge bg-primary">baileys</span> `;
                statusHtml += `<strong>Active:</strong> <span class="badge bg-secondary">none</span>`;
                statusHtml += `</div>`;
                
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Baileys:</strong> <span class="badge bg-danger">No Connection</span>`;
                statusHtml += `</div>`;
                
                statusHtml += `<div class="mb-0">`;
                statusHtml += `<strong>Fonnte:</strong> <span class="badge bg-secondary">No Connection</span>`;
                statusHtml += `</div>`;
            }
            
            statusHtml += '</div>';
            $('#gateway-status-display').html(statusHtml);
        }).fail(function(xhr, status, error) {
            // Tampilkan status "No Connection" meskipun request gagal
            let statusHtml = '<div class="small">';
            statusHtml += `<div class="mb-2">`;
            statusHtml += `<strong>Primary:</strong> <span class="badge bg-primary">baileys</span> `;
            statusHtml += `<strong>Active:</strong> <span class="badge bg-secondary">none</span>`;
            statusHtml += `</div>`;
            statusHtml += `<div class="mb-2">`;
            statusHtml += `<strong>Baileys:</strong> <span class="badge bg-danger">No Connection</span>`;
            statusHtml += `</div>`;
            statusHtml += `<div class="mb-0">`;
            statusHtml += `<strong>Fonnte:</strong> <span class="badge bg-secondary">No Connection</span>`;
            statusHtml += `</div>`;
            statusHtml += '</div>';
            $('#gateway-status-display').html(statusHtml);
        });
    }

    // Load SMTP Configuration
    function loadSMTPConfig() {
        $.get('/admin/settings/data', function(data) {
            if (data.smtp_host) $('#smtp_host').val(data.smtp_host);
            if (data.smtp_port) $('#smtp_port').val(data.smtp_port);
            if (data.smtp_secure !== undefined) {
                $('#smtp_secure').val(data.smtp_secure === true || data.smtp_secure === 'true' ? 'true' : 'false');
            }
            if (data.smtp_user) $('#smtp_user').val(data.smtp_user);
            if (data.smtp_password) $('#smtp_password').val(data.smtp_password);
            if (data.smtp_from_email) $('#smtp_from_email').val(data.smtp_from_email);
            if (data.smtp_from_name) $('#smtp_from_name').val(data.smtp_from_name);
            if (data.smtp_reject_unauthorized !== undefined) {
                $('#smtp_reject_unauthorized').prop('checked', data.smtp_reject_unauthorized !== false && data.smtp_reject_unauthorized !== 'false');
            }
        });
    }
    
    // Test SMTP Connection
    $('#btnTestSMTP').on('click', function() {
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Testing...');
        
        const smtpData = {
            smtp_host: $('#smtp_host').val(),
            smtp_port: parseInt($('#smtp_port').val()) || 587,
            smtp_secure: $('#smtp_secure').val() === 'true',
            smtp_user: $('#smtp_user').val(),
            smtp_password: $('#smtp_password').val(),
            smtp_reject_unauthorized: $('#smtp_reject_unauthorized').is(':checked')
        };
        
        // Validate required fields
        if (!smtpData.smtp_host || !smtpData.smtp_user || !smtpData.smtp_password) {
            const resultDiv = $('#smtpTestResult');
            resultDiv.removeClass('d-none alert-success alert-info').addClass('alert-danger');
            resultDiv.html('<i class="bi bi-x-circle"></i> <strong>Error:</strong> Harap isi SMTP Host, User, dan Password terlebih dahulu');
            btn.prop('disabled', false).html(originalText);
            return;
        }
        
        // Save temporarily for test
        $.post('/admin/settings/save', smtpData, function(response) {
            if (response.success) {
                // Wait a moment for settings to be saved
                setTimeout(function() {
                    // Test connection
                    $.post('/admin/billing/email-settings/status', {}, function(testResponse) {
                        const resultDiv = $('#smtpTestResult');
                        resultDiv.removeClass('d-none');
                        
                        if (testResponse.success && testResponse.connectionStatus === 'Connected') {
                            resultDiv.removeClass('alert-danger alert-info').addClass('alert-success');
                            resultDiv.html('<i class="bi bi-check-circle"></i> <strong>SMTP Connection Successful!</strong> Email notification siap digunakan.');
                        } else {
                            resultDiv.removeClass('alert-success alert-info').addClass('alert-danger');
                            const errorMsg = testResponse.connectionError || testResponse.message || 'Unknown error';
                            resultDiv.html('<i class="bi bi-x-circle"></i> <strong>SMTP Connection Failed:</strong> ' + errorMsg);
                        }
                    }).fail(function(xhr, status, error) {
                        const resultDiv = $('#smtpTestResult');
                        resultDiv.removeClass('d-none alert-success alert-info').addClass('alert-danger');
                        let errorMsg = 'Gagal menguji koneksi SMTP';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                errorMsg = errorData.message || errorMsg;
                            } catch (e) {
                                errorMsg = error || errorMsg;
                            }
                        }
                        resultDiv.html('<i class="bi bi-x-circle"></i> <strong>Error:</strong> ' + errorMsg);
                    });
                }, 500);
            } else {
                const resultDiv = $('#smtpTestResult');
                resultDiv.removeClass('d-none alert-success alert-info').addClass('alert-danger');
                resultDiv.html('<i class="bi bi-x-circle"></i> <strong>Error:</strong> ' + (response.message || 'Gagal menyimpan konfigurasi'));
            }
        }).fail(function(xhr, status, error) {
            const resultDiv = $('#smtpTestResult');
            resultDiv.removeClass('d-none alert-success alert-info').addClass('alert-danger');
            let errorMsg = 'Gagal menyimpan konfigurasi SMTP';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            resultDiv.html('<i class="bi bi-x-circle"></i> <strong>Error:</strong> ' + errorMsg);
        }).always(function() {
            btn.prop('disabled', false).html(originalText);
        });
    });
    
    // Save SMTP Configuration
    $('#smtpForm').on('submit', function(e) {
        e.preventDefault();
        
        const btn = $(this).find('button[type="submit"]');
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Menyimpan...');
        
        const smtpData = {
            smtp_host: $('#smtp_host').val(),
            smtp_port: parseInt($('#smtp_port').val()) || 587,
            smtp_secure: $('#smtp_secure').val() === 'true',
            smtp_user: $('#smtp_user').val(),
            smtp_password: $('#smtp_password').val(),
            smtp_from_email: $('#smtp_from_email').val(),
            smtp_from_name: $('#smtp_from_name').val(),
            smtp_reject_unauthorized: $('#smtp_reject_unauthorized').is(':checked')
        };
        
        $.post('/admin/settings/save', smtpData, function(response) {
            if (response.success) {
                showNotification('success', 'Konfigurasi SMTP berhasil disimpan!');
                // Reload email notification manager
                $.post('/admin/billing/email-settings/status', {}, function() {
                    // Status updated
                });
            } else {
                showNotification('danger', 'Error: ' + (response.message || 'Gagal menyimpan konfigurasi'));
            }
        }).always(function() {
            btn.prop('disabled', false).html(originalText);
        });
    });

    // Load config and status on page load
    loadGatewayConfig();
    loadSMTPConfig();
    loadGatewayStatus();
    setInterval(loadGatewayStatus, 10000); // Refresh every 10 seconds

    // Toggle show/hide Fonnte API key
    $('#toggle-fonnte-key').on('click', function() {
        const input = $('#fonnte_api_key');
        const icon = $('#eye-icon-fonnte');
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('bi-eye').addClass('bi-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('bi-eye-slash').addClass('bi-eye');
        }
    });

    // Submit gateway configuration form
    $('#gateway-config-form').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Menyimpan...');
        
        const formData = {};
        $(this).find('input, select').each(function() {
            const name = $(this).attr('name');
            if (name) {
                formData[name] = $(this).val();
            }
        });
        
        $.ajax({
            url: '/admin/settings/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                submitBtn.prop('disabled', false).html(originalText);
                if (response.success) {
                    alert('‚úÖ Konfigurasi gateway berhasil disimpan! Silakan restart aplikasi untuk menerapkan perubahan.');
                    loadGatewayStatus();
                } else {
                    alert('‚ùå Gagal menyimpan konfigurasi: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                submitBtn.prop('disabled', false).html(originalText);
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Gagal menyimpan konfigurasi';
                alert('‚ùå Error: ' + errorMsg);
            }
        });
    });

    // Test Fonnte connection
    $('#btn-test-fonnte').on('click', function() {
        const apiKey = $('#fonnte_api_key').val();
        const apiUrl = $('#fonnte_api_url').val() || 'https://api.fonnte.com';
        
        if (!apiKey) {
            alert('‚ö†Ô∏è Masukkan Fonnte API Key terlebih dahulu!');
            return;
        }
        
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Testing...');
        
        $.ajax({
            url: '/admin/settings/test-fonnte',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                fonnte_api_key: apiKey,
                fonnte_api_url: apiUrl
            }),
            success: function(response) {
                btn.prop('disabled', false).html(originalText);
                if (response.success) {
                    let message = '‚úÖ Koneksi Fonnte berhasil!';
                    if (response.message) {
                        message = response.message;
                    }
                    if (response.phoneNumber) {
                        message += '\nNomor: ' + response.phoneNumber;
                    }
                    if (response.warning) {
                        message += '\n\n‚ö†Ô∏è ' + response.warning;
                    }
                    alert(message);
                    loadGatewayStatus();
                } else {
                    alert('‚ùå Koneksi Fonnte gagal: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                btn.prop('disabled', false).html(originalText);
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Gagal test koneksi';
                alert('‚ùå Error: ' + errorMsg);
            }
        });
    });

    // ========== Telegram Bot Configuration ==========

    // Load Telegram Bot configuration from settings
    function loadTelegramConfig() {
        $.get('/admin/settings/data', function(data) {
            // Set bot token
            if (data.telegram_bot_token) {
                $('#telegram_bot_token').val(data.telegram_bot_token);
            }
            
            // Set monitoring enabled
            if (data.telegram_monitoring_enabled !== undefined) {
                $('#telegram_monitoring_enabled').prop('checked', data.telegram_monitoring_enabled !== false && data.telegram_monitoring_enabled !== 'false');
            } else {
                $('#telegram_monitoring_enabled').prop('checked', true);
            }
        });
    }

    // Load Telegram Bot status
    function loadTelegramStatus() {
        $.get('/admin/settings/telegram-status', function(res) {
            let statusHtml = '<div class="small">';
            
            if (res.success) {
                const status = res.status;
                
                // Connection Status
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Status:</strong> `;
                if (status.isConnected) {
                    statusHtml += `<span class="badge bg-success">Terhubung</span>`;
                } else {
                    statusHtml += `<span class="badge bg-danger">Tidak Terhubung</span>`;
                }
                statusHtml += `</div>`;
                
                // Total Chats
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Chat Terdaftar:</strong> <span class="badge bg-info">${status.totalChats || 0}</span>`;
                if (status.totalChats === 0) {
                    statusHtml += ` <span class="badge bg-danger">‚ö†Ô∏è Belum ada chat terdaftar!</span>`;
                }
                statusHtml += `</div>`;
                
                // Warning jika tidak ada chat terdaftar
                if (status.totalChats === 0) {
                    statusHtml += `<div class="alert alert-warning alert-sm mb-2 p-2">`;
                    statusHtml += `<small><strong>‚ö†Ô∏è Perhatian:</strong> Belum ada chat ID yang terdaftar!<br>`;
                    statusHtml += `Silakan kirim perintah <code>/start</code> ke bot di Telegram untuk mendaftarkan chat ID Anda.</small>`;
                    statusHtml += `</div>`;
                    
                    // Show warning in form
                    $('#telegram-no-chat-warning').show();
                } else {
                    // Hide warning if chat is registered
                    $('#telegram-no-chat-warning').hide();
                }
                
                // Monitoring Status
                statusHtml += `<div class="mb-2">`;
                statusHtml += `<strong>Monitoring:</strong> `;
                if (status.monitoringEnabled) {
                    statusHtml += `<span class="badge bg-success">Aktif</span>`;
                } else {
                    statusHtml += `<span class="badge bg-warning">Nonaktif</span>`;
                }
                statusHtml += `</div>`;
                
                // Features
                statusHtml += `<div class="mb-0">`;
                statusHtml += `<strong>Fitur:</strong><br>`;
                statusHtml += `<small>`;
                statusHtml += `PPPoE: ${status.pppoeMonitoring ? '‚úÖ' : '‚ùå'} `;
                statusHtml += `RX Power: ${status.rxPowerMonitoring ? '‚úÖ' : '‚ùå'} `;
                statusHtml += `Connection: ${status.connectionMonitoring ? '‚úÖ' : '‚ùå'}`;
                statusHtml += `</small>`;
                statusHtml += `</div>`;
            } else {
                statusHtml += `<div class="text-danger">`;
                statusHtml += `<i class="bi bi-exclamation-triangle"></i> Bot tidak dikonfigurasi atau error`;
                if (res.message) {
                    statusHtml += `<br><small>${res.message}</small>`;
                }
                statusHtml += `</div>`;
            }
            
            statusHtml += '</div>';
            $('#telegram-status-display').html(statusHtml);
        }).fail(function(xhr, status, error) {
            let statusHtml = '<div class="small text-danger">';
            statusHtml += `<i class="bi bi-exclamation-triangle"></i> Gagal memuat status`;
            statusHtml += '</div>';
            $('#telegram-status-display').html(statusHtml);
        });
    }

    // Toggle password visibility for Telegram token
    $('#toggle-telegram-token').on('click', function() {
        const input = $('#telegram_bot_token');
        const icon = $('#eye-icon-telegram');
        
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('bi-eye').addClass('bi-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('bi-eye-slash').addClass('bi-eye');
        }
    });

    // Submit Telegram configuration form
    $('#telegram-config-form').on('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Menyimpan...');
        
        const formData = {
            telegram_bot_token: $('#telegram_bot_token').val(),
            telegram_monitoring_enabled: $('#telegram_monitoring_enabled').is(':checked')
        };
        
        $.ajax({
            url: '/admin/settings/save',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                submitBtn.prop('disabled', false).html(originalText);
                if (response.success) {
                    alert('‚úÖ Konfigurasi Telegram Bot berhasil disimpan! Silakan restart aplikasi untuk menerapkan perubahan.');
                    loadTelegramStatus();
                } else {
                    alert('‚ùå Gagal menyimpan konfigurasi: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                submitBtn.prop('disabled', false).html(originalText);
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Gagal menyimpan konfigurasi';
                alert('‚ùå Error: ' + errorMsg);
            }
        });
    });

    // Test Telegram connection
    $('#btn-test-telegram').on('click', function() {
        const botToken = $('#telegram_bot_token').val();
        
        if (!botToken) {
            alert('‚ö†Ô∏è Masukkan Bot Token terlebih dahulu!');
            return;
        }
        
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Testing...');
        
        $.ajax({
            url: '/admin/settings/test-telegram',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                telegram_bot_token: botToken
            }),
            success: function(response) {
                btn.prop('disabled', false).html(originalText);
                if (response.success) {
                    let message = '‚úÖ Koneksi Telegram Bot berhasil!';
                    if (response.message) {
                        message = response.message;
                    }
                    if (response.botInfo) {
                        message += '\n\nBot Info:';
                        message += '\nNama: ' + (response.botInfo.first_name || 'N/A');
                        message += '\nUsername: @' + (response.botInfo.username || 'N/A');
                    }
                    alert(message);
                    loadTelegramStatus();
                } else {
                    alert('‚ùå Koneksi Telegram Bot gagal: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                btn.prop('disabled', false).html(originalText);
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Gagal test koneksi';
                alert('‚ùå Error: ' + errorMsg);
            }
        });
    });

    // Load Telegram config and status on page load
    loadTelegramConfig();
    loadTelegramStatus();
    
    // Auto refresh status every 10 seconds
    setInterval(loadTelegramStatus, 10000);
});
</script>
<script>
// Optical Splitter Attenuation Calculator Logic
$(function() {
    // Standar losses
    const fiberLossPerKm = 0.35;
    const connectorLoss = 0.5;
    const spliceLoss = 0.1;

    function calcAttenuation(N) {
        return +(10 * Math.log10(N)).toFixed(2);
    }
    function getTotalLoss() {
        const fiberLength = parseFloat($('#fiberLength').val()) || 0;
        const connectorCount = parseInt($('#connectorCount').val()) || 0;
        const spliceCount = parseInt($('#spliceCount').val()) || 0;
        const margin = parseFloat($('#margin').val()) || 0;
        return +(fiberLength * fiberLossPerKm + connectorCount * connectorLoss + spliceCount * spliceLoss + margin).toFixed(2);
    }
    function updateSplitterCalc() {
        const rxAwal = parseFloat($('#rxAwal').val());
        const ratio = parseInt($('#splitterRatio').val());
        if (isNaN(rxAwal) || isNaN(ratio)) {
            $('#splitterAttenuation').val('');
            $('#rxSetelahSplitter').val('');
            return false;
        }
        const att = calcAttenuation(ratio);
        const totalLoss = getTotalLoss();
        const rxAfter = +(rxAwal - att - totalLoss).toFixed(2);
        $('#splitterAttenuation').val((att + totalLoss).toFixed(2));
        $('#rxSetelahSplitter').val(rxAfter);
        return true;
    }
    function updateSplitterTable() {
        const rxAwal = parseFloat($('#rxAwal').val());
        const fiberLength = parseFloat($('#fiberLength').val()) || 0;
        const connectorCount = parseInt($('#connectorCount').val()) || 0;
        const spliceCount = parseInt($('#spliceCount').val()) || 0;
        const margin = parseFloat($('#margin').val()) || 0;
        const ratios = [2,4,8,16,32,64];
        let html = '';
        ratios.forEach(function(r) {
            const att = calcAttenuation(r);
            const totalLoss = fiberLength * fiberLossPerKm + connectorCount * connectorLoss + spliceCount * spliceLoss + margin;
            let rxAfter = '';
            if (!isNaN(rxAwal)) rxAfter = (rxAwal - att - totalLoss).toFixed(2);
            html += `<tr><td>1:${r}</td><td>${(att + totalLoss).toFixed(2)}</td><td>${rxAfter}</td></tr>`;
        });
        $('#splitterTableBody').html(html);
    }
    // Hide result section by default
    $('#splitterResultSection').hide();
    // Only generate on button click
    $('#generateSplitterResult').on('click', function() {
        const valid = updateSplitterCalc();
        if (valid) {
            updateSplitterTable();
            $('#splitterResultSection').slideDown();
        } else {
            $('#splitterResultSection').slideUp();
        }
    });
});
</script>
<script>
// Fungsi untuk download file
function downloadScript(filename, content) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

// VPS & MikroTik Configuration Generator
function generateVpsScript() {
    const vpsIp = $('#vpsPublicIp').val().trim();
    const vpsInterface = $('#vpsInterface').val().trim();
    const wgPort = $('#wgPort').val().trim();
    const vpsLocalIp = $('#vpsLocalIp').val().trim();
    const networkSubnet = $('#networkSubnet').val().trim();
    
    if (!vpsIp || !vpsInterface || !wgPort || !vpsLocalIp || !networkSubnet) {
        alert('Harap isi semua field yang diperlukan');
        return;
    }

    const script = `#!/bin/bash
# ===========================================
# Script Konfigurasi VPS untuk WireGuard
# ===========================================

# Update sistem
echo "Mengupdate sistem..."
sudo apt update && sudo apt upgrade -y

# Install paket yang diperlukan
echo "Menginstall paket yang diperlukan..."
sudo apt install -y wireguard net-tools iputils-ping

# Generate key
echo "Membuat kunci WireGuard..."
umask 077
wg genkey | sudo tee /etc/wireguard/private.key
sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee /etc/wireguard/public.key

# Buat konfigurasi WireGuard
echo "Membuat konfigurasi WireGuard..."
sudo cat > /etc/wireguard/wg0.conf <<EOL
[Interface]
Address = ${vpsLocalIp}/24
SaveConfig = true
ListenPort = ${wgPort}
PrivateKey = $(sudo cat /etc/wireguard/private.key)
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ${vpsInterface} -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ${vpsInterface} -j MASQUERADE
EOL

# Aktifkan IP forwarding
echo "Mengaktifkan IP forwarding..."
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# Konfigurasi firewall
echo "Mengkonfigurasi firewall..."
sudo ufw allow 22/tcp
sudo ufw allow ${wgPort}/udp

# Konfigurasi NAT untuk WireGuard
sudo sed -i '/^\*filter$/i *nat\n:POSTROUTING ACCEPT [0:0]\n-A POSTROUTING -s ${networkSubnet} -o ${vpsInterface} -j MASQUERADE\nCOMMIT\n' /etc/ufw/before.rules

# Aktifkan firewall
sudo ufw enable

# Start WireGuard
echo "Menjalankan WireGuard..."
sudo systemctl enable --now wg-quick@wg0

echo "\n==========================================="
echo "Konfigurasi VPS selesai!"
echo "Gunakan public key berikut untuk konfigurasi MikroTik:"
sudo cat /etc/wireguard/public.key
echo "\n==========================================="`;

    $('#generatedScript').text(script);
    return script;
}

function generateMikrotikScript() {
    const vpsIp = $('#vpsPublicIp').val().trim();
    const wgPort = $('#wgPort').val().trim();
    const mikrotikLocalIp = $('#mikrotikLocalIp').val().trim();
    const vpsLocalIp = $('#vpsLocalIp').val().trim();
    const networkSubnet = $('#networkSubnet').val().trim();
    
    if (!vpsIp || !wgPort || !mikrotikLocalIp || !vpsLocalIp || !networkSubnet) {
        alert('Harap isi semua field yang diperlukan');
        return;
    }

    const script = `# ===========================================
# Script Konfigurasi MikroTik untuk WireGuard
# ===========================================

# Generate key pair
:local privateKey ""
:local publicKey ""
/interface wireguard keypair \
    private-key=private.key public-key=public.key
:set privateKey [:parse [/file get private.key contents]]
:set publicKey [:parse [/file get public.key contents]]
/file remove public.key private.key

# Buat interface WireGuard
/interface wireguard add \
    name=wg-vps \
    private-key=$privateKey \
    listen-port=${wgPort}

# Tambahkan peer (VPS)
/interface wireguard peers add \
    interface=wg-vps \
    public-key="<MASUKKAN_PUBLIC_KEY_VPS>" \
    allowed-address=${vpsLocalIp}/32 \
    endpoint-address=${vpsIp} \
    endpoint-port=${wgPort}

# Atur IP lokal
/ip address add \
    address=${mikrotikLocalIp}/24 \
    interface=wg-vps

# Tambahkan rute ke VPS
/ip route add \
    dst-address=${vpsLocalIp}/32 \
    gateway=wg-vps

# Tambahkan rute ke jaringan lokal VPS (jika ada)
/ip route add \
    dst-address=${networkSubnet} \
    gateway=wg-vps

# Konfigurasi NAT (jika diperlukan)
/ip firewall nat add \
    chain=srcnat \
    out-interface=wg-vps \
    action=masquerade

# Konfigurasi DHCP Option 43 untuk GenieACS
:local genieAcsUrl "http://${vpsLocalIp}:7547"
:local urlHex [:pick [/tool fetch url="http://text-processing.com/encode/raw/" \
    http-method=post \
    http-data="text=$genieAcsUrl&encode=hex&charset=utf-8" \
    as-value output=user] 1]
:local urlLen [:len $urlHex]
:local option43 "01$[:pick $urlHex 0 2]$[:pick $urlHex 2 $urlLen]"

/ip dhcp-server option add name=opt43 code=43 value="0x$option43"
/ip dhcp-server network set numbers=0 dhcp-option=opt43

:put "==========================================="
:put "Konfigurasi MikroTik selesai!"
:put "Gunakan public key ini di VPS:"
:put $publicKey
:put "\n==========================================="`;

    $('#generatedScript').text(script);
    return script;
}

// Event Listeners
let currentVpsScript = '';
let currentMikrotikScript = '';
    
$('#generateVpsScript').on('click', function() {
    currentVpsScript = generateVpsScript();
    $('#downloadVpsScript').prop('disabled', false);
});
    
$('#generateMikrotikScript').on('click', function() {
    currentMikrotikScript = generateMikrotikScript();
    $('#downloadMikrotikScript').prop('disabled', false);
});
    
$('#downloadVpsScript').on('click', function() {
    if (currentVpsScript) {
        downloadScript('vps-wireguard-setup.sh', currentVpsScript);
    }
});
    
$('#downloadMikrotikScript').on('click', function() {
    if (currentMikrotikScript) {
        downloadScript('mikrotik-wireguard-setup.rsc', currentMikrotikScript);
    }
});
</script>

<script>
$(function() {
  $(document).on('click', '#restartMikrotikBtn', function(e) {
    e.preventDefault();
    $('#restartMikrotikModal').modal('show');
  });
  $('#confirmRestartMikrotik').on('click', function() {
    $('#restartMikrotikModal').modal('hide');
    $.ajax({
      url: '/admin/mikrotik/restart',
      method: 'POST',
      success: function(res) {
        let notif = $('#restartNotif');
        if(res.success) {
          notif.removeClass('d-none alert-danger').addClass('alert-success').text(res.message || 'Mikrotik berhasil direstart!');
        } else {
          notif.removeClass('d-none alert-success').addClass('alert-danger').text(res.message || 'Gagal restart Mikrotik!');
        }
        setTimeout(function() { notif.addClass('d-none'); }, 4000);
      },
      error: function() {
        let notif = $('#restartNotif');
        notif.removeClass('d-none alert-success').addClass('alert-danger').text('Gagal menghubungi server!');
        setTimeout(function() { notif.addClass('d-none'); }, 4000);
      }
    });
      });
});

<script>
$(document).ready(function() {
    // 1. Handle Logo Upload
    $('#logoUploadForm').on('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        
        $.ajax({
            url: '/admin/settings/upload-logo',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Tampilkan notifikasi sukses
                    showNotification('success', 'Logo berhasil diupload! Halaman akan dimuat ulang...');
                    
                    // Tunggu 1.5 detik lalu refresh halaman
                    setTimeout(function() {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('danger', response.error || 'Gagal mengupload logo');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error uploading logo:', error);
                var errorMsg = 'Terjadi kesalahan saat mengupload logo';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                showNotification('danger', errorMsg);
            }
        });
    });

    // 1b. Handle Billing QR Upload
    $('#billingQrUploadForm').on('submit', function(e) {
        e.preventDefault();

        var formData = new FormData(this);

        $.ajax({
            url: '/admin/settings/upload-billing-qr',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    var timestamp = Date.now();
                    if (response.filename) {
                        // Gunakan route /admin/settings/billing-qr untuk preview
                        $('#billingQrPreview').attr('src', '/admin/settings/billing-qr?ts=' + timestamp);
                        $('#billingQrFullLink').attr('href', '/admin/settings/billing-qr?ts=' + timestamp);
                    }
                    showNotification('success', 'QR code penagihan berhasil diupload!');
                } else {
                    showNotification('danger', response.error || 'Gagal mengupload QR code penagihan');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error uploading billing QR:', error);
                var errorMsg = 'Terjadi kesalahan saat mengupload QR code penagihan';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                showNotification('danger', errorMsg);
            }
        });
    });

    // 2. Handle DHCP Option 43 Generator
    $('#generateOption43').on('click', function() {
        const url = $('#genieacsUrl').val().trim();
        
        if (!url) {
            showNotification('warning', 'Masukkan URL GenieACS terlebih dahulu');
            return;
        }
        
        try {
            // Format URL untuk DHCP Option 43
            // Format: 01<panjang url dalam hex><url dalam hex>
            const urlHex = stringToHex(url);
            const urlLenHex = (urlHex.length / 2).toString(16).padStart(2, '0');
            const option43 = '01' + urlLenHex + urlHex;
            
            // Tampilkan hasil
            $('#option43Result').val(option43);
            $('#option43Value').text(option43);
            
            // Sembunyikan notifikasi error jika ada
            $('#option43Error').addClass('d-none');
        } catch (e) {
            console.error('Error generating Option 43:', e);
            $('#option43Error').removeClass('d-none').text('Gagal menghasilkan Option 43: ' + e.message);
        }
    });

    // Fungsi untuk menyalin teks ke clipboard
    $('#copyOption43Btn').on('click', function() {
        const copyText = document.getElementById("option43Result");
        copyText.select();
        copyText.setSelectionRange(0, 99999); // Untuk mobile
        document.execCommand("copy");
        showNotification('success', 'Tersalin ke clipboard!');
    });

    // Fungsi bantu: Konversi string ke hex
    function stringToHex(str) {
        let hex = '';
        for (let i = 0; i < str.length; i++) {
            hex += str.charCodeAt(i).toString(16).padStart(2, '0');
        }
        return hex;
    }

    // Fungsi untuk menampilkan notifikasi
    function showNotification(type, message) {
        const notif = $('<div>')
            .addClass('alert alert-' + type + ' alert-dismissible fade show position-fixed top-0 end-0 m-3')
            .css('z-index', '1055')
            .html(`
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `);
        
        $('body').append(notif);
        
        // Hapus notifikasi setelah 5 detik
        setTimeout(() => {
            notif.alert('close');
        }, 5000);
    }

    // 3. Handle Mikrotik Isolation Script Generator
    $('#generateIsolationScript').on('click', function() {
        const method = $('#isolationMethod').val();
        const bandwidthLimit = $('#bandwidthLimit').val();
        const networkRange = $('#networkRange').val();
        const dnsServers = $('#dnsServers').val();
        
        // Validasi input
        if (!networkRange) {
            showNotification('warning', 'Masukkan network range terlebih dahulu');
            return;
        }
        
        // Tampilkan loading
        $('#generateIsolationScript').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Generating...');
        
        // Kirim request ke server
        $.ajax({
            url: '/admin/settings/generate-isolation-script',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                method: method,
                bandwidthLimit: bandwidthLimit,
                networkRange: networkRange,
                dnsServers: dnsServers
            }),
            success: function(response) {
                if (response.success) {
                    $('#isolationScriptResult').val(response.script);
                    showNotification('success', 'Script berhasil di-generate!');
                } else {
                    showNotification('danger', 'Gagal generate script: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error generating script:', error);
                showNotification('danger', 'Error: ' + error);
            },
            complete: function() {
                $('#generateIsolationScript').prop('disabled', false).html('<i class="bi bi-gear"></i> Generate Script');
            }
        });
    });

    // Preview script
    $('#previewIsolationScript').on('click', function() {
        const script = $('#isolationScriptResult').val();
        if (!script) {
            showNotification('warning', 'Generate script terlebih dahulu');
            return;
        }
        
        // Buka modal preview
        $('#scriptPreviewModal .modal-body pre').text(script);
        new bootstrap.Modal(document.getElementById('scriptPreviewModal')).show();
    });

    // Copy script to clipboard
    $('#copyIsolationScriptBtn').on('click', function() {
        const copyText = document.getElementById("isolationScriptResult");
        copyText.select();
        copyText.setSelectionRange(0, 99999); // Untuk mobile
        document.execCommand("copy");
        showNotification('success', 'Script tersalin ke clipboard!');
    });
});
</script>
<script>
$(document).ready(function() {
    // 1. Handle Burst Limit Calculator
    $('#generateBurstLimit').on('click', function() {
        // Ambil nilai input
        const uploadRate = $('#uploadRate').val();
        const uploadUnit = $('#uploadUnit').val();
        const downloadRate = $('#downloadRate').val();
        const downloadUnit = $('#downloadUnit').val();
        const uploadBurstRate = $('#uploadBurstRate').val();
        const uploadBurstUnit = $('#uploadBurstUnit').val();
        const downloadBurstRate = $('#downloadBurstRate').val();
        const downloadBurstUnit = $('#downloadBurstUnit').val();
        const burstTime = $('#burstTime').val() || '8';

        // Validasi input
        if (!uploadRate || !downloadRate || !uploadBurstRate || !downloadBurstRate) {
            showNotification('warning', 'Harap isi semua field yang diperlukan');
            return;
        }

        // Format rate limit
        const formatRate = (rate, unit) => {
            if (unit === 'M') {
                return `${rate}M`;
            } else {
                return rate === '0' ? '0' : `${rate}K`;
            }
        };

        // Format burst limit
        const formatBurst = (rate, unit, burstRate, burstUnit) => {
            if (rate === '0') return '0/0';
            
            const rateValue = parseInt(rate);
            const burstValue = parseInt(burstRate);
            let rateKbps = unit === 'M' ? rateValue * 1000 : rateValue;
            let burstKbps = burstUnit === 'M' ? burstValue * 1000 : burstValue;
            
            // Hitung burst threshold (50-75% dari burst rate)
            const threshold = Math.max(
                Math.min(Math.ceil(burstKbps * 0.75), burstKbps - 1),
                Math.ceil(burstKbps * 0.5)
            );
            
            return `${burstKbps}K/${threshold}K ${burstTime}`;
        };

        // Generate hasil
        const uploadLimit = formatRate(uploadRate, uploadUnit);
        const downloadLimit = formatRate(downloadRate, downloadUnit);
        const uploadBurst = formatBurst(uploadRate, uploadUnit, uploadBurstRate, uploadBurstUnit);
        const downloadBurst = formatBurst(downloadRate, downloadUnit, downloadBurstRate, downloadBurstUnit);

        // Format hasil untuk MikroTik
        const result = 
`/ip hotspot user profile set [find name="NamaProfil"] \
    rate-limit="${uploadLimit}/${downloadLimit}" \
    burst-limit="${uploadBurst}/${downloadBurst}" \
    burst-threshold=0/0 \
    burst-time=0s/0s`;

        // Tampilkan hasil
        $('#burstResult').val(result);
        
        // Scroll ke hasil
        $('html, body').animate({
            scrollTop: $('#burstResult').offset().top - 100
        }, 500);
    });

    // 2. Handle Copy to Clipboard
    $('#copyBurstBtn').on('click', function() {
        const copyText = document.getElementById("burstResult");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand("copy");
        showNotification('success', 'Berhasil disalin ke clipboard!');
    });
});


    // 2. WhatsApp Groups Management
    let currentGroups = [];

    // Load WhatsApp Groups
    $('#btnLoadGroups, #btnRefreshGroups').on('click', function() {
        loadWhatsAppGroups();
    });

    async function loadWhatsAppGroups() {
        try {
            $('#btnLoadGroups, #btnRefreshGroups').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Loading...');

            console.log('üîÑ Loading WhatsApp groups...');

            const response = await fetch('/admin/settings/whatsapp-groups', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });

            // Check if response is OK
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Check content type
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // If not JSON, read as text to see what we got
                const textResponse = await response.text();
                console.error('Received non-JSON response:', textResponse.substring(0, 500));
                throw new Error('Server returned non-JSON response. Check server logs.');
            }

            const data = await response.json();
            console.log('üìä API Response:', data);

            if (data.success) {
                currentGroups = data.groups;
                displayGroups(data.groups);
                $('#waGroupsStatus').html(`<div class="alert alert-success"><i class="bi bi-check-circle"></i> Berhasil memuat ${data.total} grup WhatsApp</div>`);
                $('#waGroupsList').show();
            } else {
                $('#waGroupsStatus').html(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.message || 'Gagal memuat grup WhatsApp'}</div>`);
                $('#waGroupsList').hide();
            }
        } catch (error) {
            console.error('‚ùå Error loading WhatsApp groups:', error);

            let errorMessage = error.message;
            if (error.message.includes('Unexpected token')) {
                errorMessage = 'Server mengembalikan response yang tidak valid. Pastikan WhatsApp sudah terkoneksi.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = 'Endpoint tidak ditemukan. Pastikan aplikasi berjalan dengan benar.';
            } else if (error.message.includes('HTTP 500')) {
                errorMessage = 'Server error. Cek logs aplikasi untuk detail error.';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Tidak dapat terhubung ke server. Pastikan aplikasi berjalan.';
            }

            $('#waGroupsStatus').html(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${errorMessage}</div>`);
            $('#waGroupsList').hide();
        } finally {
            $('#btnLoadGroups').prop('disabled', false).html('<i class="bi bi-arrow-clockwise"></i> Load Groups');
            $('#btnRefreshGroups').prop('disabled', false).html('<i class="bi bi-refresh"></i> Refresh');
        }
    }

    function displayGroups(groups) {
        const container = $('#groupsContainer');
        const countBadge = $('#groupsCount');

        console.log('üì± Displaying', groups.length, 'groups');

        countBadge.text(groups.length);

        if (groups.length === 0) {
            container.html('<div class="p-4 text-center text-muted"><i class="bi bi-info-circle"></i><br>Tidak ada grup WhatsApp ditemukan</div>');
            return;
        }

        let html = '<div class="list-group list-group-flush">';

        groups.forEach((group, index) => {
            const adminIcon = group.isAdmin ? '<i class="bi bi-star-fill text-warning ms-1" title="Admin"></i>' : '';
            const badgeClass = group.isAdmin ? 'bg-success' : 'bg-secondary';
            const groupId = group.id || '';

            console.log(`   Grup ${index + 1}: ${group.name} (${groupId})`);

            html += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <strong>${group.name}</strong>${adminIcon}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-people"></i> ${group.participants} anggota |
                            <i class="bi bi-calendar"></i> ${group.created}
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary view-group-btn"
                                data-group-id="${groupId}"
                                title="Detail Grup">
                            <i class="bi bi-eye"></i> Detail
                        </button>
                        <button class="btn btn-sm btn-outline-secondary copy-group-btn"
                                data-group-id="${groupId}"
                                title="Copy Group ID">
                            <i class="bi bi-clipboard"></i> Copy ID
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.html(html);

        // Add event listeners after HTML is inserted
        attachGroupButtonListeners();
    }

    function attachGroupButtonListeners() {
        console.log('üîß Attaching group button listeners...');

        // View Group Detail buttons
        $('.view-group-btn').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const groupId = $(this).data('group-id');
            console.log('üëÅÔ∏è View button clicked for group:', groupId);
            if (groupId) {
                viewGroupDetail(groupId);
            }
        });

        // Copy Group ID buttons
        $('.copy-group-btn').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const groupId = $(this).data('group-id');
            console.log('üìã Copy button clicked for group:', groupId);
            if (groupId) {
                copyGroupId(groupId);
            }
        });

        console.log('‚úÖ Group button listeners attached');
    }

    // View Group Detail
    async function viewGroupDetail(groupId) {
        try {
            const response = await fetch(`/admin/settings/whatsapp-groups/${groupId}`);
            const data = await response.json();

            if (data.success) {
                const group = data.group;
                const participantsHtml = group.participants.map(p => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${p.id.split('@')[0]}
                        ${p.isAdmin ? '<span class="badge bg-success">Admin</span>' : ''}
                        ${p.isSuperAdmin ? '<span class="badge bg-warning">Super Admin</span>' : ''}
                    </li>
                `).join('');

                const html = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6><i class="bi bi-info-circle"></i> Informasi Grup</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Nama Grup:</strong></td>
                                    <td>${group.name}</td>
                                </tr>
                                <tr>
                                    <td><strong>Group ID:</strong></td>
                                    <td><code>${group.id}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Owner:</strong></td>
                                    <td>${group.owner}</td>
                                </tr>
                                <tr>
                                    <td><strong>Total Anggota:</strong></td>
                                    <td>${group.totalParticipants}</td>
                                </tr>
                                <tr>
                                    <td><strong>Dibuat:</strong></td>
                                    <td>${group.created}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status Admin:</strong></td>
                                    <td>${group.isAdmin ? '<span class="badge bg-success">Ya</span>' : '<span class="badge bg-secondary">Tidak</span>'}</td>
                                </tr>
                                ${group.description ? `
                                <tr>
                                    <td><strong>Deskripsi:</strong></td>
                                    <td>${group.description}</td>
                                </tr>
                                ` : ''}
                            </table>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="bi bi-people"></i> Anggota (${group.totalParticipants})</h6>
                            <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                <ul class="list-group list-group-flush">
                                    ${participantsHtml}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                $('#groupDetailContent').html(html);
                $('#btnCopyGroupId').attr('onclick', `copyGroupId('${group.id}')`);
                new bootstrap.Modal(document.getElementById('groupDetailModal')).show();
            } else {
                showNotification('danger', data.message);
            }
        } catch (error) {
            console.error('Error loading group detail:', error);
            showNotification('danger', 'Error: ' + error.message);
        }
    }

    // Copy Group ID
    function copyGroupId(groupId) {
        console.log('üìã Copying Group ID:', groupId);

        if (!groupId || groupId.trim() === '') {
            console.error('‚ùå Group ID is empty');
            showNotification('danger', 'Group ID tidak valid!');
            return;
        }

        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(groupId).then(() => {
                console.log('‚úÖ Copied to clipboard using modern API');
                showNotification('success', `Group ID berhasil disalin: ${groupId.substring(0, 20)}...`);
            }).catch(err => {
                console.error('‚ùå Failed to copy with modern API:', err);
                fallbackCopyTextToClipboard(groupId);
            });
        } else {
            console.log('‚ö†Ô∏è Modern clipboard API not available, using fallback');
            fallbackCopyTextToClipboard(groupId);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                console.log('‚úÖ Copied to clipboard using fallback method');
                showNotification('success', `Group ID berhasil disalin: ${text.substring(0, 20)}...`);
            } else {
                console.error('‚ùå Fallback copy failed');
                showNotification('danger', 'Gagal menyalin Group ID!');
            }
        } catch (err) {
            console.error('‚ùå Fallback copy error:', err);
            showNotification('danger', 'Gagal menyalin Group ID!');
        }

        document.body.removeChild(textArea);
    }
    
    // Handler untuk tombol Test Koneksi
    $('#testConnectionBtn').on('click', function() {
        const $btn = $(this);
        const originalText = $btn.html();
        
        // Loading state
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Testing...');
        
        // Kirim request test koneksi
        $.ajax({
            url: '/admin/config/validate',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const results = response.data.results;
                    const summary = response.data.summary;
                    
                    if (results && results.overall && results.overall.isValid) {
                        showNotification('success', '‚úÖ Semua koneksi berhasil! Konfigurasi sistem valid.');
                    } else {
                        let errorMsg = '‚ö†Ô∏è Ditemukan masalah koneksi:\n';
                        
                        if (results && results.genieacs && !results.genieacs.isValid) {
                            errorMsg += '‚Ä¢ GenieACS: ' + results.genieacs.errors.join(', ') + '\n';
                        }
                        
                        if (results && results.mikrotik && !results.mikrotik.isValid) {
                            errorMsg += '‚Ä¢ Mikrotik: ' + results.mikrotik.errors.join(', ') + '\n';
                        }
                        
                        errorMsg += '\nSilakan perbaiki konfigurasi dan test kembali.';
                        
                        showNotification('warning', errorMsg);
                    }
                } else {
                    showNotification('error', 'Gagal menjalankan test koneksi: ' + (response.message || 'Unknown error'));
                }
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.message || 'Gagal menghubungi server';
                showNotification('error', 'Error: ' + errorMsg);
            },
            complete: function() {
                // Reset button
                $btn.prop('disabled', false).html(originalText);
            }
        });
    });
});

// ===== DNS MANAGEMENT FUNCTIONS =====

// Test koneksi GenieACS menggunakan console script
async function testGenieACSConnection() {
    const button = event.target.closest('button');
    setButtonLoading(button, true);
    addLog('Testing koneksi ke GenieACS...', 'info');

    try {
        // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
        const response = await fetch('/admin/settings/api/test-genieacs-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            addLog(`‚úÖ Koneksi berhasil! ${result.message}`, 'success');
            document.getElementById('connectionStatus').innerHTML = 
                `<div class="alert alert-success">‚úÖ Koneksi GenieACS berhasil</div>`;
        } else {
            addLog(`‚ùå Koneksi gagal: ${result.message}`, 'error');
            document.getElementById('connectionStatus').innerHTML = 
                `<div class="alert alert-danger">‚ùå Koneksi gagal: ${result.message}</div>`;
        }
        
    } catch (error) {
        addLog(`‚ùå Error testing koneksi: ${error.message}`, 'error');
        document.getElementById('connectionStatus').innerHTML = 
            `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
    } finally {
        setButtonLoading(button, false);
    }
}

// Load device online menggunakan console script
async function loadOnlineDevices() {
    const button = event.target.closest('button');
    setButtonLoading(button, true);
    addLog('Memuat daftar device online...', 'info');

    try {
        // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
        const response = await fetch('/admin/settings/api/get-genieacs-devices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            addLog(`‚úÖ Device loaded: ${result.message}`, 'success');
            displayDevicesFromOutput(result.output);
            document.getElementById('deviceList').style.display = 'block';
        } else {
            addLog(`‚ùå Gagal memuat device: ${result.message}`, 'error');
        }
        
    } catch (error) {
        addLog(`‚ùå Error memuat device: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

// Konfigurasi DNS untuk device tertentu
async function configureDNS() {
    const deviceId = document.getElementById('deviceIdInput').value;
    const dnsServer = document.getElementById('dnsServerIp').value || '192.168.8.89';
    
    if (!deviceId) {
        addLog('‚ùå Device ID harus diisi!', 'error');
        return;
    }
    
    addLog(`Mengkonfigurasi DNS untuk device ${deviceId}...`, 'info');

    try {
        // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
        const response = await fetch('/admin/settings/api/configure-genieacs-dns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                deviceId,
                dnsServer
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addLog(`‚úÖ DNS berhasil dikonfigurasi untuk device ${deviceId}`, 'success');
        } else {
            addLog(`‚ùå Gagal konfigurasi DNS: ${result.message}`, 'error');
        }
        
    } catch (error) {
        addLog(`‚ùå Error konfigurasi DNS: ${error.message}`, 'error');
    }
}

// Konfigurasi DNS untuk semua device online
async function configureAllOnline() {
    const button = event.target.closest('button');
    setButtonLoading(button, true);
    addLog('Memulai konfigurasi DNS untuk semua device online...', 'info');

    try {
        // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
        const response = await fetch('/admin/settings/api/configure-all-genieacs-dns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            addLog(`‚úÖ ${result.message}`, 'success');
        } else {
            addLog(`‚ùå Gagal memulai konfigurasi: ${result.message}`, 'error');
        }
        
    } catch (error) {
        addLog(`‚ùå Error memulai konfigurasi: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

// Display devices from console output
function displayDevicesFromOutput(output) {
    const container = document.getElementById('deviceListContent');
    container.innerHTML = '';
    
    // Parse output untuk extract device info
    const lines = output.split('\n');
    let deviceCount = 0;
    
    lines.forEach(line => {
        if (line.includes('Device ID:') || line.includes('Serial:')) {
            const deviceCard = document.createElement('div');
            deviceCard.className = 'col-md-6 col-lg-4 mb-3';
            deviceCard.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Device ${++deviceCount}</h6>
                        <p class="card-text small">${line}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="configureDeviceDNS('${line.split(':')[1]?.trim()}')">
                            <i class="bi bi-gear"></i> Konfigurasi DNS
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(deviceCard);
        }
    });
}

// Configure DNS for specific device
async function configureDeviceDNS(deviceId) {
    const dnsServer = document.getElementById('dnsServerIp').value || '192.168.8.89';
    addLog(`Mengkonfigurasi DNS untuk device ${deviceId}...`, 'info');

    try {
        // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
        const response = await fetch('/admin/settings/api/configure-genieacs-dns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                deviceId,
                dnsServer
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addLog(`‚úÖ DNS berhasil dikonfigurasi untuk device ${deviceId}`, 'success');
        } else {
            addLog(`‚ùå Gagal konfigurasi DNS: ${result.message}`, 'error');
        }
        
    } catch (error) {
        addLog(`‚ùå Error konfigurasi DNS: ${error.message}`, 'error');
    }
}

// Utility functions
function setButtonLoading(button, loading) {
    if (loading) {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
    } else {
        button.disabled = false;
        // Restore original text based on button class
        if (button.classList.contains('btn-outline-primary')) {
            button.innerHTML = '<i class="bi bi-plug"></i> Test Koneksi';
        } else if (button.classList.contains('btn-outline-info')) {
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Device';
        } else if (button.classList.contains('btn-success')) {
            button.innerHTML = '<i class="bi bi-gear"></i> Konfigurasi DNS';
        } else if (button.classList.contains('btn-warning')) {
            button.innerHTML = '<i class="bi bi-broadcast-tower"></i> Konfigurasi Semua Online';
        }
    }
}

function addLog(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    
    let icon = '‚ÑπÔ∏è';
    if (type === 'success') icon = '‚úÖ';
    else if (type === 'error') icon = '‚ùå';
    else if (type === 'warning') icon = '‚ö†Ô∏è';
    
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${icon} ${message}`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// ===== MIKROTIK DNS GENIEACS SCRIPT GENERATOR FUNCTIONS =====

// Generate Mikrotik DNS GenieACS Script
function generateMikrotikDNSGenieACSScript() {
    const genieacsServerIp = document.getElementById('genieacsServerIp').value.trim();
    const genieacsPort = document.getElementById('genieacsPort').value.trim() || '7547';
    const pppoeRange = document.getElementById('pppoeRange').value.trim() || '192.168.10.0/24';
    const dnsBackup = document.getElementById('dnsBackup').value.trim() || '8.8.8.8';
    
    if (!genieacsServerIp) {
        showNotification('warning', 'Masukkan IP Server GenieACS terlebih dahulu');
        return;
    }
    
    const script = generateMikrotikDNSGenieACSScriptContent(genieacsServerIp, genieacsPort, pppoeRange, dnsBackup);
    
    // Tampilkan script
    document.getElementById('mikrotikDNSGenieACSScriptContent').textContent = script;
    document.getElementById('mikrotikDNSGenieACSScriptOutput').style.display = 'block';
    
    // Enable tombol copy dan download
    document.getElementById('copyMikrotikDNSGenieACSBtn').disabled = false;
    document.getElementById('downloadMikrotikDNSGenieACSBtn').disabled = false;
    
    showNotification('success', 'Script Mikrotik DNS GenieACS berhasil digenerate!');
}

// Generate script content
function generateMikrotikDNSGenieACSScriptContent(genieacsServerIp, genieacsPort, pppoeRange, dnsBackup) {
    const script = `# ===========================================
# MIKROTIK DNS GENIEACS CONFIGURATION SCRIPT
# ===========================================
# Generated: ${new Date().toLocaleString('id-ID')}
# GenieACS Server: ${genieacsServerIp}:${genieacsPort}
# PPPoE Range: ${pppoeRange}
# DNS Backup: ${dnsBackup}
# ===========================================

# ===========================================
# 1. SETUP DNS STATIC - Arahkan domain ke GenieACS
# ===========================================

# Hapus DNS static lama (jika ada)
/ip dns static remove [find where name="genieacs.local" and address="${genieacsServerIp}"]
/ip dns static remove [find where name="tr069.local" and address="${genieacsServerIp}"]

# Tambahkan DNS static untuk GenieACS
/ip dns static add name="genieacs.local" address="${genieacsServerIp}" ttl=300 comment="GenieACS Server"
/ip dns static add name="tr069.local" address="${genieacsServerIp}" ttl=300 comment="TR069 Server"

# ===========================================
# 2. SETUP DHCP SERVER DNS
# ===========================================

# Update DHCP server untuk memberikan DNS GenieACS
/ip dhcp-server network set [find address="${pppoeRange}"] dns-server="${genieacsServerIp},${dnsBackup}" comment="GenieACS DNS Configuration"

# ===========================================
# 3. SETUP NAT RULES - Redirect TR069 ke GenieACS
# ===========================================

# Hapus NAT rules lama (jika ada)
/ip firewall nat remove [find comment="genieacs-tr069-redirect"]
/ip firewall nat remove [find comment="genieacs-tr069-redirect-https"]

# Redirect TR069 HTTP ke GenieACS
/ip firewall nat add chain=dstnat dst-port=7547 protocol=tcp action=dst-nat to-addresses=${genieacsServerIp} to-ports=${genieacsPort} comment="genieacs-tr069-redirect"

# Redirect TR069 HTTPS ke GenieACS (jika menggunakan HTTPS)
/ip firewall nat add chain=dstnat dst-port=7548 protocol=tcp action=dst-nat to-addresses=${genieacsServerIp} to-ports=7548 comment="genieacs-tr069-redirect-https"

# ===========================================
# 4. SETUP FIREWALL RULES - Allow TR069 Communication
# ===========================================

# Hapus firewall rules lama (jika ada)
/ip firewall filter remove [find comment="genieacs-allow-tr069"]
/ip firewall filter remove [find comment="genieacs-allow-dns"]

# Allow TR069 communication dari PPPoE range ke GenieACS
/ip firewall filter add chain=forward src-address=${pppoeRange} dst-address=${genieacsServerIp} dst-port=${genieacsPort} protocol=tcp action=accept comment="genieacs-allow-tr069"

# Allow DNS queries ke GenieACS
/ip firewall filter add chain=forward src-address=${pppoeRange} dst-address=${genieacsServerIp} dst-port=53 protocol=udp action=accept comment="genieacs-allow-dns"

# Allow HTTPS TR069 (jika menggunakan HTTPS)
/ip firewall filter add chain=forward src-address=${pppoeRange} dst-address=${genieacsServerIp} dst-port=7548 protocol=tcp action=accept comment="genieacs-allow-tr069-https"

# ===========================================
# 5. SETUP PPP PROFILE - Update DNS untuk PPPoE
# ===========================================

# Update PPP profile untuk memberikan DNS GenieACS
/ppp profile set [find name="default"] dns-server="${genieacsServerIp},${dnsBackup}" comment="GenieACS DNS Configuration"

# ===========================================
# 6. SETUP ADDRESS LIST - Untuk monitoring
# ===========================================

# Hapus address list lama (jika ada)
/ip firewall address-list remove [find list="genieacs-clients"]

# Tambahkan address list untuk monitoring
/ip firewall address-list add list="genieacs-clients" address=${pppoeRange} comment="PPPoE Clients for GenieACS"

# ===========================================
# 7. SETUP LOGGING - Monitor TR069 Activity
# ===========================================

# Hapus logging rules lama (jika ada)
/system logging remove [find topics="genieacs"]

# Tambahkan logging untuk TR069 activity
/system logging add topics=genieacs action=memory comment="GenieACS TR069 Activity"

# ===========================================
# 8. VERIFIKASI KONFIGURASI
# ===========================================

:put ""
:put "=== VERIFIKASI KONFIGURASI ==="
:put "GenieACS Server: ${genieacsServerIp}:${genieacsPort}"
:put "PPPoE Range: ${pppoeRange}"
:put "DNS Backup: ${dnsBackup}"
:put ""
:put "=== DNS STATIC ==="
/ip dns static print where name~"genieacs|tr069"
:put ""
:put "=== DHCP SERVER DNS ==="
/ip dhcp-server network print where address="${pppoeRange}"
:put ""
:put "=== NAT RULES ==="
/ip firewall nat print where comment~"genieacs"
:put ""
:put "=== FIREWALL RULES ==="
/ip firewall filter print where comment~"genieacs"
:put ""
:put "=== PPP PROFILE ==="
/ppp profile print where name="default"
:put ""
:put "=== ADDRESS LIST ==="
/ip firewall address-list print where list="genieacs-clients"
:put ""
:put "=== KONFIGURASI SELESAI ==="
:put "Script berhasil dijalankan!"
:put "ONUs sekarang akan menggunakan GenieACS sebagai DNS server"
:put "Port TR069: ${genieacsPort} (HTTP), 7548 (HTTPS)"
:put "==========================================="`;

    return script;
}

// Copy script to clipboard
function copyMikrotikDNSGenieACSScript() {
    const scriptContent = document.getElementById('mikrotikDNSGenieACSScriptContent').textContent;
    
    navigator.clipboard.writeText(scriptContent).then(() => {
        showNotification('success', 'Script berhasil dicopy ke clipboard!');
    }).catch(err => {
        showNotification('error', 'Gagal copy script: ' + err.message);
    });
}

// Download script as file
function downloadMikrotikDNSGenieACSScript() {
    const scriptContent = document.getElementById('mikrotikDNSGenieACSScriptContent').textContent;
    const genieacsServerIp = document.getElementById('genieacsServerIp').value.trim();
    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
    const filename = `mikrotik-dns-genieacs-${genieacsServerIp.replace(/\./g, '-')}-${timestamp}.rsc`;
    
    const blob = new Blob([scriptContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('success', `Script berhasil didownload: ${filename}`);
}

// Functions untuk Script Generator Menu Isolir Mikrotik
function generateIsolirScript() {
    const activeIp = document.getElementById('activeIp').value.trim();
    const isolirIp = document.getElementById('isolirIp').value.trim();
    const isolirDomain = document.getElementById('isolirDomain').value.trim();
    const isolirPath = document.getElementById('isolirPath').value.trim();
    const isolirPort = document.getElementById('isolirPort').value.trim();
    const accessType = document.getElementById('accessType').value;
    
    // Validasi input
    if (!activeIp || !isolirIp || !isolirDomain || !isolirPath) {
        showNotification('warning', 'Mohon lengkapi field yang wajib!');
        return;
    }
    
    // Validasi port untuk akses langsung
    if (accessType === 'port' && !isolirPort) {
        showNotification('warning', 'Port wajib diisi untuk akses langsung!');
        return;
    }
    
    // Validasi format IP
    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipRegex.test(activeIp) || !ipRegex.test(isolirIp)) {
        showNotification('warning', 'Format IP tidak valid!');
        return;
    }
    
    // Generate script Mikrotik
    const isolirUrl = accessType === 'tunneling' 
        ? isolirDomain + isolirPath 
        : isolirDomain + ':' + isolirPort + isolirPath;
    
    const script = [
        '# Script Menu Isolir Mikrotik - Enhanced Version',
        '# Generated on: ' + new Date().toLocaleString('id-ID'),
        '# IP PPPoE Aktif: ' + activeIp,
        '# IP PPPoE Isolir: ' + isolirIp,
        '# URL Halaman Isolir: ' + isolirUrl,
        '# Jenis Akses: ' + (accessType === 'tunneling' ? 'Tunneling' : 'Port Langsung'),
        '',
        '# ===========================================',
        '# 1. SETUP DNS STATIC - Arahkan semua domain ke aplikasi',
        '# ===========================================',
        '',
        '# Hapus DNS static lama (jika ada)',
        '/ip dns static remove [find where name="' + isolirDomain + '" and address="' + isolirIp + '"]',
        '',
        '# Tambahkan DNS static untuk domain aplikasi',
        '/ip dns static add name="' + isolirDomain + '" address="' + isolirIp + '" ttl=300',
        '',
        '# Arahkan domain populer ke aplikasi (opsional)',
        '/ip dns static add name="google.com" address="' + isolirIp + '" ttl=300',
        '/ip dns static add name="facebook.com" address="' + isolirIp + '" ttl=300',
        '/ip dns static add name="youtube.com" address="' + isolirIp + '" ttl=300',
        '/ip dns static add name="instagram.com" address="' + isolirIp + '" ttl=300',
        '',
        '# ===========================================',
        '# 2. SETUP NAT RULES - Redirect HTTP/HTTPS ke aplikasi',
        '# ===========================================',
        '',
        '# Hapus NAT rules lama (jika ada)',
        '/ip firewall nat remove [find where comment~"isolir-redirect"]',
        '',
        '# ===========================================',
        '# 3. SETUP FIREWALL RULES - Block semua kecuali aplikasi',
        '# ===========================================',
        '',
        '# Hapus firewall rules lama (jika ada)',
        '/ip firewall filter remove [find where comment~"isolir"]',
        '',
        '# ===========================================',
        '# 4. SETUP PPP PROFILE ISOLIR',
        '# ===========================================',
        '',
        '# Buat profile isolir jika belum ada',
        '/ppp profile add name="isolir" local-address=' + isolirIp + ' remote-address=' + isolirIp + ' \\',
        '    rate-limit="0/0" comment="Profile untuk pelanggan yang diisolir"',
        '',
        '# ===========================================',
        '# 5. SETUP ADDRESS LIST - Untuk kemudahan management',
        '# ===========================================',
        '',
        '# Hapus address list lama (jika ada)',
        '/ip firewall address-list remove [find where list="isolir-users"]',
        '',
        '# Tambahkan IP range isolir ke address list',
        '/ip firewall address-list add address=' + isolirIp + '/32 list="isolir-users" comment="PPPoE Isolir Users"'
    ];
    
    if (accessType === 'tunneling') {
        // Untuk tunneling, redirect ke domain + path
        script.push(
            '# Redirect HTTP traffic ke aplikasi',
            '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=80 protocol=tcp \\',
            '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=80 \\',
            '    comment="isolir-redirect-http"',
            '',
            '# Redirect HTTPS traffic ke aplikasi',
            '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=443 protocol=tcp \\',
            '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=443 \\',
            '    comment="isolir-redirect-https"',
            '',
            '# Allow DNS queries ke aplikasi',
            '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
            '    dst-address=' + isolirDomain + ' dst-port=53 protocol=udp \\',
            '    action=accept comment="isolir-allow-dns"',
            '',
            '# Allow HTTP/HTTPS ke aplikasi',
            '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
            '    dst-address=' + isolirDomain + ' dst-port=80,443 protocol=tcp \\',
            '    action=accept comment="isolir-allow-app"',
            '',
            '# Block semua traffic lainnya',
            '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
            '    action=drop comment="isolir-block-all"'
        );
    } else {
        // Untuk port langsung
        script.push(
            '# Redirect HTTP traffic ke aplikasi lokal',
            '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=80 protocol=tcp \\',
            '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
            '    comment="isolir-redirect-http"',
            '',
            '# Redirect HTTPS traffic ke aplikasi lokal',
            '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=443 protocol=tcp \\',
            '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
            '    comment="isolir-redirect-https"',
            '',
            '# Allow DNS queries ke aplikasi lokal',
            '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
            '    dst-address=' + isolirDomain + ' dst-port=53 protocol=udp \\',
            '    action=accept comment="isolir-allow-dns"',
            '',
            '# Allow HTTP/HTTPS ke aplikasi lokal',
            '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
            '    dst-address=' + isolirDomain + ' dst-port=' + isolirPort + ' protocol=tcp \\',
            '    action=accept comment="isolir-allow-app"',
            '',
            '# Block semua traffic lainnya',
            '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
            '    action=drop comment="isolir-block-all"'
        );
    }
    
    script.push(
        '',
        '# ===========================================',
        '# 6. SCRIPT MANAGEMENT - Isolir & Restore',
        '# ===========================================',
        '',
        '# Script untuk isolir pelanggan',
        '# Gunakan script ini untuk mengisolir pelanggan:',
        '# :local username "nama_pelanggan"',
        '# /ppp secret set [find name=$username] profile=isolir',
        '# :log info "Pelanggan $username telah diisolir"',
        '',
        '# Script untuk restore pelanggan',
        '# Gunakan script ini untuk restore pelanggan:',
        '# :local username "nama_pelanggan"',
        '# /ppp secret set [find name=$username] profile=default',
        '# :log info "Pelanggan $username telah direstore"',
        '',
        '# ===========================================',
        '# 7. VERIFIKASI KONFIGURASI',
        '# ===========================================',
        '',
        ':put "=== KONFIGURASI ISOLIR SELESAI ==="',
        ':put "User PPPoE di ' + isolirIp + ' akan diarahkan ke aplikasi"',
        ':put "Aplikasi: ' + isolirUrl + '"',
        ':put ""',
        ':put "=== VERIFIKASI ==="',
        '',
        '# Cek DNS static',
        ':put "DNS Static Rules:"',
        '/ip dns static print where name~"' + isolirDomain + '"',
        '',
        '# Cek NAT rules',
        ':put "NAT Rules:"',
        '/ip firewall nat print where comment~"isolir"',
        '',
        '# Cek Firewall rules',
        ':put "Firewall Rules:"',
        '/ip firewall filter print where comment~"isolir"',
        '',
        '# Cek Address List',
        ':put "Address List:"',
        '/ip firewall address-list print where list="isolir-users"',
        '',
        ':put ""',
        ':put "=== CARA KERJA ==="',
        ':put "1. User PPPoE terisolir mendapat IP: ' + isolirIp + '"',
        ':put "2. DNS query untuk domain apapun diarahkan ke: ' + isolirDomain + '"',
        ':put "3. HTTP/HTTPS request di-redirect ke: ' + isolirUrl + '"',
        ':put "4. Aplikasi menampilkan halaman isolir"',
        ':put "5. Traffic lainnya di-block"',
        ':put ""',
        ':put "=== SELESAI ==="',
        '',
        'echo "Script menu isolir Mikrotik telah dibuat!"',
        'echo "Pastikan halaman isolir dapat diakses dari IP: ' + isolirIp + '"',
        'echo "URL halaman isolir: ' + isolirUrl + '"'
    );
    
    const finalScript = script.join('\n');

    // Tampilkan script
    document.getElementById('isolirScript').textContent = finalScript;
    document.getElementById('isolirScriptCard').style.display = 'block';
    
    showNotification('success', 'Script berhasil di-generate!');
}

function generateLocalIsolirScript() {
    const activeIp = document.getElementById('activeIp').value.trim();
    const isolirIp = document.getElementById('isolirIp').value.trim();
    const isolirDomain = document.getElementById('isolirDomain').value.trim();
    const isolirPath = document.getElementById('isolirPath').value.trim();
    const isolirPort = document.getElementById('isolirPort').value.trim();
    
    // Validasi input
    if (!activeIp || !isolirIp || !isolirDomain || !isolirPath || !isolirPort) {
        showNotification('warning', 'Mohon lengkapi semua field!');
        return;
    }
    
    // Validasi format IP
    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipRegex.test(activeIp) || !ipRegex.test(isolirIp)) {
        showNotification('warning', 'Format IP tidak valid!');
        return;
    }
    
    // Generate script Mikrotik untuk aplikasi lokal
    const script = [
        '# Script Mikrotik untuk User PPPoE Terisolir - Aplikasi Lokal',
        '# Generated on: ' + new Date().toLocaleString('id-ID'),
        '# IP PPPoE Aktif: ' + activeIp,
        '# IP PPPoE Isolir: ' + isolirIp,
        '# Aplikasi Lokal: ' + isolirDomain + ':' + isolirPort + isolirPath,
        '',
        '# ===========================================',
        '# 1. DNS STATIC - Arahkan semua domain ke aplikasi lokal',
        '# ===========================================',
        '',
        '# Hapus DNS static lama (jika ada)',
        '/ip dns static remove [find where name="' + isolirDomain + '" and address="' + isolirDomain + '"]',
        '',
        '# Tambahkan DNS static untuk domain aplikasi',
        '/ip dns static add name="' + isolirDomain + '" address="' + isolirDomain + '" ttl=300',
        '',
        '# Arahkan domain populer ke aplikasi lokal',
        '/ip dns static add name="google.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="facebook.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="youtube.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="instagram.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="twitter.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="tiktok.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="whatsapp.com" address="' + isolirDomain + '" ttl=300',
        '/ip dns static add name="telegram.org" address="' + isolirDomain + '" ttl=300',
        '',
        '# ===========================================',
        '# 2. NAT RULES - Redirect HTTP/HTTPS ke aplikasi lokal',
        '# ===========================================',
        '',
        '# Hapus NAT rules lama (jika ada)',
        '/ip firewall nat remove [find where comment~"isolir-redirect"]',
        '',
        '# Redirect HTTP traffic ke aplikasi lokal',
        '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=80 protocol=tcp \\',
        '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
        '    comment="isolir-redirect-http"',
        '',
        '# Redirect HTTPS traffic ke aplikasi lokal',
        '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=443 protocol=tcp \\',
        '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
        '    comment="isolir-redirect-https"',
        '',
        '# ===========================================',
        '# 3. FIREWALL RULES - Block semua kecuali aplikasi lokal',
        '# ===========================================',
        '',
        '# Hapus firewall rules lama (jika ada)',
        '/ip firewall filter remove [find where comment~"isolir"]',
        '',
        '# Allow DNS queries ke aplikasi lokal',
        '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
        '    dst-address=' + isolirDomain + ' dst-port=53 protocol=udp \\',
        '    action=accept comment="isolir-allow-dns"',
        '',
        '# Allow HTTP/HTTPS ke aplikasi lokal',
        '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
        '    dst-address=' + isolirDomain + ' dst-port=' + isolirPort + ' protocol=tcp \\',
        '    action=accept comment="isolir-allow-app"',
        '',
        '# Block semua traffic lainnya',
        '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
        '    action=drop comment="isolir-block-all"',
        '',
        '# ===========================================',
        '# 4. ADDRESS LIST - Untuk kemudahan management',
        '# ===========================================',
        '',
        '# Hapus address list lama (jika ada)',
        '/ip firewall address-list remove [find where list="isolir-users"]',
        '',
        '# Tambahkan IP range isolir ke address list',
        '/ip firewall address-list add address=' + isolirIp + '/32 list="isolir-users" comment="PPPoE Isolir Users"',
        '',
        '# ===========================================',
        '# 5. VERIFIKASI KONFIGURASI',
        '# ===========================================',
        '',
        ':put "=== KONFIGURASI ISOLIR LOKAL SELESAI ==="',
        ':put "User PPPoE di ' + isolirIp + ' akan diarahkan ke aplikasi lokal"',
        ':put "Aplikasi lokal: http://' + isolirDomain + ':' + isolirPort + isolirPath + '"',
        ':put ""',
        ':put "=== VERIFIKASI ==="',
        '',
        '# Cek DNS static',
        ':put "DNS Static Rules:"',
        '/ip dns static print where name~"' + isolirDomain + '"',
        '',
        '# Cek NAT rules',
        ':put "NAT Rules:"',
        '/ip firewall nat print where comment~"isolir"',
        '',
        '# Cek Firewall rules',
        ':put "Firewall Rules:"',
        '/ip firewall filter print where comment~"isolir"',
        '',
        '# Cek Address List',
        ':put "Address List:"',
        '/ip firewall address-list print where list="isolir-users"',
        '',
        ':put ""',
        ':put "=== CARA KERJA ==="',
        ':put "1. User PPPoE terisolir mendapat IP: ' + isolirIp + '"',
        ':put "2. DNS query untuk domain apapun diarahkan ke: ' + isolirDomain + '"',
        ':put "3. HTTP/HTTPS request di-redirect ke: ' + isolirDomain + ':' + isolirPort + '"',
        ':put "4. Aplikasi lokal menampilkan halaman isolir"',
        ':put "5. Traffic lainnya di-block"',
        ':put ""',
        ':put "=== SELESAI ==="',
        '',
        'echo "Script isolir lokal Mikrotik telah dibuat!"',
        'echo "Pastikan aplikasi lokal berjalan di: ' + isolirDomain + ':' + isolirPort + '"',
        'echo "Halaman isolir: http://' + isolirDomain + ':' + isolirPort + isolirPath + '"'
    ];
    
    const finalScript = script.join('\n');

    // Tampilkan script
    document.getElementById('isolirScript').textContent = finalScript;
    document.getElementById('isolirScriptCard').style.display = 'block';
    
    showNotification('success', 'Script isolir lokal berhasil di-generate!');
}

function copyIsolirScript() {
    const scriptElement = document.getElementById('isolirScript');
    if (!scriptElement || !scriptElement.textContent) {
        showNotification('warning', 'Tidak ada script untuk di-copy!');
        return;
    }
    
    navigator.clipboard.writeText(scriptElement.textContent).then(function() {
        showNotification('success', 'Script berhasil di-copy ke clipboard!');
    }).catch(function(err) {
        // Fallback untuk browser lama
        const textArea = document.createElement('textarea');
        textArea.value = scriptElement.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('success', 'Script berhasil di-copy ke clipboard!');
    });
}

// Auto-generate script saat input berubah
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['activeIp', 'isolirIp', 'isolirDomain', 'isolirPath'];
    inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                // Auto-generate jika semua field wajib sudah terisi
                const allFilled = inputs.every(inputId => {
                    const el = document.getElementById(inputId);
                    return el && el.value.trim();
                });
                
                if (allFilled) {
                    // Delay sedikit untuk UX yang lebih baik
                    setTimeout(() => {
                        generateIsolirScript();
                    }, 500);
                }
            });
        }
    });
    
    // Handle access type change
    const accessTypeSelect = document.getElementById('accessType');
    if (accessTypeSelect) {
        accessTypeSelect.addEventListener('change', function() {
            const portField = document.getElementById('isolirPort');
            if (this.value === 'tunneling') {
                portField.placeholder = 'Kosongkan jika menggunakan tunneling';
                portField.value = '';
            } else {
                portField.placeholder = 'Masukkan port (contoh: 3000)';
            }
        });
    }
});
</script>

<!-- Modal untuk Preview Script -->
<div class="modal fade" id="scriptPreviewModal" tabindex="-1" aria-labelledby="scriptPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scriptPreviewModalLabel">
                    <i class="bi bi-code-square"></i> Preview Script Mikrotik
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small mb-3">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Cara menggunakan:</strong> 
                    1. Copy script di bawah ‚Üí 2. Paste di terminal Mikrotik ‚Üí 3. Jalankan script
                </div>
                <pre class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto; font-size: 12px; font-family: 'Courier New', monospace;"><code id="previewScriptContent"></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="copyPreviewScriptBtn">
                    <i class="bi bi-clipboard"></i> Copy Script
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Handler untuk copy script dari modal preview
$('#copyPreviewScriptBtn').on('click', function() {
    const script = $('#previewScriptContent').text();
    navigator.clipboard.writeText(script).then(function() {
        showNotification('success', 'Script tersalin ke clipboard!');
        $('#scriptPreviewModal').modal('hide');
    }).catch(function(err) {
        console.error('Error copying script:', err);
        showNotification('danger', 'Gagal menyalin script!');
    });
});

// Handler untuk preview script
$('#previewIsolationScript').on('click', function() {
    const script = $('#isolationScriptResult').val();
    if (!script) {
        showNotification('warning', 'Generate script terlebih dahulu');
        return;
    }
    
    $('#previewScriptContent').text(script);
    new bootstrap.Modal(document.getElementById('scriptPreviewModal')).show();
});

    // Functions untuk Script Generator Menu Isolir Mikrotik
    // Load routers list saat page load
    function loadIsolirRouters() {
        $.get('/api/dashboard/routers', function(data) {
            if (data.success && data.routers) {
                const select = document.getElementById('isolirRouterSelect');
                if (select) {
                    // Clear existing options (keep "Auto")
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    data.routers.forEach(router => {
                        const option = document.createElement('option');
                        option.value = router.id;
                        option.textContent = `${router.name} (${router.nas_ip})`;
                        select.appendChild(option);
                    });
                }
            }
        }).fail(function() {
            console.error('Failed to load routers');
        });
    }
    
    // Load routers saat page load
    loadIsolirRouters();
    
    // Define functions dalam scope yang benar (global untuk onclick)
    window.generateIsolirScript = async function() {
        const activeIp = document.getElementById('activeIp').value.trim();
        const isolirIp = document.getElementById('isolirIp').value.trim();
        const isolirDomain = document.getElementById('isolirDomain').value.trim();
        const isolirPath = document.getElementById('isolirPath').value.trim();
        const isolirPort = document.getElementById('isolirPort').value.trim();
        const accessType = document.getElementById('accessType').value;
        const tunnelingDstAddress = document.getElementById('tunnelingDstAddress') ? document.getElementById('tunnelingDstAddress').value.trim() : '';
        
        // Validasi input (untuk web proxy, isolirPath tidak wajib)
        if (!activeIp || !isolirIp || !isolirDomain) {
            showNotification('warning', 'Mohon lengkapi field yang wajib!');
            return;
        }
        
        // Validasi !Dst. Address untuk tunneling mode
        if (accessType === 'tunneling' && !tunnelingDstAddress) {
            showNotification('warning', 'Mohon isi !Dst. Address (IP Domain) untuk mode Tunneling!');
            return;
        }
        
        // Validasi format IP untuk activeIp dan isolirIp
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
        if (!ipRegex.test(activeIp) || !ipRegex.test(isolirIp)) {
            showNotification('warning', 'Format IP tidak valid untuk IP Aktif atau IP Isolir!');
            return;
        }
        
        // Validasi format IP untuk tunnelingDstAddress jika diisi
        if (accessType === 'tunneling' && tunnelingDstAddress && !ipRegex.test(tunnelingDstAddress)) {
            showNotification('warning', 'Format IP tidak valid untuk !Dst. Address!');
            return;
        }
        
        // Parse IP aplikasi dari Domain/IP Aplikasi
        // PENTING: Untuk mode tunneling, isolirDomain HANYA digunakan untuk web proxy access redirect-to
        // Untuk !Dst. Address di firewall/NAT, gunakan tunnelingDstAddress (kolom terpisah)
        let appIp = isolirDomain;
        let resolvedIp = null;
        const isIp = ipRegex.test(isolirDomain);
        
        // Untuk mode tunneling, SKIP DNS resolve karena isolirDomain hanya untuk web proxy access
        // isolirDomain bisa domain atau IP, dan akan digunakan langsung di web proxy redirect-to
        if (accessType !== 'tunneling') {
            // Hanya resolve DNS jika BUKAN mode tunneling
            // Jika domain, coba resolve ke IP
            if (!isIp) {
                try {
                    showNotification('info', 'Meresolve domain ke IP...', 2000);
                    const response = await fetch(`/api/resolve-dns?domain=${encodeURIComponent(isolirDomain)}`);
                    const data = await response.json();
                    if (data.success && data.ip) {
                        resolvedIp = data.ip;
                        appIp = resolvedIp;
                        showNotification('success', `Domain ${isolirDomain} di-resolve ke IP: ${resolvedIp}`, 3000);
                    } else {
                        showNotification('warning', `Gagal resolve domain ${isolirDomain}. Menggunakan pendekatan web proxy saja.`, 4000);
                    }
                } catch (error) {
                    console.warn('DNS resolve error:', error);
                    showNotification('warning', `Gagal resolve domain ${isolirDomain}. Menggunakan pendekatan web proxy saja.`, 4000);
                }
            }
        } else {
            // Mode tunneling: isolirDomain hanya untuk web proxy access, tidak perlu resolve
            // tunnelingDstAddress akan digunakan untuk !Dst. Address
        }
        
        // Parse IP range isolir (dari isolirIp, bisa single IP atau range)
        // Jika single IP seperti 172.30.0.0, ubah menjadi range 172.30.0.0/16
        // Atau jika sudah range, gunakan langsung
        let isolirRange = isolirIp;
        let isolirRangeForPPPoE = isolirIp; // Untuk PPPoE profile (harus IP range, bukan CIDR)
        let isolirLocalAddress = isolirIp; // Untuk local-address (harus single IP, bukan CIDR atau range)
        
        if (isolirIp && !isolirIp.includes('/') && !isolirIp.includes('-')) {
            // Single IP - convert ke /16 CIDR untuk firewall
            const ipParts = isolirIp.split('.');
            if (ipParts.length === 4) {
                isolirRange = ipParts[0] + '.' + ipParts[1] + '.0.0/16';
                // Untuk PPPoE profile, convert ke IP range format (bukan CIDR)
                isolirRangeForPPPoE = ipParts[0] + '.' + ipParts[1] + '.0.0-' + ipParts[0] + '.' + ipParts[1] + '.255.255';
                // Local address tetap single IP (biasanya IP gateway, misal .1)
                isolirLocalAddress = ipParts[0] + '.' + ipParts[1] + '.0.1'; // Default ke .0.1 sebagai gateway
            }
        } else if (isolirIp && isolirIp.includes('/')) {
            // CIDR notation - convert ke IP range untuk PPPoE profile
            isolirRange = isolirIp; // Tetap gunakan CIDR untuk firewall
            // Convert CIDR ke IP range
            const cidrMatch = isolirIp.match(/^(\d+\.\d+\.\d+\.\d+)\/(\d+)$/);
            if (cidrMatch) {
                const baseIp = cidrMatch[1];
                const prefixLength = parseInt(cidrMatch[2]);
                const ipParts = baseIp.split('.').map(Number);
                
                // Calculate network and broadcast addresses
                let hostBits = 32 - prefixLength;
                let networkNum = (ipParts[0] << 24) + (ipParts[1] << 16) + (ipParts[2] << 8) + ipParts[3];
                let mask = (0xFFFFFFFF << hostBits) >>> 0;
                let network = networkNum & mask;
                let broadcast = network | (~mask >>> 0);
                
                // Convert back to IP addresses
                let startIp = [
                    (network >>> 24) & 0xFF,
                    (network >>> 16) & 0xFF,
                    (network >>> 8) & 0xFF,
                    network & 0xFF
                ].join('.');
                
                let endIp = [
                    (broadcast >>> 24) & 0xFF,
                    (broadcast >>> 16) & 0xFF,
                    (broadcast >>> 8) & 0xFF,
                    broadcast & 0xFF
                ].join('.');
                
                isolirRangeForPPPoE = startIp + '-' + endIp;
                // Local address = network address + 1 (biasanya gateway)
                let localIpParts = startIp.split('.').map(Number);
                localIpParts[3] = localIpParts[3] + 1; // Tambah 1 untuk gateway
                isolirLocalAddress = localIpParts.join('.');
            } else {
                // Fallback: jika parsing gagal, gunakan format sederhana
                const ipParts = isolirIp.split('.');
                if (ipParts.length === 4) {
                    isolirRangeForPPPoE = ipParts[0] + '.' + ipParts[1] + '.0.0-' + ipParts[0] + '.' + ipParts[1] + '.255.255';
                    isolirLocalAddress = ipParts[0] + '.' + ipParts[1] + '.0.1'; // Default ke .0.1
                }
            }
        } else if (isolirIp && isolirIp.includes('-')) {
            // Sudah IP range format
            isolirRangeForPPPoE = isolirIp;
            // Convert ke CIDR untuk firewall (gunakan /16 sebagai default)
            const ipParts = isolirIp.split('-')[0].split('.');
            if (ipParts.length === 4) {
                isolirRange = ipParts[0] + '.' + ipParts[1] + '.0.0/16';
                // Local address = IP pertama dari range + 1 (biasanya gateway)
                let localIpParts = ipParts.map(Number);
                localIpParts[3] = localIpParts[3] + 1; // Tambah 1 untuk gateway
                isolirLocalAddress = localIpParts.join('.');
            }
        }
        
        // Untuk firewall filter dan NAT rules:
        // - Mode tunneling: gunakan tunnelingDstAddress untuk !Dst. Address (bukan isolirDomain)
        // - Mode port langsung: gunakan appIp (hasil resolve isolirDomain jika domain)
        let appIpForFirewall = appIp;
        let useFirewallFilter = true;
        const isResolvedIp = ipRegex.test(appIp); // Cek apakah appIp sekarang adalah IP (setelah resolve)
        
        // PENTING: Untuk mode tunneling, JANGAN gunakan isolirDomain untuk firewall/NAT
        // isolirDomain hanya untuk web proxy access redirect-to
        // tunnelingDstAddress digunakan untuk !Dst. Address di firewall dan NAT
        if (accessType === 'tunneling') {
            // Mode tunneling: appIpForFirewall tidak digunakan karena kita pakai tunnelingDstAddress
            // Tapi tetap set untuk fallback jika tunnelingDstAddress kosong (seharusnya tidak terjadi karena sudah divalidasi)
            appIpForFirewall = tunnelingDstAddress || '0.0.0.0/0';
        } else {
            // Mode port langsung: gunakan appIp (hasil resolve isolirDomain jika domain)
            if (!isResolvedIp && !isIp) {
                // Domain tidak bisa di-resolve - gunakan 0.0.0.0/0 untuk block semua
                // Web proxy akan handle routing berdasarkan domain
                appIpForFirewall = '0.0.0.0/0'; // Block all, web proxy akan handle routing
            } else {
                // IP berhasil di-resolve atau sudah IP dari awal
                appIpForFirewall = appIp;
            }
        }
        
        // Generate script Mikrotik dengan metode Web Proxy
        const script = [
            '# Script Menu Isolir Mikrotik - Web Proxy Method',
            '# Generated on: ' + new Date().toLocaleString('id-ID'),
            '# IP PPPoE Aktif: ' + activeIp,
            '# IP Range Isolir: ' + isolirRange,
            '# IP/Domain Aplikasi: ' + isolirDomain,
            '# Port Aplikasi: ' + (isolirPort || '8080'),
            ...(accessType === 'tunneling' && tunnelingDstAddress ? ['# !Dst. Address (IP Domain): ' + tunnelingDstAddress] : []),
            '',
            '# ===========================================',
            '# 1. SETUP WEB PROXY - Enable dan Konfigurasi',
            '# ===========================================',
            '',
            '# Enable web proxy',
            '/ip proxy set enabled=yes port=8080',
            '',
            '# Set Web Proxy Role untuk isolir',
            '# Src Address: sama dengan src address Firewall (isolirRange)',
            '# Dst. Host: kosong',
            '# Action: deny',
            '# Direct to: Domain/IP Aplikasi + Path Halaman Isolir',
            '# PENTING: isolirDomain hanya digunakan untuk web proxy access redirect-to (bisa domain atau IP)',
            '# Untuk !Dst. Address di firewall/NAT, gunakan tunnelingDstAddress (kolom terpisah)',
            '/ip proxy access add src-address=' + isolirRange + ' action=deny redirect-to="' + isolirDomain + (isolirPath || '/isolir') + '"',
            '',
            '# ===========================================',
            '# 2. SETUP FIREWALL FILTER - Block semua kecuali aplikasi',
            '# ===========================================',
            '',
            '# Block semua TCP traffic kecuali ke IP aplikasi (web proxy akan handle routing)',
            ...(accessType === 'tunneling' && tunnelingDstAddress ? 
                ['# Block semua TCP traffic kecuali ke IP domain (tunneling mode)',
                '# PENTING: Menggunakan tunnelingDstAddress untuk !Dst. Address, BUKAN isolirDomain',
                '# isolirDomain hanya untuk web proxy access redirect-to',
                '/ip firewall filter add action=drop chain=forward comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=!' + tunnelingDstAddress + '/29 protocol=tcp src-address=' + isolirRange] :
            (appIpForFirewall && appIpForFirewall !== '0.0.0.0/0' ? 
                ['/ip firewall filter add action=drop chain=forward comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=!' + appIpForFirewall + '/29 protocol=tcp src-address=' + isolirRange] :
                ['# Block semua TCP traffic (domain tidak di-resolve, web proxy akan handle routing berdasarkan domain)',
                '/ip firewall filter add action=drop chain=forward comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=0.0.0.0/0 protocol=tcp src-address=' + isolirRange])),
            '',
            '# Block semua UDP traffic kecuali DNS',
            ...(accessType === 'tunneling' && tunnelingDstAddress ?
                ['# Block semua UDP traffic kecuali DNS dan IP domain (tunneling mode)',
                '# PENTING: Menggunakan tunnelingDstAddress untuk !Dst. Address, BUKAN isolirDomain',
                '# isolirDomain hanya untuk web proxy access redirect-to',
                '/ip firewall filter add action=drop chain=forward comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=!' + tunnelingDstAddress + '/29 dst-port=!53,5353 protocol=udp src-address=' + isolirRange] :
            (appIpForFirewall && appIpForFirewall !== '0.0.0.0/0' ?
                ['/ip firewall filter add action=drop chain=forward comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=!' + appIpForFirewall + ' dst-port=!53,5353 protocol=udp src-address=' + isolirRange] :
                ['# Block semua UDP traffic kecuali DNS (domain tidak di-resolve, web proxy akan handle routing berdasarkan domain)',
                '/ip firewall filter add action=drop chain=forward comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=0.0.0.0/0 dst-port=!53,5353 protocol=udp src-address=' + isolirRange])),
            '',
            '# ===========================================',
            '# 3. SETUP NAT RULES - Redirect HTTP/HTTPS ke Web Proxy',
            '# ===========================================',
            '',
            '# Redirect HTTP/HTTPS ke Web Proxy (port 8080)',
            ...(accessType === 'tunneling' && tunnelingDstAddress ?
                ['# Redirect HTTP/HTTPS ke Web Proxy kecuali ke IP domain (tunneling mode)',
                '# PENTING: Menggunakan tunnelingDstAddress untuk !Dst. Address, BUKAN isolirDomain',
                '# isolirDomain hanya untuk web proxy access redirect-to',
                '/ip firewall nat add action=redirect chain=dstnat comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=!' + tunnelingDstAddress + '/29 dst-port=80,443 protocol=tcp src-address=' + isolirRange + ' to-ports=8080'] :
            (appIpForFirewall && appIpForFirewall !== '0.0.0.0/0' ?
                ['/ip firewall nat add action=redirect chain=dstnat comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=!' + appIpForFirewall + '/29 dst-port=80,443 protocol=tcp src-address=' + isolirRange + ' to-ports=8080'] :
                ['# Redirect semua HTTP/HTTPS ke Web Proxy (domain tidak di-resolve, web proxy akan handle routing berdasarkan domain)',
                '/ip firewall nat add action=redirect chain=dstnat comment="Generate BILLING - Isolir WebProxy" \\',
                '    dst-address=0.0.0.0/0 dst-port=80,443 protocol=tcp src-address=' + isolirRange + ' to-ports=8080'])),
            '',
            '# ===========================================',
            '# 4. SETUP IP POOL UNTUK ISOLIR',
            '# ===========================================',
            '',
            '# Buat IP pool untuk isolir (remote-address harus menggunakan pool name)',
            '/ip pool add name="isolir-pool" ranges=' + isolirRangeForPPPoE + ' comment="Pool untuk pelanggan yang diisolir"',
            '',
            '# ===========================================',
            '# 5. SETUP PPP PROFILE ISOLIR',
            '# ===========================================',
            '',
            '# Buat profile isolir jika belum ada',
            '# Catatan: local-address harus single IP, remote-address harus pool name (bukan IP range langsung)',
            '/ppp profile add name="isolir" local-address=' + isolirLocalAddress + ' remote-address=isolir-pool \\',
            '    rate-limit="0/0" comment="Profile untuk pelanggan yang diisolir"',
            '',
            '# ===========================================',
            '# 6. SETUP ADDRESS LIST - Untuk kemudahan management',
            '# ===========================================',
            '',
            '# Tambahkan IP range isolir ke address list',
            '/ip firewall address-list add address=' + isolirRange + ' list="isolir-users" comment="PPPoE Isolir Users"',
            '',
            '# ===========================================',
            '# 7. SCRIPT MANAGEMENT - Isolir & Restore',
            '# ===========================================',
            '',
            '# Script untuk isolir pelanggan',
            '# Gunakan script ini untuk mengisolir pelanggan:',
            '# :local username "nama_pelanggan"',
            '# /ppp secret set [find name=$username] profile=isolir',
            '# :log info "Pelanggan $username telah diisolir"',
            '',
            '# Script untuk restore pelanggan',
            '# Gunakan script ini untuk restore pelanggan:',
            '# :local username "nama_pelanggan"',
            '# /ppp secret set [find name=$username] profile=default',
            '# :log info "Pelanggan $username telah direstore"',
            '',
            '# ===========================================',
            '# 8. VERIFIKASI KONFIGURASI',
            '# ===========================================',
            '',
            ':put "=== KONFIGURASI ISOLIR WEB PROXY SELESAI ==="',
            ':put "IP Range Isolir: ' + isolirRange + '"',
            ':put "IP/Domain Aplikasi: ' + isolirDomain + '"',
            ':put "Web Proxy Port: 8080"',
            ':put ""',
            ':put "=== CARA KERJA ==="',
            ':put "1. User PPPoE terisolir mendapat IP dari range: ' + isolirRange + '"',
            ':put "2. Web Proxy diaktifkan di port 8080"',
            ':put "3. HTTP/HTTPS traffic di-redirect ke Web Proxy"',
            ':put "4. Web Proxy Access di-set ke: ' + isolirDomain + '"',
            ':put "5. Traffic lainnya di-block kecuali ke IP aplikasi"',
            ':put ""',
            ':put "=== SELESAI ==="',
            '',
            'echo "Script menu isolir Mikrotik (Web Proxy Method) telah dibuat!"',
            'echo "Pastikan Web Proxy dapat diakses dari IP range: ' + isolirRange + '"',
            'echo "Web Proxy Access: ' + isolirDomain + '"'
        ];
        
        const finalScript = script.join('\n');

        // Tampilkan script
        document.getElementById('isolirScript').textContent = finalScript;
        document.getElementById('isolirScriptCard').style.display = 'block';
        
        // Auto-execute jika checkbox dicentang
        const autoExecute = document.getElementById('autoExecuteIsolir').checked;
        if (autoExecute) {
            window.executeIsolirScript(finalScript);
        } else {
            showNotification('success', 'Script berhasil di-generate!');
        }
    };
    
    // Execute script ke Mikrotik
    window.executeIsolirScript = function(script) {
        const routerId = document.getElementById('isolirRouterSelect').value;
        const rosVersion = document.getElementById('rosVersion').value;
        const statusDiv = document.getElementById('isolirExecuteStatus');
        
        // Show loading status
        statusDiv.className = 'alert alert-info mb-3';
        statusDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> <strong>Menjalankan script ke Mikrotik...</strong>';
        statusDiv.classList.remove('d-none');
        
        const executeData = {
            script: script,
            router_id: routerId === 'auto' ? null : parseInt(routerId),
            ros_version: rosVersion === 'auto' ? null : rosVersion
        };
        
        $.post('/admin/settings/execute-isolir-script', executeData, function(response) {
            if (response.success) {
                statusDiv.className = 'alert alert-success mb-3';
                statusDiv.innerHTML = '<i class="bi bi-check-circle"></i> <strong>Script berhasil dijalankan ke Mikrotik!</strong><br>' + 
                    '<small>Router: ' + (response.router_name || 'Auto') + '</small><br>' +
                    '<small>ROS Version: ' + (response.ros_version || 'Auto-detect') + '</small><br>' +
                    '<small>Total commands: ' + (response.commands_executed || 0) + '</small>';
                showNotification('success', 'Script berhasil dijalankan ke Mikrotik!');
            } else {
                statusDiv.className = 'alert alert-danger mb-3';
                statusDiv.innerHTML = '<i class="bi bi-x-circle"></i> <strong>Gagal menjalankan script:</strong><br>' + 
                    '<small>' + (response.message || 'Unknown error') + '</small>';
                showNotification('danger', 'Gagal menjalankan script: ' + (response.message || 'Unknown error'));
            }
        }).fail(function(xhr) {
            const errorMsg = xhr.responseJSON?.message || 'Gagal menjalankan script ke Mikrotik';
            statusDiv.className = 'alert alert-danger mb-3';
            statusDiv.innerHTML = '<i class="bi bi-x-circle"></i> <strong>Error:</strong><br><small>' + errorMsg + '</small>';
            showNotification('danger', errorMsg);
        });
    };
    
    // Generate script lokal (tanpa execute)
    window.generateLocalIsolirScript = function() {
        // Panggil generateIsolirScript tapi uncheck auto-execute
        const autoExecuteCheckbox = document.getElementById('autoExecuteIsolir');
        const wasChecked = autoExecuteCheckbox.checked;
        autoExecuteCheckbox.checked = false;
        window.generateIsolirScript();
        autoExecuteCheckbox.checked = wasChecked;
    };
    
    // Copy script ke clipboard
    window.copyIsolirScript = function() {
        const scriptElement = document.getElementById('isolirScript');
        if (!scriptElement || !scriptElement.textContent) {
            showNotification('warning', 'Tidak ada script untuk di-copy. Silakan generate script terlebih dahulu.');
            return;
        }
        
        // Copy ke clipboard menggunakan modern API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(scriptElement.textContent).then(function() {
                showNotification('success', 'Script berhasil di-copy ke clipboard!');
            }).catch(function(err) {
                // Fallback untuk browser lama
                scriptElement.select();
                scriptElement.setSelectionRange(0, 99999);
                document.execCommand('copy');
                showNotification('success', 'Script berhasil di-copy ke clipboard!');
            });
        } else {
            // Fallback untuk browser lama
            scriptElement.select();
            scriptElement.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showNotification('success', 'Script berhasil di-copy ke clipboard!');
        }
    };
    
    // Toggle tunneling fields berdasarkan accessType
    $(document).ready(function() {
        const accessTypeSelect = document.getElementById('accessType');
        const tunnelingDstAddressRow = document.getElementById('tunnelingDstAddressRow');
        
        function toggleTunnelingFields() {
            if (accessTypeSelect.value === 'tunneling') {
                // Tampilkan kolom !Dst. Address
                if (tunnelingDstAddressRow) {
                    tunnelingDstAddressRow.style.display = 'block';
                }
                const portField = document.getElementById('isolirPort');
                if (portField) {
                    portField.placeholder = 'Kosongkan jika menggunakan tunneling';
                    portField.value = '';
                }
            } else {
                // Sembunyikan kolom !Dst. Address
                if (tunnelingDstAddressRow) {
                    tunnelingDstAddressRow.style.display = 'none';
                }
                const portField = document.getElementById('isolirPort');
                if (portField) {
                    portField.placeholder = '3003';
                }
            }
        }
        
        if (accessTypeSelect) {
            // Set initial state
            toggleTunnelingFields();
            // Listen for changes
            accessTypeSelect.addEventListener('change', toggleTunnelingFields);
        }
    });

</script>

<!-- Extra spacer untuk memastikan konten tidak tertutup -->
<div style="height: 200px; width: 100%; clear: both;"></div>

</body>
</html>
